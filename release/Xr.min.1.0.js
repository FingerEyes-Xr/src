/* Copyright GEOSERVICE - LGPL */ function createMatrixPackage(){function _chkNum(a){return abs(a)<EPS?0:a}function _chkMatrix(a,b,c){if(!c.isMatrix)throw"***ERROR: Argument "+b+" of Matrix."+a+' is not a Matrix; its value is "'+c+'".'}function _createMatrixfromArray(a){for(var b=a.length,c=0;b>c;c++){if(!(a[c]instanceof Array))throw"***ERROR: in Matrix.create: argument 1 is not a 2D array.";if(a[c].length!=a[0].length)throw"***ERROR: in Matrix.create: argument 1 has different length rows."}for(var d=a[0].length,e=new Array(b),c=0;b>c;c++){e[c]=new Array(d);for(var f=0;d>f;f++)e[c][f]=_chkNum(a[c][f])}var g=new Object;return g.m=b,g.n=d,g.mat=e,g.isMatrix=!0,g}function _createMatrixfromDimensions(a,b){for(var c=new Array(a),d=0;a>d;d++)c[d]=new Array(b);var e=new Object;return e.m=a,e.n=b,e.mat=c,e.isMatrix=!0,e}this.version=version;var abs=Math.abs,EPS=Math.pow(2,-40);this.getEPS=function(){return EPS},this.setEPS=function(a){EPS=a},this.create=function(a,b){var c=a instanceof Array;if(!c&&"number"!=typeof a)throw"***ERROR: in Matrix.create: argument 1 is not an array or a number.";if(c&&null!=b)throw"***ERROR: in Matrix.create: argument 1 is an array but argument 2 is also present.";return c?_createMatrixfromArray(a):_createMatrixfromDimensions(a,b)},this.identity=function(m,n){var res=_createMatrixfromDimensions(m,n);with(res){for(var i=0;m>i;i++)for(var j=0;n>j;j++)mat[i][j]=0;for(var i=0;i<Math.min(m,n);i++)mat[i][i]=1}return res},this.unit=function(m,n){var res=_createMatrixfromDimensions(m,n);with(res)for(var i=0;m>i;i++)for(var j=0;n>j;j++)mat[i][j]=1;return res},this.random=function(m,n){var res=_createMatrixfromDimensions(m,n);with(res)for(var i=0;m>i;i++)for(var j=0;n>j;j++)mat[i][j]=_chkNum(Math.random());return res},this.copy=function(mo,fromRow,fromCol,m,n){_chkMatrix("copy",1,mo);var res=_createMatrixfromDimensions(m,n);with(res)for(var i=0;m>i;i++)for(var j=0;n>j;j++)mat[i][j]=mo.mat[i+fromRow][j+fromCol];return res},this.transpose=function(mo){_chkMatrix("transpose",1,mo);var res=_createMatrixfromDimensions(mo.n,mo.m);with(res)for(var i=0;i<m;i++)for(var j=0;j<n;j++)mat[i][j]=mo.mat[j][i];return res},this.diagOf=function(mo){_chkMatrix("diagOf",1,mo);var res=_createMatrixfromDimensions(Math.min(mo.m,mo.n),1);with(res)for(var i=0;i<m;i++)mat[i][0]=mo.mat[i][i];return res},this.diag=function(mo){if(_chkMatrix("diag",1,mo),1!=mo.n)throw"***ERROR: in Matrix.diag: argument 1 is not a column vector.";var res=Matrix.identity(mo.m,mo.m);with(res)for(var i=0;i<m;i++)mat[i][i]=mo.mat[i][0];return res},this.max=function(mo){with(_chkMatrix("max",1,mo),mo)for(var res=mat[0][0],i=0;i<m;i++)for(var j=0;j<n;j++)mat[i][j]>res&&(res=mat[i][j]);return _chkNum(res)},this.min=function(mo){with(_chkMatrix("min",1,mo),mo)for(var res=mat[0][0],i=0;i<m;i++)for(var j=0;j<n;j++)mat[i][j]<res&&(res=mat[i][j]);return _chkNum(res)},this.scale=function(mo,scalar){_chkMatrix("scale",1,mo);var res=_createMatrixfromArray(mo.mat);with(res)for(var i=0;i<m;i++)for(var j=0;j<n;j++)mat[i][j]=_chkNum(scalar*mat[i][j]);return res},this.add=function(mo1,mo2){if(_chkMatrix("add",1,mo1),_chkMatrix("add",2,mo2),mo1.m!=mo2.m||mo1.n!=mo2.n)throw"***ERROR: in Matrix.add: matrix dimensions don't match.";var res=_createMatrixfromDimensions(mo1.m,mo1.n);with(res)for(var i=0;i<m;i++)for(var j=0;j<n;j++)mat[i][j]=_chkNum(mo1.mat[i][j]+mo2.mat[i][j]);return res},this.sub=function(mo1,mo2){if(_chkMatrix("sub",1,mo1),_chkMatrix("sub",2,mo2),mo1.m!=mo2.m||mo1.n!=mo2.n)throw"***ERROR: in Matrix.sub: matrix dimensions don't match.";var res=_createMatrixfromDimensions(mo1.m,mo1.n);with(res)for(var i=0;i<m;i++)for(var j=0;j<n;j++)mat[i][j]=_chkNum(mo1.mat[i][j]-mo2.mat[i][j]);return res},this.mult=function(mo1,mo2){if(_chkMatrix("mult",1,mo1),_chkMatrix("mult",2,mo2),mo1.n!=mo2.m)throw"***ERROR: in Matrix.mult: matrix dimensions don't match.";var temp,res=_createMatrixfromDimensions(mo1.m,mo2.n);with(res)for(var i=0;i<m;i++)for(var j=0;j<n;j++){temp=0;for(var k=0;k<mo1.n;k++)temp+=mo1.mat[i][k]*mo2.mat[k][j];mat[i][j]=_chkNum(temp)}return res},this.map=function(f,mo){_chkMatrix("map",2,mo);var res=_createMatrixfromDimensions(mo.m,mo.n);with(res)for(var i=0;i<m;i++)for(var j=0;j<n;j++)mat[i][j]=_chkNum(f(mo.mat[i][j]));return res},this.combine=function(f,mo1,mo2){if(_chkMatrix("combine",1,mo1),_chkMatrix("combine",2,mo2),mo1.m!=mo2.m||mo1.n!=mo2.n)throw"***ERROR: in Matrix.combine: matrix dimensions don't match.";var res=_createMatrixfromDimensions(mo1.m,mo1.n);with(res)for(var i=0;i<m;i++)for(var j=0;j<n;j++)mat[i][j]=_chkNum(f(mo1.mat[i][j],mo2.mat[i][j]));return res},this.trace=function(mo){_chkMatrix("trace",1,mo);var t=0;with(mo)for(var i=0;i<Math.min(m,n);i++)t+=mat[i][i];return _chkNum(t)},this.det=function(mo){if(_chkMatrix("det",1,mo),mo.m!=mo.n)throw"***ERROR: in Matrix.det: argument is not square.";with(LUDecomposition)return _chkNum(det(create(mo)))},this.inverse=function(a){return _chkMatrix("inverse",1,a),Matrix.solve(a,Matrix.identity(a.m,a.m))},this.solve=function(A,B){if(_chkMatrix("solve",1,A),_chkMatrix("solve",2,B),A.m==A.n)with(LUDecomposition)return solve(create(A),B);else{if(!(A.m>A.n))throw"***ERROR: in Matrix.solve: argument 1 has fewer rows than columns.";with(QRDecomposition){var temp=create(A);return solve(temp,B)}}},this.eigenstructure=function(a){if(_chkMatrix("eigenstructure",1,a),a.m!=a.n)throw"***ERROR: in Matrix.eigenstructure: argument is not a square matrix.";return EVDecomposition.create(a)},this.display=function(a,b){_chkMatrix("display",1,a),null==b&&(b=3),displayMat(a.mat,null,null,b)}}function startOutput(a,b){_outputObj=a,_outputBuffer="",_outputObj.innerHTML=b}function endOutput(){_outputObj.innerHTML=_outputBuffer,_outputBuffer=""}function write(a){_outputBuffer+=LFT+a+RGT}function writeln(a){_outputBuffer+=LFT+a+RGT+"<br />"}function nl(){_outputBuffer+="<br />"}function startTable(){_outputBuffer+='<table border="1"><tr>',_rowStarted=!0}function endTable(){_rowStarted&&(_outputBuffer+="</tr>",_rowStarted=!1),_outputBuffer+="</table>"}function newRow(){_outputBuffer+="</tr>",_rowStarted=!1}function writeCell(a){_rowStarted||(_outputBuffer+="<tr>",_rowStarted=!0),_outputBuffer+='<td style="text-align: right;">'+LFT+a+RGT+"</td>"}function displayMat(a,b,c,d){if(startTable(),null!=b){writeCell("");for(var e=0;e<b.length;e++)writeCell(b[e]);newRow()}null==d&&(d=3);for(var f=0;f<a.length;f++){null!=c&&writeCell(c[f]);for(var e=0;e<a[f].length;e++)writeCell(a[f][e].toFixed(d));newRow()}endTable()}function displayAT(a){a instanceof Array?2==a.length?(write("("),displayAT(a[0]),write(", "),displayAT(a[1]),write(")")):alert("***ERROR: displayAT given an array of length "+a.length):write(a)}function createEVDecompositionPackage(){function a(a,b){var c,d=o(a),e=o(b);return d>e?(c=b/a,c=d*p(1+c*c)):0!=b?(c=a/b,c=e*p(1+c*c)):c=0,c}function b(){for(var a=0;h>a;a++)j[a]=l[h-1][a];for(var b=h-1;b>0;b--){for(var c=0,d=0,e=0;b>e;e++)c+=o(j[e]);if(0==c){k[b]=j[b-1];for(var a=0;b>a;a++)j[a]=l[b-1][a],l[b][a]=0,l[a][b]=0}else{for(var e=0;b>e;e++)j[e]/=c,d+=j[e]*j[e];var f=j[b-1],g=p(d);f>0&&(g=-g),k[b]=c*g,d-=f*g,j[b-1]=f-g;for(var a=0;b>a;a++)k[a]=0;for(var a=0;b>a;a++){f=j[a],l[a][b]=f,g=k[a]+l[a][a]*f;for(var e=a+1;b-1>=e;e++)g+=l[e][a]*j[e],k[e]+=l[e][a]*f;k[a]=g}f=0;for(var a=0;b>a;a++)k[a]/=d,f+=k[a]*j[a];for(var i=f/(d+d),a=0;b>a;a++)k[a]-=i*j[a];for(var a=0;b>a;a++){f=j[a],g=k[a];for(var e=a;b-1>=e;e++)l[e][a]-=f*k[e]+g*j[e];j[a]=l[b-1][a],l[b][a]=0}}j[b]=d}for(var b=0;h-1>b;b++){l[h-1][b]=l[b][b],l[b][b]=1;var d=j[b+1];if(0!=d){for(var e=0;b>=e;e++)j[e]=l[e][b+1]/d;for(var a=0;b>=a;a++){for(var g=0,e=0;b>=e;e++)g+=l[e][b+1]*l[e][a];for(var e=0;b>=e;e++)l[e][a]-=g*j[e]}}for(var e=0;b>=e;e++)l[e][b+1]=0}for(var a=0;h>a;a++)j[a]=l[h-1][a],l[h-1][a]=0;l[h-1][h-1]=1,k[0]=0}function c(){for(var b=.5*Matrix.getEPS(),c=1;h>c;c++)k[c-1]=k[c];k[h-1]=0;for(var d=0,e=0,f=0;h>f;f++){e=q(e,o(j[f])+o(k[f]));for(var g=f;h>g&&!(o(k[g])<=b*e);)g++;if(g>f){var i=0;do{i+=1;var m=j[f],n=(j[f+1]-m)/(2*k[f]),p=a(n,1);0>n&&(p=-p),j[f]=k[f]/(n+p),j[f+1]=k[f]*(n+p);for(var r=j[f+1],s=m-j[f],c=f+2;h>c;c++)j[c]-=s;d+=s,n=j[g];for(var t=1,u=t,v=t,w=k[f+1],x=0,y=0,c=g-1;c>=f;c--){v=u,u=t,y=x,m=t*k[c],s=t*n,p=a(n,k[c]),k[c+1]=x*p,x=k[c]/p,t=n/p,n=t*j[c]-x*m,j[c+1]=s+x*(t*m+x*j[c]);for(var z=0;h>z;z++)s=l[z][c+1],l[z][c+1]=x*l[z][c]+t*s,l[z][c]=t*l[z][c]-x*s}n=-x*y*v*w*k[f]/r,k[f]=x*n,j[f]=t*n}while(o(k[f])>b*e)}j[f]=j[f]+d,k[f]=0}for(var c=0;h-1>c;c++){for(var z=c,n=j[c],A=c+1;h>A;A++)j[A]<n&&(z=A,n=j[A]);if(z!=c){j[z]=j[c],j[c]=n;for(var A=0;h>A;A++)n=l[A][c],l[A][c]=l[A][z],l[A][z]=n}}}function d(){for(var a=0,b=h-1,c=a+1;b-1>=c;c++){for(var d=0,e=c;b>=e;e++)d+=o(m[e][c-1]);if(0!=d){for(var f=0,e=b;e>=c;e--)n[e]=m[e][c-1]/d,f+=n[e]*n[e];var g=p(f);n[c]>0&&(g=-g),f-=n[c]*g,n[c]=n[c]-g;for(var i=c;h>i;i++){for(var j=0,e=b;e>=c;e--)j+=n[e]*m[e][i];j/=f;for(var e=c;b>=e;e++)m[e][i]-=j*n[e]}for(var e=0;b>=e;e++){for(var j=0,i=b;i>=c;i--)j+=n[i]*m[e][i];j/=f;for(var i=c;b>=i;i++)m[e][i]-=j*n[i]}n[c]=d*n[c],m[c][c-1]=d*g}}for(var e=0;h>e;e++)for(var i=0;h>i;i++)l[e][i]=e==i?1:0;for(var c=b-1;c>=a+1;c--)if(0!=m[c][c-1]){for(var e=c+1;b>=e;e++)n[e]=m[e][c-1];for(var i=c;b>=i;i++){for(var g=0,e=c;b>=e;e++)g+=n[e]*l[e][i];g=g/n[c]/m[c][c-1];for(var e=c;b>=e;e++)l[e][i]+=g*n[e]}}}function e(a,b,c,d){var e,f,g,h;return o(c)>o(d)?(g=d/c,h=c+g*d,e=(a+g*b)/h,f=(b-g*a)/h):(g=c/d,h=d+g*c,e=(g*a+b)/h,f=(g*b-a)/h),{r:e,i:f}}function f(){for(var a,b,c,d,f=.5*Matrix.getEPS(),g=h,i=g-1,n=0,s=g-1,t=0,u=0,v=0,w=0,x=0,y=0,z=0,A=0;g>A;A++){(n>A||A>s)&&(j[A]=m[A][A],k[A]=0);for(var B=q(A-1,0);g>B;B++)z+=o(m[A][B])}for(var C=0;i>=n;){for(var D=i;D>n&&(x=o(m[D-1][D-1])+o(m[D][D]),0==x&&(x=z),!(o(m[D][D-1])<f*x));)D--;if(D==i)m[i][i]=m[i][i]+t,j[i]=m[i][i],k[i]=0,i--,C=0;else if(D==i-1){if(b=m[i][i-1]*m[i-1][i],u=(m[i-1][i-1]-m[i][i])/2,v=u*u+b,y=p(o(v)),m[i][i]=m[i][i]+t,m[i-1][i-1]=m[i-1][i-1]+t,c=m[i][i],v>=0){y=u>=0?u+y:u-y,j[i-1]=c+y,j[i]=j[i-1],0!=y&&(j[i]=c-b/y),k[i-1]=0,k[i]=0,c=m[i][i-1],x=o(c)+o(y),u=c/x,v=y/x,w=p(u*u+v*v),u/=w,v/=w;for(var B=i-1;g>B;B++)y=m[i-1][B],m[i-1][B]=v*y+u*m[i][B],m[i][B]=v*m[i][B]-u*y;for(var A=0;i>=A;A++)y=m[A][i-1],m[A][i-1]=v*y+u*m[A][i],m[A][i]=v*m[A][i]-u*y;for(var A=n;s>=A;A++)y=l[A][i-1],l[A][i-1]=v*y+u*l[A][i],l[A][i]=v*l[A][i]-u*y}else j[i-1]=c+u,j[i]=c+u,k[i-1]=y,k[i]=-y;i-=2,C=0}else{if(c=m[i][i],d=0,b=0,i>D&&(d=m[i-1][i-1],b=m[i][i-1]*m[i-1][i]),10==C){t+=c;for(var A=n;i>=A;A++)m[A][A]-=c;x=o(m[i][i-1])+o(m[i-1][i-2]),c=d=.75*x,b=-.4375*x*x}if(30==C&&(x=(d-c)/2,x=x*x+b,x>0)){x=p(x),c>d&&(x=-x),x=c-b/((d-c)/2+x);for(var A=n;i>=A;A++)m[A][A]-=x;t+=x,c=d=b=.964}C+=1;for(var E=i-2;E>=D&&(y=m[E][E],w=c-y,x=d-y,u=(w*x-b)/m[E+1][E]+m[E][E+1],v=m[E+1][E+1]-y-w-x,w=m[E+2][E+1],x=o(u)+o(v)+o(w),u/=x,v/=x,w/=x,E!=D)&&!(o(m[E][E-1])*(o(v)+o(w))<f*o(u)*(o(m[E-1][E-1])+o(y)+o(m[E+1][E+1])));)E--;for(var A=E+2;i>=A;A++)m[A][A-2]=0,A>E+2&&(m[A][A-3]=0);for(var F=E;i-1>=F;F++){var G=F!=i-1;if(F!=E&&(u=m[F][F-1],v=m[F+1][F-1],w=G?m[F+2][F-1]:0,c=o(u)+o(v)+o(w),0!=c&&(u/=c,v/=c,w/=c)),0==c)break;if(x=p(u*u+v*v+w*w),0>u&&(x=-x),0!=x){F!=E?m[F][F-1]=-x*c:D!=E&&(m[F][F-1]=-m[F][F-1]),u+=x,c=u/x,d=v/x,y=w/x,v/=u,w/=u;for(var B=F;g>B;B++)u=m[F][B]+v*m[F+1][B],G&&(u+=w*m[F+2][B],m[F+2][B]=m[F+2][B]-u*y),m[F][B]=m[F][B]-u*c,m[F+1][B]=m[F+1][B]-u*d;for(var A=0;A<=r(i,F+3);A++)u=c*m[A][F]+d*m[A][F+1],G&&(u+=y*m[A][F+2],m[A][F+2]=m[A][F+2]-u*w),m[A][F]=m[A][F]-u,m[A][F+1]=m[A][F+1]-u*v;for(var A=n;s>=A;A++)u=c*l[A][F]+d*l[A][F+1],G&&(u+=y*l[A][F+2],l[A][F+2]=l[A][F+2]-u*w),l[A][F]=l[A][F]-u,l[A][F+1]=l[A][F+1]-u*v}}}}if(0!=z){for(i=g-1;i>=0;i--)if(u=j[i],v=k[i],0==v){var D=i;m[i][i]=1;for(var A=i-1;A>=0;A--){b=m[A][A]-u,w=0;for(var B=D;i>=B;B++)w+=m[A][B]*m[B][i];if(k[A]<0)y=b,x=w;else if(D=A,0==k[A]?m[A][i]=0!=b?-w/b:-w/(f*z):(c=m[A][A+1],d=m[A+1][A],v=(j[A]-u)*(j[A]-u)+k[A]*k[A],a=(c*x-y*w)/v,m[A][i]=a,m[A+1][i]=o(c)>o(y)?(-w-b*a)/c:(-x-d*a)/y),a=o(m[A][i]),f*a*a>1)for(var B=A;i>=B;B++)m[B][i]=m[B][i]/a}}else if(0>v){var D=i-1;if(o(m[i][i-1])>o(m[i-1][i]))m[i-1][i-1]=v/m[i][i-1],m[i-1][i]=-(m[i][i]-u)/m[i][i-1];else{var H=e(0,-m[i-1][i],m[i-1][i-1]-u,v);m[i-1][i-1]=H.r,m[i-1][i]=H.i}m[i][i-1]=0,m[i][i]=1;for(var A=i-2;A>=0;A--){var I,J,K,L;I=0,J=0;for(var B=D;i>=B;B++)I+=m[A][B]*m[B][i-1],J+=m[A][B]*m[B][i];if(b=m[A][A]-u,k[A]<0)y=b,w=I,x=J;else{if(D=A,0==k[A]){var H=e(-I,-J,b,v);m[A][i-1]=H.r,m[A][i]=H.i}else{c=m[A][A+1],d=m[A+1][A],K=(j[A]-u)*(j[A]-u)+k[A]*k[A]-v*v,L=2*(j[A]-u)*v,0==K&&0==L&&(K=f*z*(o(b)+o(v)+o(c)+o(d)+o(y)));var H=e(c*w-y*I+v*J,c*x-y*J-v*I,K,L);if(m[A][i-1]=H.r,m[A][i]=H.i,o(c)>o(y)+o(v))m[A+1][i-1]=(-I-b*m[A][i-1]+v*m[A][i])/c,m[A+1][i]=(-J-b*m[A][i]-v*m[A][i-1])/c;else{var H=e(-w-d*m[A][i-1],-x-d*m[A][i],y,v);m[A+1][i-1]=H.r,m[A+1][i]=H.i}}if(a=q(o(m[A][i-1]),o(m[A][i])),f*a*a>1)for(var B=A;i>=B;B++)m[B][i-1]=m[B][i-1]/a,m[B][i]=m[B][i]/a}}}for(var A=0;g>A;A++)if(n>A||A>s)for(var B=A;g>B;B++)l[A][B]=m[A][B];for(var B=g-1;B>=n;B--)for(var A=n;s>=A;A++){y=0;for(var F=n;F<=r(B,s);F++)y+=l[A][F]*m[F][B];l[A][B]=y}}}function g(){for(var a=Matrix.create(h,h),b=a.mat,c=0;h>c;c++){for(var d=0;h>d;d++)b[c][d]=0;b[c][c]=j[c],k[c]>0?b[c][c+1]=k[c]:k[c]<0&&(b[c][c-1]=k[c])}return a}this.version=version;var h,i,j,k,l,m,n,o=Math.abs,p=Math.sqrt,q=Math.max,r=Math.min;this.create=function(a){var e=a.mat;h=a.n,l=new Array(h);for(var p=0;h>p;p++)l[p]=new Array(h);j=new Array(h),k=new Array(h),i=!0;for(var q=0;h>q&&i;q++)for(var p=0;h>p&&i;p++)i=e[p][q]==e[q][p];if(i){for(var p=0;h>p;p++)for(var q=0;h>q;q++)l[p][q]=e[p][q];b(),c()}else{m=new Array(h);for(var p=0;h>p;p++)m[p]=new Array(h);n=new Array(h);for(var q=0;h>q;q++)for(var p=0;h>p;p++)m[p][q]=e[p][q];d(),f()}for(var r=Matrix.getEPS(),p=0;h>p;p++)o(j[p])<r&&(j[p]=0),o(k[p])<r&&(k[p]=0);for(var s=0,p=0;h-1>p;p++){for(var t=j[p],u=p,q=p+1;h>q;q++){var v=!1;if(0!=j[q])if(0==t)v=!0;else{var w=j[q]-t;w>r?v=!0:o(w)<r&&(v=k[q]>k[u])}v&&(t=j[q],u=q)}if(p!=u){var x=j[p];j[p]=j[u],j[u]=x,x=k[p],k[p]=k[u],k[u]=x;for(var q=0;h>q;q++)x=l[q][p],l[q][p]=l[q][u],l[q][u]=x}(0!=j[p]||0!=k[p])&&(s=p)}(0!=j[h-1]||0!=k[h-1])&&(s=h-1);var y=new Object;return y.V=Matrix.create(l),y.lr=j,y.li=k,y.L=g(),y.isSymmetric=i,y.isEVDecomposition=!0,y}}function createLUDecompositionPackage(){function _chkMatrix(a,b,c){if(!c.isMatrix)throw writeln("***ERROR: in LUDecomposition."+a+": argument "+b+" is not a Matrix."),null}function _chkLUDecomposition(a,b,c){if(!c.isLUDecomposition)throw writeln("***ERROR: in LUDecomposition."+a+": argument "+b+" is not an LUDecomposition."),null}function _arrange(mo,r){with(mo)for(var res=Matrix.create(m,n),i=0;i<m;i++)for(var j=0;j<n;j++)res.mat[i][j]=mat[r[i]][j];return res}this.version=version;var abs=Math.abs,min=Math.min;this.create=function(a){_chkMatrix("create",1,a);var b,c,d=Matrix.create(a.mat),e=d.mat;b=a.m,c=a.n;for(var f=new Array,g=0;b>g;g++)f[g]=g;for(var h,i=1,j=new Array(b),k=0;c>k;k++){for(var g=0;b>g;g++)j[g]=e[g][k];for(var g=0;b>g;g++){h=e[g];for(var l=min(g,k),m=0,n=0;l>n;n++)m+=h[n]*j[n];h[k]=j[g]-=m}for(var o=k,g=k+1;b>g;g++)abs(j[g])>abs(j[o])&&(o=g);if(o!=k){for(var n=0;c>n;n++){var p=e[o][n];e[o][n]=e[k][n],e[k][n]=p}var n=f[o];f[o]=f[k],f[k]=n,i=-i}if(b>k&&0!=e[k][k])for(var g=k+1;b>g;g++)e[g][k]/=e[k][k]}var q=new Object;return q.LU=e,q.m=b,q.n=c,q.pivsign=i,q.piv=f,q.isLUDecomposition=!0,q},this.restore=function(a,b){_chkMatrix("restore",1,a),_chkLUDecomposition("restore",2,b);for(var c=Matrix.create(a.m,a.n),d=b.piv,e=0;e<a.m;e++)for(var f=0;f<a.n;f++)c.mat[d[e]][f]=a.mat[e][f];return c},this.isNonsingular=function(lud){_chkLUDecomposition("isNonsingular",1,lud);var eps=Matrix.getEPS();with(lud)for(var j=0;j<n;j++)if(abs(LU[j][j])<eps)return!1;return!0},this.getL=function(lud){_chkLUDecomposition("getL",1,lud);var xm=lud.m,xn=lud.m>=lud.n?lud.n:lud.m,X=Matrix.create(xm,xn),L=X.mat;with(lud)for(var i=0;xm>i;i++)for(var j=0;xn>j;j++)L[i][j]=i>j?LU[i][j]:i==j?1:0;return X},this.getU=function(lud){_chkLUDecomposition("getU",1,lud);var xm=lud.m>=lud.n?lud.n:lud.m,xn=lud.n,X=Matrix.create(xm,xn),U=X.mat;with(lud)for(var i=0;xm>i;i++)for(var j=0;xn>j;j++)U[i][j]=j>=i?LU[i][j]:0;return X},this.det=function(lud){_chkLUDecomposition("det",1,lud);var eps=Matrix.getEPS();if(lud.m!=lud.n)throw writeln("***ERROR: in LUDecomposition.det: argument 1 is not square."),null;var d=lud.pivsign;with(lud)for(var j=0;j<n;j++){{LU[j][j]}if(d*=LU[j][j],abs(d)<eps)return 0}return d},this.solve=function(lud,bmat){if(_chkMatrix("solve",2,bmat),_chkLUDecomposition("solve",1,lud),bmat.m!=lud.m)throw writeln("***ERROR: in LUDecomposition.solve: matrix row dimensions do not agree."),null;if(!this.isNonsingular(lud))throw writeln("***ERROR: in LUDecomposition.solve: matrix is singular."),null;var nx=bmat.n,Xmat=_arrange(bmat,lud.piv),X=Xmat.mat;with(lud){for(var k=0;k<n;k++)for(var i=k+1;i<n;i++)for(var j=0;nx>j;j++)X[i][j]-=X[k][j]*LU[i][k];for(var k=n-1;k>=0;k--){for(var j=0;nx>j;j++)X[k][j]/=LU[k][k];for(var i=0;k>i;i++)for(var j=0;nx>j;j++)X[i][j]-=X[k][j]*LU[i][k]}}return Xmat}}!function(){for(var a,b,c=new RegExp("(^|(.*?\\/))(Xr.min.1.0.js)(\\?|$)"),d=document.getElementsByTagName("script"),e="",f=0,g=d.length;g>f;f++)if(a=d[f].getAttribute("src"),a&&(b=a.match(c))){e=b[1];break}document.write("<link rel='stylesheet' type='text/css' href='"+e+"Xr.1.0.css'>"),window.__XR_CLASS_LOADING_TIME__="XrClassLoadingTime",window.Xr={LICENSE:"LGPL",VERSION:"1.0",DEVELOPERS:[{name:"Kim Hyoung-Jun",nickName:"Dip2K",eMail:"hjkim@geoservice.co.kr",homepage:"www.gisdeveloper.co.kr"}],Class:function(a){var b=a.name,c=a.extend||Object,d=a.construct||function(){},e=a.methods||{},f=a.statics||{},g=a.requires||[],h=new c(__XR_CLASS_LOADING_TIME__);for(var i in h)h.hasOwnProperty(i)&&delete h[i];h.constructor=d,h.superclass=c,h.classname=b,d.prototype=h;for(var i in e)h[i]=e[i];for(var i in f)d[i]=f[i];for(var j=0;j<g.length;j++){var k=g[j];for(var i in k.prototype)"function"==typeof k.prototype[i]&&"constructor"!=i&&"superclass"!=i&&!(i in h&&"function"==typeof h[i]&&h[i].length==k.prototype[i].length)}return d}},window.Xr.rasterOperatorsPath=e+"rasterOperators/"}(),Xr.CommonStrings=Xr.Class({name:"CommonStrings",statics:{SVG_NAMESPACE:"http://www.w3.org/2000/svg"}}),Xr.MouseActionEnum=Xr.Class({name:"MouseAcionEnum",statics:{MOUSE_DOWN:0,MOUSE_DRAG:1,MOUSE_UP:2,NO_MOUSE:-1}}),Xr.PointD=Xr.Class({name:"PointD",construct:function(a,b){this.x=a,this.y=b},methods:{clone:function(){return new Xr.PointD(this.x,this.y)},set:function(a,b){this.x=a,this.y=b},equal:function(a){return this.x==a.x&&this.y==a.y},distanceFrom:function(a){return Math.sqrt((this.x-a.x)*(this.x-a.x)+(this.y-a.y)*(this.y-a.y))},add:function(a,b){this.x+=a,this.y+=b},toString:function(){return"("+this.x+", "+this.y+")"}}}),Xr.MBR=Xr.Class({name:"MBR",construct:function(a,b,c,d){4==arguments.length?(this.minX=a,this.minY=b,this.maxX=c,this.maxY=d):this.reset()},methods:{clone:function(){return new Xr.MBR(this.minX,this.minY,this.maxX,this.maxY)},same:function(a){return this.minX==a.minX&&this.minY==a.minY&&this.maxX==a.maxX&&this.maxY==a.maxY},reset:function(){this.set(Number.MAX_VALUE,Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)},toString:function(){return"("+this.minX+", "+this.minY+", "+this.maxX+", "+this.maxY+")"},width:function(){return this.maxX-this.minX},height:function(){return this.maxY-this.minY},set:function(a,b,c,d){this.minX=a,this.minY=b,this.maxX=c,this.maxY=d},contain:function(a,b){return 1==arguments.length?a.x>=this.minX&&a.x<=this.maxX&&a.y>=this.minY&&a.y<=this.maxY:a.x>this.minX-b&&a.x<this.maxX+b&&a.y>this.minY-b&&a.y<this.maxY+b},expand:function(a){var b=new Xr.MBR(this.minX-a,this.minY-a,this.maxX+a,this.maxY+a);return b},move:function(a,b){var c=this.getCenterY()-a,d=this.getCenterY()-b;this.moveByOffset(c,d)},moveByOffset:function(a,b){this.minX+=a,this.minY+=b,this.maxX+=a,this.maxY+=b},append:function(a){a instanceof Xr.MBR?(mbr.minX<this.minX&&(this.minX=mbr.minX),mbr.minY<this.minY&&(this.minY=mbr.minY),mbr.maxX>this.maxX&&(this.maxX=mbr.maxX),mbr.maxY>this.maxY&&(this.maxY=mbr.maxY)):a instanceof Xr.PointD&&(a.x<this.minX&&(this.minX=a.x),a.y<this.minY&&(this.minY=a.y),a.x>this.maxX&&(this.maxX=a.x),a.y>this.maxY&&(this.maxY=a.y))},centerX:function(){return(this.maxX+this.minX)/2},centerY:function(){return(this.maxY+this.minY)/2},center:function(){var a=this.centerX(),b=this.centerY();return new Xr.PointD(a,b)},valid:function(){if(this.minX>this.maxX){var a=this.minX;this.minX=this.maxX,this.maxX=a}if(this.minY>this.maxY){var a=this.minY;this.minY=this.maxY,this.maxY=a}}}}),Xr.CoordMapper=Xr.Class({name:"CoordMapper",construct:CoordMapper=function(a,b){this._viewCenter=new Xr.PointD(0,0),this._totalOffsetX=0,this._totalOffsetY=0,this._scale=1,this._totalRot=0,this._viewWidth=0,this._viewHeight=0,this._transformMatrix=Matrix.identity(3,3),this._DPI=0,this._pickingTolerance=0,this.resize(a,b)},methods:{resize:function(a,b){var c=this.V2W(this._viewWidth/2,this._viewHeight/2);this._viewWidth=a,this._viewHeight=b,this._viewCenter.set(a/2,b/2),this.transform(0,0,0),this.moveTo(c.x,c.y)},DPI:function(a){return 0==arguments.lenght?this._DPI:void(this._DPI=a)},viewWidth:function(){return this._viewWidth},viewHeight:function(){return this._viewHeight},rotationAngle:function(){return this._totalRot},regenPickingTolerance:function(){var a=this.V2W(0,0),b=this.V2W(7,0);this._pickingTolerance=Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2)),0==this._pickingTolerance&&(this._pickingTolerance=9e-6)},pickingTolerance:function(){return this._pickingTolerance},snappingTolerance:function(){return this._pickingTolerance},viewLength:function(a){var b=new Xr.PointD(a,0),c=new Xr.PointD(0,0),d=this.W2V(b),e=this.W2V(c),f=Math.sqrt(Math.pow(d.x-e.x,2)+Math.pow(d.y-e.y,2));return f},mapLength:function(a){var b=this.V2W(a,0),c=this.V2W(0,0),d=Math.sqrt(Math.pow(b.x-c.x,2)+Math.pow(b.y-c.y,2));return d},translateMatrix:function(a,b){var c=Matrix.create([[1,0,a],[0,1,b],[0,0,1]]);return c},V2W:function(a,b){var c=Matrix.inverse(this._transformMatrix),d=Matrix.create([[a],[this._viewHeight-b],[1]]),e=Matrix.mult(c,d);return new Xr.PointD(e.mat[0][0],e.mat[1][0])},W2V:function(a){var b=Matrix.create([[a.x],[a.y],[1]]),c=Matrix.mult(this._transformMatrix,b);return new Xr.PointD(c.mat[0][0],this._viewHeight-c.mat[1][0])},intersectMBR:function(a,b){return a.minX<=b.maxX&&a.maxX>=b.minX&&a.minY<=b.maxY&&a.maxY>=b.minY},intersectViewportMBR:function(a){return a.minX<=_viewWidth&&a.maxX>=0&&a.minY<=this._viewHeight&&a.maxY>=0},viewportMBR:function(){var a=this.V2W(0,0),b=this.V2W(this._viewWidth,this._viewHeight),c=this.V2W(this._viewWidth,0),d=this.V2W(0,this._viewHeight),e=Math.min(Math.min(c.x,d.x),Math.min(a.x,b.x)),f=Math.min(Math.min(c.y,d.y),Math.min(a.y,b.y)),g=Math.max(Math.max(c.x,d.x),Math.max(a.x,b.x)),h=Math.max(Math.max(c.y,d.y),Math.max(a.y,b.y)),i=new Xr.MBR(e,f,g,h);return i},transform:function(a,b,c){var d=Matrix.create([[0],[0],[1]]),e=Matrix.mult(Matrix.mult(this.translateMatrix(this._totalOffsetX,this._totalOffsetY),this.rotateMatrix(this._totalRot,this._viewCenter)),d),f=Matrix.mult(Matrix.mult(this.rotateMatrix(c,this._viewCenter),this.translateMatrix(a/this._scale,b/this._scale)),e);this._totalRot+=c,this._totalRot>360&&(this._totalRot-=360);var g=this.rotateMatrix(this._totalRot,this._viewCenter),h=Matrix.mult(g,d);this._totalOffsetX=f.mat[0][0]-h.mat[0][0],this._totalOffsetY=f.mat[1][0]-h.mat[1][0],this._transformMatrix=Matrix.mult(Matrix.mult(this.scaleMatrix(this._scale,this._viewCenter),this.translateMatrix(this._totalOffsetX,this._totalOffsetY)),this.rotateMatrix(this._totalRot,this._viewCenter)),this.regenPickingTolerance()},moveTo:function(a,b){var c=this.W2V(new Xr.PointD(a,b));this.translate(this._viewCenter.x-c.x,this._viewCenter.y-c.y)},translate:function(a,b){this.transform(a,-b,0)},reset:function(){this._totalOffsetX=0,this._totalOffsetY=0,this._totalRot=0,this._scale=1,this.transform(0,0,0)},rotate:function(a){this.transform(0,0,a)},rotateAbsolute:function(a){this.transform(0,0,-this._totalRot+a)},zoomIn:function(){this._scale*=1.2,this.transform(0,0,0)},zoomOut:function(){this._scale*=.8,this.transform(0,0,0)},zoomByMBR:function(a){var b,c;this._viewWidth<this._viewHeight?(b=a.maxX-a.minX,c=this._viewWidth):(b=a.maxY-a.minY,c=this._viewHeight),this.scale(c/b),this.moveTo((a.maxX+a.minX)/2,(a.maxY+a.minY)/2)},rotateMatrix:function(a,b){var c=Matrix.create([[1,0,b.x],[0,1,b.y],[0,0,1]]),d=a*(Math.PI/180),e=Matrix.create([[Math.cos(d),Math.sin(d),0],[-Math.sin(d),Math.cos(d),0],[0,0,1]]),f=Matrix.create([[1,0,-b.x],[0,1,-b.y],[0,0,1]]);return Matrix.mult(Matrix.mult(c,e),f)},scaleMatrix:function(a,b){var c=Matrix.create([[1,0,b.x],[0,1,b.y],[0,0,1]]),d=Matrix.create([[a,0,0],[0,a,0],[0,0,1]]),e=Matrix.create([[1,0,-b.x],[0,1,-b.y],[0,0,1]]);return Matrix.mult(Matrix.mult(c,d),e)},scale:function(a){return 0==arguments.length?this._scale:(this._scale=a,void this.transform(0,0,0))},zoomByMeterPerOnePixel:function(a){var b=this.metersPerOnePixel(),c=b/a,d=this.scale(),e=d*c;this.scale(e)},pixelsPerOneMeter:function(){var a=new Xr.PointD(0,0),b=new Xr.PointD(1,0),c=this.W2V(a),d=this.W2V(b),e=Math.sqrt(Math.pow(c.x-d.x,2)+Math.pow(c.y-d.y,2));return e},metersPerOnePixel:function(){var a=this.V2W(0,0),b=this.V2W(1,0),c=Math.sqrt(Math.pow(a.x-b.x,2)+Math.pow(a.y-b.y,2));return c},zoomByMapScale:function(a){var b=this.mapScale(),c=b/a,d=this.scale(),e=d*c;this.scale(e)},mapScaleFromMetersPerOnePixel:function(a){var b=this.metersPerOnePixel(),c=a/b,d=this.mapScale(),e=d*c;return e},mapScale:function(a){if(0==arguments.length){var b=1/2.54*this._DPI,c=this.V2W(0,0),d=this.V2W(b,0),e=Math.sqrt(Math.pow(c.x-d.x,2)+Math.pow(c.y-d.y,2)),f=e/.01;return f}var g=this.mapScale(),h=g/a,i=this.scale(),j=i*h;this.scale(j)}}}),Xr.OperationHelper=Xr.Class({name:"OperationHelper",statics:{createXMLHttpObject:function(){var a=null;return a=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},stringFromDataView:function(a,b,c){for(var d=new Array,e=0;c>e;++e)d[e]=a.getUint8(b+e);return String.fromCharCode.apply(null,d)},stringUTF8:function(a,b,c){for(var d,e="",f=0;c>f;)d=a.getUint8(b+f++),e+=String.fromCharCode(d>223&&240>d&&c-1>f?(15&d)<<12|(63&a.getUint8(b+f++))<<6|63&a.getUint8(b+f++):d>127&&c>f?(31&d)<<6|63&a.getUint8(b+f++):d);return e},trim:function(a){a=a.replace(/^\s+/,"");for(var b=a.length-1;b>0;b--)if(/\S/.test(a.charAt(b))){a=a.substring(0,b+1);break}return a},xmlFromString:function(a){if(window.DOMParser){var b=new window.DOMParser;return b.parseFromString(a,"text/xml")}if("undefined"!=typeof window.ActiveXObject&&new window.ActiveXObject("Microsoft.XMLDOM")){var c=new window.ActiveXObject("Microsoft.XMLDOM");return c.async="false",c.loadXML(a),c}return null},containsInArray:function(a,b){for(var c=a.length,d=0;c>d;d++)if(a[d]===b)return!0;return!1},copyArrayOfPointD:function(a){for(var b=a.length,c=[],d=0;b>d;d++)c.push(a[d].clone());return c},valueFromPx:function(a){var b=a.indexOf("px");return b>-1&&(a=a.substring(0,b)),parseFloat(a)},offsetXY:function(a){var b=a.target.getBoundingClientRect();return new Xr.PointD(a.clientX-b.left,a.clientY-b.top)}}}),Xr.GeometryHelper=Xr.Class({name:"GeometryHelper",statics:{pointInMBR:function(a,b,c){return!(a.minX-c>b.x||a.minY-c>b.y||a.maxX+c<b.x||a.maxY+c<b.y)},pointIn:function(a,b,c,d){return Math.pow(a-d.x,2)+Math.pow(b-d.y,2)<=Math.pow(c,2)},signedArea:function(a){var b=a.length;if(3>b)return 0;for(var c,d=0,e=0;b>e;e++){c=(e+1)%b;var f=a[e],g=a[c];d+=f.x*g.y,d-=f.y*g.x}return d/=2},centroidOfPolygon:function(a){var b=this.signedArea(a);if(0==b)return void 0;for(var c,d=a.length,e=new Xr.PointD(0,0),f=0;d>f;f++){var g=(f+1)%d,h=a[f],i=a[g];c=h.x*i.y-i.x*h.y,e.x+=(h.x+i.x)*c,e.y+=(h.y+i.y)*c}return b*=6,c=1/b,e.x*=c,e.y*=c,e},centroidOfPolyline:function(a){var b=a.length;if(2>b)return void 0;if(2==b){var c=a[0],d=a[1];return new Xr.PointD((c.x+d.x)/2,(c.y+d.y)/2)}var e=parseInt(b/2),f=a[e];return new Xr.PointD(f.x,f.y)},magnitude:function(a,b){var c=new Xr.PointD;return c.x=b.x-a.x,c.y=b.y-a.y,Math.sqrt(c.x*c.x+c.y*c.y)},distanceOfLineFromPoint:function(a,b,c,d){var e=Xr.GeometryHelper.magnitude(b,a),f=((c.x-a.x)*(b.x-a.x)+(c.y-a.y)*(b.y-a.y))/(e*e);return 0>f||f>1?-1:(d.x=a.x+f*(b.x-a.x),d.y=a.y+f*(b.y-a.y),Xr.GeometryHelper.magnitude(c,d))},intersectPointFromLine:function(a,b,c,d){if(a.x!=b.x||a.y!=b.y){var e=Xr.GeometryHelper.magnitude(b,a),f=((c.x-a.x)*(b.x-a.x)+(c.y-a.y)*(b.y-a.y))/(e*e);if(0>f||f>1)return void 0;var g=new Xr.PointD(a.x+f*(b.x-a.x),a.y+f*(b.y-a.y));return Xr.GeometryHelper.magnitude(c,g)>d?void 0:g}return void 0},MBR:function(a){for(var b=new Xr.MBR,c=a.length,d=0;c>d;++d)for(var e=a[d],f=e.length,g=0;f>g;++g){var h=e[g];b.append(h)}return b},distanceBetweenLineAndPoint:function(a,b,c){var d=Math.sqrt(Math.pow(b.x-a.x,2)+Math.pow(b.y-a.y,2)),e=((c.x-a.x)*(b.x-a.x)+(c.y-a.y)*(b.y-a.y))/(d*d);if(0>e||e>1)return-1;var f=a.x+e*(b.x-a.x),g=a.y+e*(b.y-a.y);return Math.sqrt(Math.pow(f-c.x,2)+Math.pow(g-c.y,2))},pointInPolyline:function(a,b,c){for(var d=a.length,e=1;d>e;e++){var f=a[e-1],g=a[e],h=this.distanceBetweenLineAndPoint(f,g,b);if(h>0&&c>h)return!0}return!1},pointInPolygon:function(a,b){for(var c,d,e=0,f=a[0],g=a.length,h=1;g>=h;h++)d=a[h%g],b.y>Math.min(f.y,d.y)&&b.y<=Math.max(f.y,d.y)&&b.x<=Math.max(f.x,d.x)&&f.y!=d.y&&(c=(b.y-f.y)*(d.x-f.x)/(d.y-f.y)+f.x,(f.x==d.x||b.x<=c)&&e++),f=d;return e%2!=0},angle:function(a,b){var c=b.y-a.y,d=b.x-a.x;if(0==d)return 0;var e=Math.atan(c/d)*(180/Math.PI);return 0>d?e+=180:0>c&&(e+=360),e},vertexOnLineByDistance:function(a,b,c){var d=Math.sqrt((a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y));if(0==d)return void 0;var e=c/d;return e>1?void 0:new PointD(a.x+e*(b.x-a.x),a.y+e*(b.y-a.y))}}}),Xr.UserModeEnum=Xr.Class({name:"UserModeEnum",statics:{VIEW:0,EDIT:1}}),Xr.IMouseInteraction=Xr.Class({name:"IMouseInteraction",methods:{mouseDown:function(){},mouseMove:function(){},mouseUp:function(){},click:function(){},dblClick:function(){}}}),Xr.IKeyboardInteraction=Xr.Class({name:"IKeyboardInteraction",methods:{keyDown:function(){},keyPress:function(){},keyUp:function(){}}}),Xr.UserState=Xr.Class({name:"UserState",statics:{mouseDown:!1,mouseDownPt:new Xr.PointD,mouseDownMapSnapPt:new Xr.PointD,mouseDownAndMovePt:new Xr.PointD,mouseDownAndMoveMapSnapPt:new Xr.PointD,snapMapPt:new Xr.PointD,bSnapVertex:!1,bSnapEdge:!1}}),Xr.Map=Xr.Class({name:"Map",construct:function(a,b){this._div="object"==typeof a?a:document.getElementById(a),this._options=b;var c=this._div.clientWidth,d=this._div.clientHeight;this._div.style.position="relative",this._div.style.backgroundImage="url('http://www.geoservice.co.kr/geoservice.png')",this._coordMapper=new Xr.CoordMapper(c,d),this._coordMapper.DPI(72),this._labelDrawer=new Xr.label.LabelDrawer,this._editManager=new Xr.managers.EditManager(this),this._userControlManager=new Xr.managers.UserControlManager(this),this._layerManager=new Xr.managers.LayerManager(this._div,this._coordMapper,this._labelDrawer,this._editManager,this._userControlManager),this._div.map=this,this._div.tabIndex="0",this._userMode=Xr.UserModeEnum.VIEW,window.addEventListener("resize",this._resize),this._div.addEventListener("mousedown",this._mouseDownEvent),this._div.addEventListener("mousemove",this._mouseMoveEvent),this._div.addEventListener("mouseup",this._mouseUpEvent),this._div.addEventListener("touchstart",this._touchStartEvent),this._div.addEventListener("touchmove",this._touchMoveEvent),this._div.addEventListener("touchend",this._touchEndEvent),this._div.addEventListener("click",this._mouseClickEvent),this._div.addEventListener("dblclick",this._mouseDblClickEvent),this._div.addEventListener("keydown",this._keyDownEvent),this._div.addEventListener("keypress",this._keyPressEvent),this._div.addEventListener("keyup",this._keyUpEvent),this._div.addEventListener("mousewheel",this._mouseWheel),this._div.addEventListener("DOMMouseScroll",this._mouseWheel)},methods:{userMode:function(a){return 0==arguments.length?this._userMode:(this._userMode=a,void(a==Xr.UserModeEnum.VIEW&&this.edit().cancelSketch()))
},_resize:function(){var a=this.map.container().clientWidth,b=this.map.container().clientHeight;this.map.resize(a,b),this.map.update()},_mouseWheel:function(a){var b=0;a||(a=window.event),a.wheelDelta?b=a.wheelDelta/120:a.detail&&(b=-a.detail/3);var c=this.map.userControls().zoomScaleControl();if(c){var d=c.scaleLevel();this.map.userControls("zlc").scaleLevel(b>0?--d:++d)}a.preventDefault()},_keyDownEvent:function(a){this.map._userMode==Xr.UserModeEnum.EDIT&&this.map._editManager.keyDown(a)},_keyPressEvent:function(a){this.map._userMode==Xr.UserModeEnum.EDIT&&this.map._editManager.keyPress(a)},_keyUpEvent:function(a){this.map._userMode==Xr.UserModeEnum.EDIT&&this.map._editManager.keyUp(a)},_mouseDownEvent:function(a){Xr.UserState.mouseDown=!0;var b=Xr.OperationHelper.offsetXY(a);if(Xr.UserState.mouseDownPt.x=b.x,Xr.UserState.mouseDownPt.y=b.y,Xr.UserState.mouseDownAndMovePt.x=b.x,Xr.UserState.mouseDownAndMovePt.y=b.y,this.map._div.focus(),this.map._div.setCapture&&this.map._div.setCapture(),this._bMapPanning=!0,this.map._userMode==Xr.UserModeEnum.EDIT){var c=this.map._editManager.currentSketch();c&&c.isNew()||a.ctrlKey?(this.map._editManager.mouseDown(a),this._bMapPanning=!1):this._bMapPanning=!this.map._editManager.mouseDown(a)}else this.map._userMode==Xr.UserModeEnum.VIEW&&this.map.layers().update(Xr.MouseActionEnum.MOUSE_DOWN,0,0);this.map._userControlManager.mouseDown(a)},_mouseMoveEvent:function(a){var b=this.map;if(Xr.UserState.mouseDown){var c=Xr.OperationHelper.offsetXY(a),d=c.x-Xr.UserState.mouseDownAndMovePt.x,e=c.y-Xr.UserState.mouseDownAndMovePt.y;(this._bMapPanning||b._userMode==Xr.UserModeEnum.VIEW)&&(b.coordMapper().translate(d,e),b.layers().update(Xr.MouseActionEnum.MOUSE_DRAG,c.x-Xr.UserState.mouseDownPt.x,c.y-Xr.UserState.mouseDownPt.y),b._userControlManager.mouseMove(a))}if(b._userMode==Xr.UserModeEnum.EDIT&&(this._bMapPanning?b._editManager.mouseMoveOnPanningMode(a):b._editManager.mouseMove(a)),Xr.UserState.mouseDown){var c=Xr.OperationHelper.offsetXY(a);Xr.UserState.mouseDownAndMovePt.x=c.x,Xr.UserState.mouseDownAndMovePt.y=c.y}},_mouseUpEvent:function(a){if(Xr.UserState.mouseDown){var b=Xr.OperationHelper.offsetXY(a);Xr.UserState.mouseDown=!1,this.map._div.releaseCapture&&this.map._div.releaseCapture(),this._bMapPanning||this.map._userMode!=Xr.UserModeEnum.EDIT?(Xr.UserState.mouseDownPt.x!=b.x||Xr.UserState.mouseDownPt.y!=b.y)&&this.map.update():this.map._editManager.mouseUp(a),this.map._userControlManager.mouseUp(a),this._bMapPanning=!1}},_mouseClickEvent:function(a){var b=Xr.OperationHelper.offsetXY(a);if(Xr.UserState.mouseDownPt.x==b.x&&Xr.UserState.mouseDownPt.y==b.y){var c=this.map.coordMapper().V2W(b.x,b.y),d=Xr.Events.create(Xr.Events.MapClick,{mapX:c.x,mapY:c.y,viewX:b.x,viewY:b.y,ctrlKey:a.ctrlKey});Xr.Events.fire(this.map.container(),d)}this.map._userMode==Xr.UserModeEnum.EDIT&&this.map._editManager.click(a),this.map._userControlManager.click(a)},_mouseDblClickEvent:function(a){this.map._userMode==Xr.UserModeEnum.EDIT&&this.map._editManager.dblClick(a),this.map._userControlManager.dblClick(a)},_touchStartEvent:function(a){if(a.preventDefault(),a.touches.length>0){var b=a.touches[0];Xr.UserState.mouseDown=!0,Xr.UserState.mouseDownPt.x=b.offsetX,Xr.UserState.mouseDownPt.y=b.offsetx,Xr.UserState.mouseDownAndMovePt.x=b.offsetX,Xr.UserState.mouseDownAndMovePt.y=b.offsetY}},_touchMoveEvent:function(a){if(a.preventDefault(),a.changedTouches.length>0&&Xr.UserState.mouseDown){var b=a.touches[0],c=b.clientX-Xr.UserState.mouseDownAndMovePt.x,d=b.clientY-Xr.UserState.mouseDownAndMovePt.y;this.map.getCoordMapper().translate(c,d),this.map.getLayerManager().update(Xr.MouseActionEnum.MOUSE_DRAG,b.clientX-Xr.UserState.mouseDownPt.x,b.clientY-Xr.UserState.mouseDownPt.y),Xr.UserState.mouseDownAndMovePt.x=b.clientX,Xr.UserState.mouseDownAndMovePt.y=b.clientY}},_touchEndEvent:function(a){a.preventDefault(),Xr.UserState.mouseDown&&(Xr.UserState.mouseDown=!1,this.map.layers().update(Xr.MouseActionEnum.MOUSE_UP))},container:function(){return this._div},layers:function(a){return 0==arguments.length?this._layerManager:this._layerManager.layer(a)},edit:function(){return this._editManager},userControls:function(a){return 0==arguments.length?this._userControlManager:this._userControlManager.control(a)},coordMapper:function(){return this._coordMapper},update:function(){var a=this.coordMapper().mapScale();if(void 0==this._oldMapScale||this._oldMapScale!=a){var b=Xr.Events.create(Xr.Events.MapScaleChanged,{mapScale:a});Xr.Events.fire(this.container(),b)}var c=this.coordMapper().viewportMBR().clone();if(void 0==this._oldViewportMBR||!this._oldViewportMBR.same(c)){var b=Xr.Events.create(Xr.Events.MapViewChanged,{viewport:c});Xr.Events.fire(this.container(),b)}this.layers().update(),this.edit().update(),this._oldMapScale=a,this._oldViewportMBR=c},onLayersAllReady:function(a){this._allLayersReadyCallback=a,this._allLayersReadyTimerId=setTimeout(this._allLayersReadyEvent,500,this)},resize:function(a,b){this._coordMapper.resize(a,b)},_allLayersReadyEvent:function(a){clearTimeout(a._allLayersReadyTimerId),a.layers().allLayersConnectionCompleted()?(a._allLayersReadyCallback(),delete a._allLayersReadyCallback,delete a._allLayersReadyTimerId):a._allLayersReadyTimerId=setTimeout(a._allLayersReadyEvent,500,a)},addEventListener:function(a,b,c){this._div.addEventListener(a,b,void 0==c?!1:c)},removeEventListener:function(a,b,c){this._div.removeEventListener(a,b,void 0==c?!1:c)}}}),Xr.Events=Xr.Class({name:"Events",statics:{create:function(a,b,c,d){var e=document.createEvent("Event");for(var f in b)b.hasOwnProperty(f)&&(e[f]=b[f]);return e.initEvent(a,void 0==c?!1:c,void 0==d?!1:d),e},fire:function(a,b){a.dispatchEvent(b)},UndoStateChanged:"undostatechanged",RedoStateChanged:"redostatechanged",MapScaleChanged:"mapscalechanged",MapViewChanged:"mapviewchanged",MapClick:"mapclick",EditCompleted:"editcompleted",LayerUpdateCompleted:"layerupdatecompleted"}}),Xr.managers=Xr.managers||{},Xr.managers.LayerManager=Xr.Class({name:"LayerManager",construct:function(a,b,c,d,e){this._layers=new Array,this._mapDiv=a,this._coordMapper=b,this._labelDrawer=c,this._editManager=d,this._userControls=e},methods:{count:function(){return this._layers.length},exist:function(a){for(var b=this._layers.length,c=0;b>c;c++)if(this._layers[c].name()==a)return!0;return!1},index:function(a){for(var b=this._layers.length,c=0;b>c;c++)if(this._layers[c].name()==a)return c;return-1},layer:function(a){for(var b=this._layers.length,c=0;b>c;c++){var d=this._layers[c].name();if(d==a)return this._layers[c]}return null},layerByIndex:function(a){var b=this._layers.length;return 0>a||a>=b?null:this._layers[a]},add:function(a){return this.exist(a.name())?!1:(this._layers.push(a),this._mapDiv.appendChild(a.container()),this._mapDiv.appendChild(this._labelDrawer.container()),this._mapDiv.appendChild(this._editManager.container()),this._mapDiv.appendChild(this._userControls.container()),a.labelDrawer(this._labelDrawer),a.connect(this._coordMapper),!0)},removeAll:function(){for(var a=this.count(),b=a-1;b>=0;b--){var c=this.layerByIndex(b),d=c.container();this._mapDiv.removeChild(d),this._layers.splice(b,1)}},remove:function(a){var b=this.index(a);if(-1!=b){var c=this.layer(a),d=c.container();this._mapDiv.removeChild(d),this._layers.splice(b,1)}},update:function(a,b,c){void 0==a&&(a=Xr.MouseActionEnum.NO_MOUSE),void 0==b&&(b=0),void 0==c&&(c=0);for(var d=this._layers.length,e=0;d>e;e++)this._layers[e].update(this._coordMapper,a,b,c);this._labelDrawer.update(this._coordMapper,a,b,c)},allLayersConnectionCompleted:function(){for(var a=this._layers.length,b=0;a>b;b++)if(!this._layers[b].conneted())return!1;return!0}}}),Xr.managers=Xr.managers||{},Xr.managers.EditManager=Xr.Class({name:"EditManager",requires:[Xr.IMouseInteraction,Xr.IKeyboardInteraction],construct:function(a){this._map=a,this._coordMapper=a.coordMapper(),this._svg=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"svg"),this._svg.style.position="absolute",this._svg.style.top="0px",this._svg.style.left="0px",this._svg.style.width="100%",this._svg.style.height="100%",this._svg.style.overflow="hidden",this._svg.style.setProperty("pointer-events","none"),this._sketch=void 0,this._targetGraphicLayer=void 0,this._editHistory=new Xr.edit.EditHistory(this),this._snapManager=new Xr.edit.SnapManager(this)},methods:{snap:function(){return this._snapManager},targetGraphicLayer:function(a){return 1!=arguments.length?this._targetGraphicLayer:void(this._targetGraphicLayer=a)},history:function(){return this._editHistory},coordMapper:function(){return this._map.coordMapper()},container:function(){return this._svg},newPolygon:function(a){if(this._map.userMode()==Xr.UserModeEnum.EDIT){this.cancelSketch();var b=new Array,c=new Array;b.push(c);var d=new Xr.data.PolygonShapeData(b);return this._sketch=new Xr.edit.PolygonSketch(this,d,a,!0),!0}return!1},newPolyline:function(a){if(this._map.userMode()==Xr.UserModeEnum.EDIT){this.cancelSketch();var b=new Array,c=new Array;b.push(c);var d=new Xr.data.PolylineShapeData(b);return this._sketch=new Xr.edit.PolylineSketch(this,d,a,!0),!0}return!1},newPoint:function(a){if(this._map.userMode()==Xr.UserModeEnum.EDIT){this.cancelSketch();var b=new Xr.PointD,c=new Xr.data.PointShapeData(b);return this._sketch=new Xr.edit.PointSketch(this,c,a,!0),!0}return!1},newText:function(a){if(this._map.userMode()==Xr.UserModeEnum.EDIT){this.cancelSketch();var b={x:0,y:0,text:"TEXT"},c=new Xr.data.TextShapeData(b);return this._sketch=new Xr.edit.TextSketch(this,c,a,!0),!0}return!1},newRectangle:function(a){if(this._map.userMode()==Xr.UserModeEnum.EDIT){this.cancelSketch();var b=new Xr.MBR,c=new Xr.data.RectangleShapeData(b);return this._sketch=new Xr.edit.RectangleSketch(this,c,a,!0),!0}return!1},newEllipse:function(a){if(this._map.userMode()==Xr.UserModeEnum.EDIT){this.cancelSketch();var b={cx:0,cy:0,rx:0,ry:0},c=new Xr.data.EllipseShapeData(b);return this._sketch=new Xr.edit.EllipseSketch(this,c,a,!0),!0}return!1},_calculateSnapMapPt:function(a){var b=this._coordMapper,c=Xr.OperationHelper.offsetXY(a),d=b.V2W(c.x,c.y),e=this._snapManager,f=b.snappingTolerance(),g=void 0;Xr.UserState.snapMapPt=d,Xr.UserState.bSnapVertex=!1,Xr.UserState.bSnapEdge=!1,e.vertexSnapMode()&&(g=e.vertexSnap(d,f),void 0!=g&&(Xr.UserState.bSnapVertex=!0)),void 0==g&&e.edgeSnapMode()&&(g=e.edgeSnap(d,f),void 0!=g&&(Xr.UserState.bSnapEdge=!0)),void 0!=g&&(Xr.UserState.snapMapPt=g.clone())},mouseDown:function(a){return this._calculateSnapMapPt(a),Xr.UserState.mouseDownMapSnapPt=Xr.UserState.snapMapPt,Xr.UserState.mouseDownAndMoveMapSnapPt=Xr.UserState.snapMapPt,void 0!=this._sketch?this._sketch.mouseDown(a):!1},mouseMoveOnPanningMode:function(){this.refreshSketch()},mouseMove:function(a){this._calculateSnapMapPt(a),void 0!=this._sketch&&this._sketch.mouseMove(a),Xr.UserState.mouseDown&&(Xr.UserState.mouseDownAndMoveMapSnapPt=Xr.UserState.snapMapPt)},mouseUp:function(a){this._calculateSnapMapPt(a),void 0!=this._sketch&&this._sketch.mouseUp(a)},click:function(a){this._calculateSnapMapPt(a);var b=(a.shiftKey,this.targetGraphicLayer()),c=Xr.OperationHelper.offsetXY(a),d=b.IdByMousePoint(c.x,c.y,!1);if(!this._sketch||this._sketch.isNew()||this._sketch.stay()||this.cancelSketch(),this._sketch&&this._sketch.stay()&&this._sketch.stay(!1),this._sketch)this._sketch.click(a);else if(d.length>0){var e=b.rowSet().rows(),f=d[0],g=e[f],h=g.graphicData().toSketch(this,parseInt(f));this.cleanContainer();var i=h.createSVG(this.coordMapper());this.container().appendChild(i),this._sketch=h}else this.cancelSketch()},dblClick:function(a){this._calculateSnapMapPt(a),void 0!=this._sketch&&this._sketch.dblClick(a)},keyDown:function(a){void 0!=this._sketch&&this._sketch.keyDown(a)},keyPress:function(a){void 0!=this._sketch&&this._sketch.keyPress(a)},keyUp:function(a){void 0!=this._sketch&&this._sketch.keyUp(a)},cleanContainer:function(){for(var a,b=this.container(),c=b.childNodes,d=c.length,e=0;d>e;e++)a=c[0],b.removeChild(a)},cancelSketch:function(){this.cleanContainer(),this._sketch=void 0},currentSketch:function(){return this._sketch},setSketchById:function(a){this.cancelSketch();var b=this.targetGraphicLayer(),c=b.rowSet().rows(),d=c[a];if(void 0==d)return void 0;var e=d.graphicData().toSketch(this,a),f=e.createSVG(this.coordMapper());return e.stay(!0),this.container().appendChild(f),this._sketch=e,this._sketch},refreshSketch:function(){if(this._sketch){var a=this._sketch.id();this.setSketchById(a)}},synchronize:function(a){if(a&&a.run()){var b=a.type();b==Xr.edit.AddPartCommand.TYPE?(this._sketch.isNew(!1),this._sketch.update()):b==Xr.edit.AddVertexCommand.TYPE?this.refreshSketch():b==Xr.edit.MoveCommand.TYPE?this._sketch.stay(!0):b==Xr.edit.MoveControlPointCommand.TYPE?this._sketch.stay(!0):b==Xr.edit.NewCommand.TYPE?(this._sketch.isNew(!1),this._sketch.stay(!0),this._sketch.update()):b==Xr.edit.RemoveCommand.TYPE?this.cancelSketch():b==Xr.edit.RemovePartCommand.TYPE?this.refreshSketch():b==Xr.edit.RemoveVertexCommand.TYPE&&this.refreshSketch(),this._editHistory.add(a);var c=Xr.Events.create(Xr.Events.EditCompleted,{editCommandType:b});Xr.Events.fire(this._map.container(),c)}this._map.update()},map:function(){return this._map},update:function(){this._sketch&&this._sketch.update()}}}),Xr.managers=Xr.managers||{},Xr.managers.UserControlManager=Xr.Class({name:"UserControlManager",requires:[Xr.IMouseInteraction],construct:function(a){this._controls=new Array,this._map=a,this._div=document.createElement("div"),this._div.style.position="absolute",this._div.style.top="0px",this._div.style.left="0px",this._div.style.width="100%",this._div.style.height="100%",this._div.style.overflow="hidden"},methods:{container:function(){return this._div},count:function(){return this._controls.length},exist:function(a){for(var b=this._controls.length,c=0;b>c;c++)if(this._controls[c].name()==a)return!0;return!1},index:function(a){for(var b=this._controls.length,c=0;b>c;c++)if(this._controls[c].name()==a)return c;return-1},zoomScaleControl:function(){for(var a=this._controls.length,b=0;a>b;b++){var c=this._controls[b];if(c instanceof Xr.ui.ZoomLevelControl)return c}return null},control:function(a){for(var b=this._controls.length,c=0;b>c;c++)if(this._controls[c].name()==a)return this._controls[c];return null},controlByIndex:function(a){var b=this._controls.length;return 0>a||a>=b?null:this._controls[a]},add:function(a){return this.exist(a.name())?!1:(this._controls.push(a),this._div.appendChild(a.container()),a.prepare(),a.update(),!0)},remove:function(a){var b=this.index(a);if(-1!=b){var c=this._controls[b];c.release();var d=c.container();this._div.removeChild(d),this._controls.splice(b,1)}},update:function(){for(var a=this._controls.length,b=0;a>b;b++)this._controls[b].update(this._map)},mouseDown:function(a){for(var b=this._controls.length,c=0;b>c;c++)this._controls[c].mouseDown(a)},mouseMove:function(a){for(var b=this._controls.length,c=0;b>c;c++)this._controls[c].mouseMove(a)},mouseUp:function(a){for(var b=this._controls.length,c=0;b>c;c++)this._controls[c].mouseUp(a)},click:function(a){for(var b=this._controls.length,c=0;b>c;c++)this._controls[c].click(a)},dblClick:function(){for(var a=this._controls.length,b=0;a>b;b++)this._controls[b].update(this._map)}}}),Xr.Visibility=Xr.Class({name:"Visibility",construct:function(){this._bVisibleByScale=!1,this._bVisible=!0,this._fromScale=0,this._toScale=Number.MAX_VALUE},methods:{visible:function(a){return 0==arguments.length?this._bVisible:void(this._bVisible=a)},visibleByScale:function(a){return 0==arguments.length?this._bVisibleByScale:void(this._bVisibleByScale=a)},fromScale:function(a){return 0==arguments.length?this._fromScale:void(this._fromScale=a)},toScale:function(a){return 0==arguments.length?this._toScale:void(this._toScale=a)},needRendering:function(a){return 0==arguments.length?this._bVisible:this._bVisibleByScale?this._bVisible&&this._fromScale<=a&&this._toScale>a:this._bVisible}}}),Xr.IHitTest=Xr.Class({name:"IHitTest",methods:{hitTest:function(){return!1}}}),Xr.edit=Xr.edit||{},Xr.edit.ISnap=Xr.Class({name:"ISnap",methods:{vertexSnap:function(){},edgeSnap:function(){}}}),Xr.layers=Xr.layers||{},Xr.layers.Layer=Xr.Class({name:"Layer",construct:function(a,b){this._name=a,this._connectionString=b,this._visibility=new Xr.Visibility,this._labelDrawer=void 0},methods:{name:function(){return this._name},connectionString:function(){return this._connectionString},toString:function(){return this._name+"("+this.connectionString()+")"},labelDrawer:function(a){return 0==arguments.length?this._labelDrawer:void(this._labelDrawer=a)},visibility:function(){return this._visibility},IdByMousePoint:function(){return-1}}}),Xr.layers=Xr.layers||{},Xr.layers.ILayer=Xr.Class({name:"ILayer",methods:{container:function(){return null},connect:function(){return!1},update:function(){return!1},MBR:function(){return null},conneted:function(){return!1}}}),Xr.layers=Xr.layers||{},Xr.layers.XYZLayer=Xr.Class({name:"XYZLayer",extend:Xr.layers.Layer,construct:function(a,b){Xr.layers.Layer.call(this,a,b),this._div=document.createElement("div"),this._div.style.position="absolute",this._div.style.top="0px",this._div.style.left="0px",this._div.style.width="100%",this._div.style.height="100%",this._div.style.overflow="hidden",this._div.style.setProperty("pointer-events","none"),this._levelDataList=new Array,this._mbr=new Xr.MBR,this._connected=!1,this._nextRequestUrlIndex=0},methods:{container:function(){return this._div},connect:function(){},_getOptimizePiramidIndex:function(a){for(var b=a.metersPerOnePixel(),c=this._levelDataList.length,d=Number.MAX_VALUE,e=-1,f=0;c>f;++f){var g=this._levelDataList[f],h=Math.abs(g.unitsPerPixel()-b);d>h&&(d=h,e=f)}return e},_removeTileImages:function(a){for(var b=this.container(),c=b.getElementsByClassName("tilemap"),d=c.length-1;d>=0;d--){var e=c[d];(a||e.candidateBeDeleted)&&b.removeChild(e)}},update:function(a,b){var c=a.mapScale();if(this.visibility().needRendering(c)){for(var d=this.container(),e=d.getElementsByClassName("tilemap"),f=e.length,g=f-1;g>=0;g--)e[g].candidateBeDeleted=!0;var h=a.viewportMBR(),i=this._getOptimizePiramidIndex(a),j=this._levelDataList[i];if(!j)return;var k=j.minX(),l=j.minY(),m=j.maxX(),n=j.maxY(),o=j.tileMapWidth(),p=j.tileMapHeight(),q=new Xr.MBR(k,l,m,n);if(a.intersectMBR(q,h)){var r,s=parseInt((h.minX-q.minX)/o);r=parseInt(this._bReversedRows?(q.maxY-h.maxY)/p:(h.minY-q.minY)/p);var t,u=parseInt((h.maxX-q.minX)/o);t=parseInt(this._bReversedRows?(q.maxY-h.minY)/p:(h.maxY-q.minY)/p),r--,t++,s--,u++;for(var v=Xr.PointD,w=this._bReversedRows,x=j.rows,y=j.columns(),z=t;z>=r;z--)for(var A=s;u>=A;++A)if(!(0>z||0>A||z>x-1||A>y-1)){for(var B,C=!0,g=f-1;g>=0;g--)if(B=e[g],B.nPiramid==i&&B.nRow==z&&B.nColumn==A){B.candidateBeDeleted=!1,C=!1;break}var D;if(C){D=document.createElement("img"),D.setAttribute("class","tilemap"),this._nextRequestUrlIndex=++this._nextRequestUrlIndex%this._urls.length;var E=this._urls[this._nextRequestUrlIndex].replace("${z}",i+1).replace("${y}",z).replace("${x}",A);D.setAttribute("src",E),D.nPiramid=i,D.nRow=z,D.nColumn=A,D.candidateBeDeleted=!1,d.appendChild(D)}else D=B;var F=D.style;F.setProperty("-webkit-transform","rotate("+a.rotationAngle()+"deg)"),F.setProperty("transform","rotate("+a.rotationAngle()+"deg)");var G;w?(G=new v(k+A*o,q.maxY-p*z),wPtRT=new v(k+o*(A+1),n-p*z),wPtRB=new v(k+A*o+o,q.maxY-p*(z+1))):(G=new v(k+A*o,l+(z+1)*p),wPtRT=new v(k+o*(A+1),l+p*(z+1)),wPtRB=new v(k+(A+1)*o,l+z*p));var H=a.W2V(G),I=a.W2V(wPtRT),J=a.W2V(wPtRB);F.top=Math.floor(H.y),F.left=Math.floor(H.x),F.width=Math.ceil(Math.sqrt(Math.pow(H.x-I.x,2)+Math.pow(H.y-I.y,2))),F.height=Math.ceil(Math.sqrt(Math.pow(I.x-J.x,2)+Math.pow(I.y-J.y,2)))}if(b==Xr.MouseActionEnum.NO_MOUSE){var K=this;setTimeout(function(){K._removeTileImages(!1)},800)}else this._removeTileImages(!1)}}else this._removeTileImages(!0)},MBR:function(){return this._mbr},conneted:function(){return this._connected}}}),Xr.layers=Xr.layers||{},Xr.layers.TileMapLayer=Xr.Class({name:"TileMapLayer",extend:Xr.layers.XYZLayer,requires:[Xr.layers.ILayer],construct:function(a,b){if(!b.url)throw new Error("TileMapLayer requires url option.");if(!b.ext)throw new Error("TileMapLayer requires ext option.");Xr.layers.XYZLayer.call(this,a,b.url),this._urls=[b.url+"/${z}/${y}/${x}."+b.ext],this._bReversedRows=!1,b.proxy&&(this._proxy=b.proxy)},methods:{connect:function(){function a(){for(var a,b,c,d,f=e._levelDataList.length,g=0;f>g;g++){var h=e._levelDataList[g];0==g?(a=h.minX(),b=h.minY(),c=h.maxX(),d=h.maxY()):(a>h.minX()&&(a=h.minX()),b>h.minY()&&(b=h.minY()),c<h.maxX()&&(c=h.maxX()),d<h.maxY()&&(d=h.maxY()))}e._mbr.set(a,b,c,d),e._connected=!0}var b=this.connectionString()+"/metadata.xml",c=void 0!=this._proxy;c&&(b=this._proxy+"?reqPrx|"+b+"|GEOSERVICE");var d=new Xr.layers.TMSConnectionRequest(b,this._levelDataList,c,a);d.request();var e=this}}}),Xr.layers=Xr.layers||{},Xr.layers.TMSLevelData=Xr.Class({name:"TMSLevelData",construct:function(a,b,c,d,e,f,g,h){this._scale=a,this._unitsPerPixel=b,this._tileMapWidth=c,this._tileMapHeight=d,this._minX=e,this._minY=f,this._rows=g,this._columns=h},methods:{toString:function(){return"scale: "+this.scale()+"\nunitsPerPixel: "+this.unitsPerPixel()+"\ntileMapWidth: "+this.tileMapWidth()+"\ntileMapHeight: "+this.tileMapHeight()+"\nminX: "+this.minX()+"\nminY: "+this.minY()+"\nrows: "+this.rows()+"\ncolumns: "+this.columns()},scale:function(){return this._scale},unitsPerPixel:function(){return this._unitsPerPixel},tileMapWidth:function(){return this._tileMapWidth},tileMapHeight:function(){return this._tileMapHeight},minX:function(){return this._minX},minY:function(){return this._minY},maxX:function(){return this._minX+this._tileMapWidth*this._columns},maxY:function(){return this._minY+this._tileMapHeight*this._rows},rows:function(){return this._rows},columns:function(){return this._columns}}}),Xr.layers=Xr.layers||{},Xr.layers.TMSConnectionRequest=Xr.Class({name:"TMSConnectionRequest",construct:function(a,b,c,d,e){this._xhr=Xr.OperationHelper.createXMLHttpObject(),this._xhr.open("GET",a),this._levelDataList=b;var f=this;this._xhr.onreadystatechange=function(){if(4==f._xhr.readyState)if(200==f._xhr.status){var g;if(c){var h=f._xhr.responseText;g=Xr.OperationHelper.xmlFromString(h.substring(0,h.length-1))}else g=f._xhr.responseXML;f._parsingXML(g,b),d&&d()}else e?e():alert("TMSConnectionRequest ERROR : "+a)}},methods:{_parsingXML:function(a,b){for(var c=a.getElementsByTagName("Level"),d=0;d<c.length;++d){var e=c[d],f=parseFloat(e.getElementsByTagName("Scale")[0].childNodes[0].nodeValue),g=parseFloat(e.getElementsByTagName("UnitsPerPixel")[0].childNodes[0].nodeValue),h=parseFloat(e.getElementsByTagName("TileMapWidth")[0].childNodes[0].nodeValue),i=parseFloat(e.getElementsByTagName("TileMapHeight")[0].childNodes[0].nodeValue),j=parseFloat(e.getElementsByTagName("MinX")[0].childNodes[0].nodeValue),k=parseFloat(e.getElementsByTagName("MinY")[0].childNodes[0].nodeValue),l=parseInt(e.getElementsByTagName("Rows")[0].childNodes[0].nodeValue),m=parseInt(e.getElementsByTagName("Columns")[0].childNodes[0].nodeValue),n=new Xr.layers.TMSLevelData(f,g,h,i,j,k,l,m);b[d]=n}},request:function(){this._xhr.send(null)}}}),Xr.layers=Xr.layers||{},Xr.layers.TMSLayer=Xr.Class({name:"TMSLayer",extend:Xr.layers.XYZLayer,requires:[Xr.layers.ILayer],construct:function(a,b){if(!b.mbr)throw new Error("TileMapLayer requires mbr option.");if(!b.urls)throw new Error("TileMapLayer requires urls option.");if(!b.upps)throw new Error("TileMapLayer requires upps option.");b.imageSize=b.imageSize||256,b.reversedRows=b.reversedRows||!1,Xr.layers.XYZLayer.call(this,a),this._mbr=new Xr.MBR(b.mbr.minX,b.mbr.minY,b.mbr.maxX,b.mbr.maxY),this._urls=b.urls,this._upps=b.upps,this._tileImageSize=b.imageSize,this._bReversedRows=b.reversedRows},methods:{_buildLevelData:function(a){for(var b=this._upps.length,c=0;b>c;++c){var d=a.mapScaleFromMetersPerOnePixel(this._upps[c]);console.log(d);var e=this._tileImageSize*this._upps[c],f=this._tileImageSize*this._upps[c],g=this._mbr.minX,h=this._mbr.minY,i=(this._mbr.maxY-this._mbr.minY)/f,j=(this._mbr.maxX-this._mbr.minX)/e,k=new Xr.layers.TMSLevelData(d,this._upps[c],e,f,g,h,i,j);this._levelDataList[c]=k,console.log(c,d,this._upps[c],e,f,g,h,i,j)}},connect:function(a){this._buildLevelData(a);for(var b,c,d,e,f=this._levelDataList.length,g=0;f>g;g++){var h=this._levelDataList[g];0==g?(b=h.minX(),c=h.minY(),d=h.maxX(),e=h.maxY()):(b>h.minX()&&(b=h.minX()),c>h.minY()&&(c=h.minY()),d<h.maxX()&&(d=h.maxX()),e<h.maxY()&&(e=h.maxY()))}this._mbr.set(b,c,d,e),this._connected=!0}}}),Xr.layers=Xr.layers||{},Xr.layers.CoordinateLayer=Xr.Class({name:"CoordinateLayer",extend:Xr.layers.Layer,requires:[Xr.layers.ILayer,Xr.edit.ISnap],construct:function(a,b){arguments[0]!==__XR_CLASS_LOADING_TIME__&&(Xr.layers.Layer.call(this,a,b),this._svg=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"svg"),this._svg.style.position="absolute",this._svg.style.top="0px",this._svg.style.left="0px",this._svg.style.width="100%",this._svg.style.height="100%",this._svg.style.overflow="hidden",this._svg.style.setProperty("pointer-events","none"),this._vectorType=void 0,this._recordCount=void 0,this._fieldCount=void 0,this._mbr=void 0,this._label=new Xr.Label(this),this._theme=new Xr.theme.SimpleShapeDrawTheme(this),this._connected=!1,this._coordMapper=void 0)},methods:{connect:function(){},update:function(){},theme:function(a){return 0==arguments.length?this._theme:void(this._theme=a)},container:function(){return this._svg},reset:function(){this.shapeRowSet().reset(),this.attributeRowSet().reset()},MBR:function(){return this._mbr},conneted:function(){return this._connected},shapeRowSet:function(){return this._shapeRowSet},attributeRowSet:function(){return this._attributeRowSet},fieldSet:function(){return this._attributeRowSet.fieldSet()},attributeById:function(a){return this._attributeRowSet.row(a)},label:function(){return this._label},vertexSnap:function(a,b){var c=this.shapeRowSet().rows(),d=void 0,e=void 0,f=void 0;for(var g in c)if(d=c[g],e=d.shapeData(),f=e.vertexSnap(a,b))break;return f},edgeSnap:function(a,b){var c=this.shapeRowSet().rows(),d=void 0,e=void 0,f=void 0;for(var g in c)if(d=c[g],e=d.shapeData(),f=e.edgeSnap(a,b))break;return f},IdByMousePoint:function(a,b,c){var d=new Array,e=this._coordMapper,f=this.shapeRowSet().rows();for(var g in f)if(row=f[g],row.shapeData().hitTest(a,b,e)&&(d.push(g),c))break;return d},hilighting:function(a,b){var c=this.container().getElementById(a);return c?(c.style.animationDuration="0.2s",b&&(c.style.animationDuration=b+"s"),c.style.animationIterationCount=10,c.style.animationDirection="alternate",c.style.animationName="kf_hilighting",!0):!1}}}),Xr.layers=Xr.layers||{},Xr.layers.CoordinateQueryRequest=Xr.Class({name:"CoordinateQueryRequest",construct:function(a,b,c,d,e,f){this._xhr=Xr.OperationHelper.createXMLHttpObject(),this._xhr.open("GET",a),this._mouseAction=d;var g=this;this._xhr.onreadystatechange=function(){if(4==g._xhr.readyState)if(200==g._xhr.status){var d=g._xhr.response;g._parsingData(d,b),g._buildSVG(b,c),e&&e()}else f?f():alert("CoordinateQueryRequest ERROR : "+a)}},methods:{_buildSVG:function(a,b){for(var c=a.container(),d=c.childNodes,e=d.length,f=a.attributeRowSet(),g=f.fieldSet(),h=f.rows(),i=a.theme(),j=a.name(),k=a.labelDrawer(),l=a.label(),m=b.mapScale(),n=a.shapeRowSet().rows(),o=l.formatter(),p=l.theme(),q=k.container(),r=l.enable()&&l.visibility().needRendering(m),s=0;e>s;s++)c.removeChild(d[0]);if(k.clean(j),a.visibility().needRendering(m))for(var t in n){var u=n[t],v=h[t],w=i.symbol(u,g,v),x=u.createSVG(b,v,w);if(x.id=t,c.appendChild(x),r){var y=o.value(u,g,v);if(y.length>0){var z=p.symbol(u,g,v);text=v.createSVG(b,u,y,z),q.appendChild(text);var A=text.getBBox(),B=u.shapeData().representativePoint(),C=b.W2V(B),D=C.x-A.width/2,E=C.x+A.width/2,F=C.y+A.height/2,G=C.y-A.height/2;k.add(new Xr.MBR(D,G,E,F))?text.id=j+t:q.removeChild(text)}}}},request:function(){this._xhr.send(null)}}}),Xr.layers=Xr.layers||{},Xr.layers.ShapeMapLayer=Xr.Class({name:"ShapeMapLayer",extend:Xr.layers.CoordinateLayer,construct:function(a,b){if(!b.url)throw new Error("ShapeMapLayer requires url option.");var c=b.url,d=c.replace("layerName=","CnGD|N|");this._queryUrlPrefix=c.replace("layerName=","RqGD|N|")+"|",this.superclass(a,d),this._bAlwaysNeedAttribute=!1},methods:{connect:function(a){function b(){var a,b=d.vectorType();65==b?a=Xr.data.ShapeType.POLYGON:112==b?a=Xr.data.ShapeType.POINT:76==b&&(a=Xr.data.ShapeType.POLYLINE),e._recordCount=d.recordCount(),e._fieldCount=d.fieldCount(),e._mbr=d.MBR(),e._connected=!0,e._shapeRowSet=new Xr.data.ShapeRowSet(a);var c=d.fieldSet();e._attributeRowSet=new Xr.data.AttributeRowSet(c)}var c=this.connectionString(),d=new Xr.layers.ShapeMapConnectionRequest(c,b);d.request(),this._coordMapper=a;var e=this},update:function(a,b,c,d){function e(){var a=q.container().parentNode;if(a){var b=Xr.Events.create(Xr.Events.LayerUpdateCompleted,{layerName:q.name()});Xr.Events.fire(a,b)}}var f=a.mapScale();if(this.visibility().needRendering(f)||this.label().enable()&&this.label().visibility().needRendering(f)){var g,h=this.container(),i=h.childNodes,j=i.length;if(b==Xr.MouseActionEnum.MOUSE_DOWN);else if(b==Xr.MouseActionEnum.MOUSE_DRAG)for(var k=this.shapeRowSet().rows(),l=0;j>l;l++){g=i[l];var m=k[g.id];m&&g.setAttribute("transform","translate("+c+","+d+")")}else{var n=a.viewportMBR(),o=this.needAttribute(),p=this._queryUrlPrefix+n.minX+"|"+n.minY+"|"+n.maxX+"|"+n.maxY+"|"+(o?"Y":"N")+"|null",q=this,r=new Xr.layers.ShapeMapQueryRequest(p,this,a,b,e);r.request()}}else{for(var i=this._svg.childNodes,j=i.length,l=0;j>l;l++)g=i[0],this._svg.removeChild(g);this.labelDrawer().clean(this.name())}},needAttribute:function(a){return 0==arguments.length?this._label.enable()||this._theme.needAttribute()||this._bAlwaysNeedAttribute:void(this._bAlwaysNeedAttribute=a)}}}),Xr.layers=Xr.layers||{},Xr.layers.ShapeMapConnectionRequest=Xr.Class({name:"ShapeMapConnectionRequest",construct:function(a,b,c){this._xhr=Xr.OperationHelper.createXMLHttpObject(),this._xhr.open("GET",a),this._xhr.responseType="arraybuffer";var d=this;this._xhr.onreadystatechange=function(){if(4==d._xhr.readyState)if(200==d._xhr.status){var e=d._xhr.response;d._parsingData(e),b&&b()}else c?c():alert("ShapeMapConnectionRequest ERROR : "+a)}},methods:{_parsingData:function(a){{var b=new DataView(a);b.getUint32(0,!0),b.getInt8(4)}this._vectorType=b.getInt8(5),this._recordCount=b.getUint32(6,!0);var c=b.getFloat32(10,!0),d=b.getFloat32(14,!0),e=b.getFloat32(18,!0),f=b.getFloat32(22,!0);this._mbr=new Xr.MBR(c,d,e,f);b.getInt8(26);this._fieldCount=b.getUint32(27,!0),this._fieldSet=new Xr.data.FieldSet;for(var g=31,h=0;h<this._fieldCount;++h){var i=b.getInt8(g,!0);g+=1;var j;73==i?j=Xr.data.FieldType.INTEGER:83==i?j=Xr.data.FieldType.SHORT:115==i?j=Xr.data.FieldType.VERTSHORT:70==i?j=Xr.data.FieldType.FLOAT:68==i?j=Xr.data.FieldType.DOUBLE:88==i&&(j=Xr.data.FieldType.STRING);var k=b.getInt8(g,!0);g+=1;var l=Xr.OperationHelper.stringFromDataView(b,g,k-1);g+=k;var m=new Xr.data.Field(l,j);this._fieldSet.add(m)}},vectorType:function(){return this._vectorType},recordCount:function(){return this._recordCount},MBR:function(){return this._mbr},fieldCount:function(){return this._fieldCount},request:function(){this._xhr.send(null)},fieldSet:function(){return this._fieldSet}}}),Xr.layers=Xr.layers||{},Xr.layers.ShapeMapQueryRequest=Xr.Class({name:"ShapeMapQueryRequest",extend:Xr.layers.CoordinateQueryRequest,construct:function(a,b,c,d,e,f){this.superclass(a,b,c,d,e,f),this._xhr.responseType="arraybuffer"},methods:{_buildAttributeRows:function(a,b,c,d,e){var f=new DataView(b),g=d.rows();for(var h in g)g[h].willBeDeleted=!0;for(var i=0,j=c,k=d.fieldSet().fieldTypes(),l=k.length,m=Xr.data.FieldType,n=Xr.OperationHelper,o=Xr.data.AttributeRow,i=0;i<e.length;++i){var h=e[i],p=f.getUint32(j,!0);if(j+=4,void 0!=g[h])j+=p,g[h].willBeDeleted=!1;
else{for(var q=new o(h,l),r=0;l>r;++r){var s=k[r];if(s==m.DOUBLE){var t=f.getFloat64(j,!0);j+=8,q.setValue(r,t.toString())}else if(s==m.FLOAT){var u=f.getFloat32(j,!0);j+=4,q.setValue(r,u.toString())}else if(s==m.INTEGER){var v=f.getInt32(j,!0);j+=4,q.setValue(r,v.toString())}else if(s==m.SHORT){var w=f.getInt16(j,!0);j+=2,q.setValue(r,w.toString())}else if(s==m.STRING){var x=f.getUint8(j,!0);j+=1;var y=n.stringUTF8(f,j,x-1);j+=x,q.setValue(r,y)}else if(s==m.VERYSHORT){var z=f.getInt8(j);j+=1,q.setValue(r,z.toString())}else alert("[_buildAttributeRows] Unknown Type: "+s)}d.add(q)}}for(var h in g)g[h].willBeDeleted&&delete g[h]},_buildPointRows:function(a,b,c,d){var e=c.rows();for(var f in e)e[f].willBeDeleted=!0;for(var g=0,h=12,i=Xr.MBR,j=Xr.data.PointShapeData,k=Xr.data.PointShapeRow;a>h-12;){var f=b.getUint32(h,!0);h+=4;var l=b.getUint32(h,!0);if(h+=4,void 0!=e[f])h+=l,e[f].willBeDeleted=!1;else{var m=b.getFloat32(h,!0);h+=4;var n=b.getFloat32(h,!0);h+=4;var o=new i(m,n,m,n),p=new j(o),q=new k(f,p);c.add(q)}d[g++]=f}for(var f in e)e[f].willBeDeleted&&delete e[f];return h},_buildPolylineRows:function(a,b,c,d){var e=c.rows();for(var f in e)e[f].willBeDeleted=!0;var g=0,h=12;for(Xr.MBR,Xr.data.PolylineShapeData,Xr.data.PolylineShapeRow;a>h-12;){var f=b.getUint32(h,!0);h+=4;var i=b.getUint32(h,!0);if(h+=4,void 0!=e[f])h+=i,e[f].willBeDeleted=!1;else{var j=b.getFloat32(h,!0);h+=4;var k=b.getFloat32(h,!0);h+=4;var l=b.getFloat32(h,!0);h+=4;var m=b.getFloat32(h,!0);h+=4;var n=new MBR(j,k,l,m),o=b.getUint16(h,!0);h+=2;for(var p=new Array(o),q=0;o>q;++q)p[q]=b.getUint32(h,!0),h+=4;for(var r=new PolylineShapeData(n),s=r.data(),q=0;o>q;++q){for(var t=p[q],u=new Array(t),v=0;t>v;++v){var w=b.getFloat32(h,!0);h+=4;var x=b.getFloat32(h,!0);h+=4;var y=new Xr.PointD(w,x);u[v]=y}s[q]=u}var z=new PolylineShapeRow(f,r);c.add(z)}d[g++]=f}for(var f in e)e[f].willBeDeleted&&delete e[f];return h},_buildPolygonRows:function(a,b,c,d){var e=c.rows();for(var f in e)e[f].willBeDeleted=!0;for(var g=0,h=12,i=Xr.MBR,j=Xr.data.PolygonShapeData,k=Xr.data.PolygonShapeRow;a>h-12;){var f=b.getUint32(h,!0);h+=4;var l=b.getUint32(h,!0);if(h+=4,void 0!=e[f])h+=l,e[f].willBeDeleted=!1;else{var m=b.getFloat32(h,!0);h+=4;var n=b.getFloat32(h,!0);h+=4;var o=b.getFloat32(h,!0);h+=4;var p=b.getFloat32(h,!0);h+=4;var q=new i(m,n,o,p),r=b.getUint16(h,!0);h+=2;for(var s=new Array(r),t=0;r>t;++t)s[t]=b.getUint32(h,!0),h+=4;for(var u=new j(q),v=u.data(),t=0;r>t;++t){for(var w=s[t],x=new Array(w),y=0;w>y;++y){var z=b.getFloat32(h,!0);h+=4;var A=b.getFloat32(h,!0);h+=4;var B=new Xr.PointD(z,A);x[y]=B}v[t]=x}var C=new k(f,u);C.willBeDeleted=!1,c.add(C)}d[g++]=f}for(var f in e)e[f].willBeDeleted&&delete e[f];return h},_parsingData:function(a,b){var c,d=new DataView(a),e=b.shapeRowSet(),f=e.shapeType(),g=new Array,h=(d.getUint32(0,!0),d.getUint32(4,!0)),i=d.getUint32(8,!0);if(f==Xr.data.ShapeType.POINT?c=this._buildPointRows(h,d,e,g):f==Xr.data.ShapeType.POLYLINE?c=this._buildPolylineRows(h,d,e,g):f==Xr.data.ShapeType.POLYGON&&(c=this._buildPolygonRows(h,d,e,g)),i>0){var j=b.attributeRowSet();this._buildAttributeRows(i,a,c,j,g)}}}}),Xr.layers=Xr.layers||{},Xr.layers.WFSLayer=Xr.Class({name:"WFSLayer",extend:Xr.layers.CoordinateLayer,construct:function(a,b){this.superclass(a,void 0),this._params=b,this._urlHeader=b.url,this._typeName=b.typeName,this._connected=!1},methods:{connect:function(a){function b(){var a,b=c.vectorType();-1!=b.indexOf("Polygon")?a=Xr.data.ShapeType.POLYGON:-1!=b.indexOf("Point")?a=Xr.data.ShapeType.POINT:-1!=b.indexOf("LineString")&&(a=Xr.data.ShapeType.POLYLINE),d._fieldCount=c.fieldCount(),d._mbr=new Xr.MBR(Number.MIN_VALUE,Number.MIN_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),d._connected=!0,d._shapeRowSet=new Xr.data.ShapeRowSet(a);var e=c.fieldSet();d._attributeRowSet=new Xr.data.AttributeRowSet(e)}if(this._urlHeader&&this._typeName){var c=(this.connectionString(),new Xr.layers.WFSConnectionRequest(this._urlHeader,this._typeName,b));c.request(),this._coordMapper=a;var d=this}},update:function(a,b,c,d){function e(){var a=p.container().parentNode;if(a){var b=Xr.Events.create(Xr.Events.LayerUpdateCompleted,{layerName:p.name()});Xr.Events.fire(a,b)}}var f=a.mapScale();if(this.visibility().needRendering(f)||this.label().enable()&&this.label().visibility().needRendering(f)){var g,h=this.container(),i=h.childNodes,j=i.length;if(b==Xr.MouseActionEnum.MOUSE_DOWN);else if(b==Xr.MouseActionEnum.MOUSE_DRAG)for(var k=this.shapeRowSet().rows(),l=0;j>l;l++){g=i[l];var m=k[g.id];m&&g.setAttribute("transform","translate("+c+","+d+")")}else{var n=a.viewportMBR(),o=this._urlHeader+"?"+encodeURI("service=wfs&version=1.0.0&outputFormat=application/json&request=GetFeature&typeName="+this._typeName+"&bbox="+n.minX+","+n.minY+","+n.maxX+","+n.maxY),p=this,q=new Xr.layers.WFSQueryRequest(o,this,a,b,e);q.request()}}else{for(var i=this._svg.childNodes,j=i.length,l=0;j>l;l++)g=i[0],this._svg.removeChild(g);this.labelDrawer().clean(this.name())}}}}),Xr.layers=Xr.layers||{},Xr.layers.WFSConnectionRequest=Xr.Class({name:"WFSConnectionRequest",construct:function(a,b,c,d){var e=a+"?"+encodeURI("service=wfs&version=1.0.0&request=DescribeFeatureType&typeName="+b);this._xhr=Xr.OperationHelper.createXMLHttpObject(),this._xhr.open("GET",e);var f=this;this._xhr.onreadystatechange=function(){if(4==f._xhr.readyState)if(200==f._xhr.status){var a=f._xhr.responseXML;f._parsingData(a),c&&c()}else d?d():alert("WFSConnectionRequest ERROR : "+e)}},methods:{_parsingData:function(a){var b=a.getElementsByTagName("xsd:sequence");if(1==b.length){b=b[0].getElementsByTagName("xsd:element"),this._fieldSet=new Xr.data.FieldSet;for(var c=b.length,d=0;c>d;++d){var e=b[d],f=e.getAttribute("name"),g=e.getAttribute("type");if(-1!=g.indexOf("gml:"))this._vectorType=g;else{if("xsd:long"==g||"xsd:int"==g)g=Xr.data.FieldType.INTEGER;else if("xsd:double"==g)g=Xr.data.FieldType.DOUBLE;else{if("xsd:string"!=g)return void alert("Not Supported Yet : "+g);g=Xr.data.FieldType.STRING}var h=new Xr.data.Field(f,g);this._fieldSet.add(h)}}}},vectorType:function(){return this._vectorType},fieldCount:function(){return this._fieldSet.size()},request:function(){this._xhr.send(null)},fieldSet:function(){return this._fieldSet}}}),Xr.layers=Xr.layers||{},Xr.layers.WFSQueryRequest=Xr.Class({name:"WFSQueryRequest",extend:Xr.layers.CoordinateQueryRequest,construct:function(a,b,c,d,e,f){this.superclass(a,b,c,d,e,f)},methods:{_buildPointRows:function(a,b,c){{var d=b.rows(),e=c.fieldSet();e.size()}for(var f in d)d[f].willBeDeleted=!0;for(var g=Xr.data.PointShapeData,h=Xr.data.PointShapeRow,i=a.features,j=i.length,k=-1,l=0;j>l;++l){var m=i[l];-1==k&&(k=m.id.indexOf(".")+1);var f=m.id.substring(k);if(void 0!=d[f])d[f].willBeDeleted=!1;else{var n=m.geometry.coordinates,o=m.properties,p=m.geometry.type;if("Point"===p);else if("MultiPoint"===p)return void alert("WFS MultiPoint Not Supported Yet.");var q=new g(new Xr.PointD(n[0],n[1])),r=new h(f,q);r.willBeDeleted=!1,b.add(r),this._buildAttributeRow(f,e,c,o)}}for(var f in d)d[f].willBeDeleted&&delete d[f]},_buildPolylineRows:function(a,b,c){{var d=b.rows(),e=c.fieldSet();e.size()}for(var f in d)d[f].willBeDeleted=!0;for(var g=Xr.data.PolylineShapeData,h=Xr.data.PolylineShapeRow,i=a.features,j=i.length,k=-1,l=0;j>l;++l){var m=i[l];-1==k&&(k=m.id.indexOf(".")+1);var f=m.id.substring(k);if(void 0!=d[f])d[f].willBeDeleted=!1;else{var n=m.geometry.coordinates,o=m.properties,p=m.geometry.type,q=new Array;if("MultiLineString"===p)for(var r=n.length,s=0;r>s;++s){for(var t=n[s],u=t.length,v=new Array(u),w=0;u>w;++w){var x=t[w],y=new Xr.PointD(x[0],x[1]);v[w]=y}q.push(v)}else if("LineString"===p){for(var u=n.length,v=new Array(u),w=0;u>w;++w){var x=n[w],y=new Xr.PointD(x[0],x[1]);v[w]=y}q.push(v)}var z=new g(q),A=new h(f,z);A.willBeDeleted=!1,b.add(A),this._buildAttributeRow(f,e,c,o)}}for(var f in d)d[f].willBeDeleted&&delete d[f]},_buildPolygonRows:function(a,b,c){{var d=b.rows(),e=c.fieldSet();e.size()}for(var f in d)d[f].willBeDeleted=!0;for(var g=Xr.data.PolygonShapeData,h=Xr.data.PolygonShapeRow,i=a.features,j=i.length,k=-1,l=0;j>l;++l){var m=i[l];-1==k&&(k=m.id.indexOf(".")+1);var f=m.id.substring(k);if(void 0!=d[f])d[f].willBeDeleted=!1;else{var n=m.geometry.coordinates,o=m.properties,p=m.geometry.type,q=new Array;if("MultiPolygon"===p)for(var r=n.length,s=0;r>s;++s)for(var t=n[s],u=t.length,v=0;u>v;++v){for(var w=t[v],x=w.length,y=new Array(x),z=0;x>z;++z){var A=w[z],B=new Xr.PointD(A[0],A[1]);y[z]=B}q.push(y)}else if("Polygon"===p)for(var r=n.length,s=0;r>s;++s){for(var C=n[s],x=C.length,y=new Array(x),z=0;x>z;++z){var A=C[z],B=new Xr.PointD(A[0],A[1]);y[z]=B}q.push(y)}var D=new g(q),E=new h(f,D);E.willBeDeleted=!1,b.add(E),this._buildAttributeRow(f,e,c,o)}}for(var f in d)d[f].willBeDeleted&&delete d[f]},_buildAttributeRow:function(a,b,c,d){for(var e=b.size(),f=new Xr.data.AttributeRow(a,e),g=0;e>g;++g){var h=b.fieldName(g),i=d[h];f.setValue(g,i)}c.add(f)},_parsingData:function(a,b){var c=b.shapeRowSet(),d=b.attributeRowSet(),e=c.shapeType(),f=JSON.parse(a);e==Xr.data.ShapeType.POINT?this._buildPointRows(f,c,d):e==Xr.data.ShapeType.POLYLINE?this._buildPolylineRows(f,c,d):e==Xr.data.ShapeType.POLYGON&&this._buildPolygonRows(f,c,d)}}}),Xr.layers=Xr.layers||{},Xr.layers.GraphicLayer=Xr.Class({name:"GraphicLayer",extend:Xr.layers.Layer,requires:[Xr.layers.ILayer,Xr.edit.ISnap],construct:function(a){Xr.layers.Layer.call(this,a,void 0),this._svg=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"svg"),this._svg.style.position="absolute",this._svg.style.top="0px",this._svg.style.left="0px",this._svg.style.width="100%",this._svg.style.height="100%",this._svg.style.overflow="hidden",this._svg.style.setProperty("pointer-events","none"),this._rowSet=new Xr.data.GraphicRowSet(this),this._mbr=void 0,this._connected=!0,this._coordMapper=void 0},methods:{container:function(){return this._svg},connect:function(a){this._coordMapper=a},refresh:function(){this.update(this._coordMapper)},hilighting:function(a,b){var c=this.container().getElementById(this.name()+a);return c?(c.style.animationDuration="0.2s",b&&(c.style.animationDuration=b+"s"),c.style.animationIterationCount=10,c.style.animationDirection="alternate",c.style.animationName="kf_hilighting",!0):!1},update:function(a,b,c,d){var e=a.mapScale(),f=this._svg,g=f.childNodes;if(this.visibility().needRendering(e)){var h;if(b==Xr.MouseActionEnum.MOUSE_DOWN);else if(b==Xr.MouseActionEnum.MOUSE_DRAG)for(var i=g.length,j=0;i>j;j++)h=g[j],h.setAttribute("transform","translate("+c+","+d+")");else{var k=a.viewportMBR();this._removeAllChildNode();var l,m,n,o=this.rowSet().rows();for(var p in o)l=o[p],m=l.MBR(a,f),a.intersectMBR(m,k)&&(n=l.createSVG(a),n.id=this.name()+p,f.appendChild(n));var q=this.container().parentNode;if(q){var r=Xr.Events.create(Xr.Events.LayerUpdateCompleted,{layerName:this.name()});Xr.Events.fire(q,r)}}}else this._removeAllChildNode()},_removeAllChildNode:function(){for(var a,b=this._svg,c=b.childNodes,d=c.length,e=0;d>e;e++)a=c[0],b.removeChild(a)},removeAll:function(){this._rowSet.reset(),this._removeAllChildNode()},reset:function(){this.removeAll()},MBR:function(){return this._mbr},conneted:function(){return this._connected},rowSet:function(){return this._rowSet},IdByMousePoint:function(a,b,c){var d=new Array,e=this._coordMapper,f=this.rowSet().rows();for(var g in f)if(row=f[g],row.hitTest(a,b,e)&&(d.push(g),c))break;return d},vertexSnap:function(a,b){var c=this.rowSet().rows(),d=void 0,e=void 0,f=void 0;for(var g in c)if(d=c[g],e=d.graphicData(),f=e.vertexSnap(a,b))break;return f},edgeSnap:function(a,b){var c=this.rowSet().rows(),d=void 0,e=void 0,f=void 0;for(var g in c)if(d=c[g],e=d.graphicData(),f=e.edgeSnap(a,b))break;return f}}}),Xr.layers=Xr.layers||{},Xr.layers.GridLayer=Xr.Class({name:"GridLayer",extend:Xr.layers.Layer,requires:[Xr.layers.ILayer],construct:function(a,b){if(this.superclass(a,void 0),this._div=document.createElement("div"),this._div.style.position="absolute",this._div.style.top="0px",this._div.style.left="0px",this._div.style.border="none",this._div.style.width="100%",this._div.style.height="100%",this._div.style.overflow="hidden",this._div.style.setProperty("pointer-events","none"),this._img=document.createElement("img"),this._img.style.position="absolute",this._img.style.setProperty("pointer-events","none"),this._img.style.setProperty("user-select","none"),this._img.style.overflow="hidden",this._img.style.display="none",this.container().appendChild(this._img),b.mbr&&(this._mbr=b.mbr),b.resolution&&(this._resolution=b.resolution),this._connected=void 0!=this._mbr&&void 0!=this._resolution,this._connected){this._countRows=parseInt(Math.ceil((this._mbr.maxY-this._mbr.minY)/this._resolution)),this._countColumns=parseInt(Math.ceil((this._mbr.maxX-this._mbr.minX)/this._resolution));var c=this._countRows*this._countColumns;this._cells=new Float64Array(c);for(var d=0;c>d;d++)this._cells[d]=0/0}this._maxValue=-Number.MAX_VALUE,this._minValue=Number.MAX_VALUE,this._coordMapper=void 0},methods:{reset:function(){for(var a=this._countRows*this._countColumns,b=0;a>b;b++)this._cells[b]=0/0;this._maxValue=-Number.MAX_VALUE,this._minValue=Number.MAX_VALUE},minValue:function(){return this._minValue},maxValue:function(){return this._maxValue},densityByLayer:function(a,b,c,d,e){var f=new Array;if(!(a instanceof Xr.layers.ShapeMapLayer))return!1;var g=a.shapeRowSet().rows(),h=a.attributeRowSet().rows(),i=-1;if(d){var j=a.attributeRowSet().fieldSet(),k=j.fieldType(d);if(void 0==k||k==Xr.data.FieldType.STRING)return!1;if(i=j.fieldIndex(d),-1==i)return!1}var l=this.MBR();for(var m in g){var n=g[m],o=n.shapeData().representativePoint();if(l.contain(o)){var p=1;if(-1!=i){var q=h[m];p=q.valueAsFloat(i)}f.push({value:p,x:o.x,y:o.y})}}var r=window.Xr.rasterOperatorsPath+"density.js",s=new Worker(r),t=document.createElement("canvas");t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.width=this._countColumns,t.height=this._countRows;var u=t.getContext("2d"),v=t.getContext("2d").createImageData(this._countColumns,this._countRows),w=v.data,x=this;return s.onmessage=function(a){var b=a.data;"number"==typeof b?e&&e(b):(x._minValue=b.minValue,x._maxValue=b.maxValue,x._cells.set(b.cells),w.set(b.imgRawData),u.putImageData(v,0,0),x._img.src=t.toDataURL(),x._img.style.display="block",x.refresh(),t=void 0,w=void 0)},s.postMessage({data:f,mbr:this._mbr,resolution:this._resolution,radius:b,countRows:this._countRows,countColumns:this._countColumns,cells:this._cells,colorTable:c,imgRawData:w}),!0},cellValuesByLayer:function(a,b){if(!(a instanceof Xr.layers.ShapeMapLayer))return!1;var c=a.shapeRowSet().rows(),d=a.attributeRowSet().rows(),e=-1;if(b){var f=d.fieldSet(),g=f.fieldType(b);if(!g||g==Xr.data.FieldType.STRING)return!1;if(e=f.fieldIndex(b),-1==e)return!1}for(var h in c){var i=c[h],j=i.shapeData().representativePoint(),k=1;if(-1!=e){{d[h]}k=attrRow.valueAsFloat(e)}this.value(j.x,j.y,k)}return!0},container:function(){return this._div},connect:function(a){this._coordMapper=a},valueByIndex:function(a,b,c){return 2==arguments.length?this._cells[a*this._countColumns+b]:void(this._cells[a*this._countColumns+b]=c)},accumulate:function(a,b,c){var d=this.value(a,b);if(void 0!=d){var e;return e=isNaN(d)?c:c+this.value(a,b),this.value(a,b,e),e}return void 0},value:function(a,b,c){if(!this._mbr.contain(new Xr.PointD(a,b)))return void 0;var d=this.row(b),e=this.column(a);return 2==arguments.length?this._cells[d*this._countColumns+e]:(this._cells[d*this._countColumns+e]=c,c<this._minValue&&(this._minValue=c),c>this._maxValue&&(this._maxValue=c),void 0)},row:function(a){var b=parseInt(Math.floor((a-this._mbr.minY)/this._resolution));return this._countRows-b-1},column:function(a){return parseInt(Math.floor((a-this._mbr.minX)/this._resolution))},refresh:function(){this.update(this._coordMapper)},update:function(a,b,c,d){var e=a.mapScale();if(this.visibility().needRendering(e))if(this._div.style.display="block",b==Xr.MouseActionEnum.MOUSE_DOWN)this._previousImgLeft=Xr.OperationHelper.valueFromPx(this._img.style.left),this._previousImgTop=Xr.OperationHelper.valueFromPx(this._img.style.top);else if(b==Xr.MouseActionEnum.MOUSE_DRAG){{Xr.OperationHelper.valueFromPx(this._img.style.left),Xr.OperationHelper.valueFromPx(this._img.style.top)}this._img.style.top=this._previousImgTop+d,this._img.style.left=this._previousImgLeft+c}else{var f=this._coordMapper,g=f.W2V(new Xr.PointD(this._mbr.minX,this._mbr.maxY)),h=f.W2V(new Xr.PointD(this._mbr.maxX,this._mbr.minY)),i=f.W2V(new Xr.PointD(this._mbr.maxX,this._mbr.maxY));this._img.style.setProperty("-webkit-transform-origin","0px 0px"),this._img.style.setProperty("-webkit-transform","rotate("+f.rotationAngle()+"deg)"),this._img.style.setProperty("transform-origin","0px 0px"),this._img.style.setProperty("transform","rotate("+f.rotationAngle()+"deg)"),this._img.style.top=Math.floor(g.y),this._img.style.left=Math.floor(g.x),this._img.style.width=Math.ceil(Math.sqrt(Math.pow(g.x-i.x,2)+Math.pow(g.y-i.y,2))),this._img.style.height=Math.ceil(Math.sqrt(Math.pow(i.x-h.x,2)+Math.pow(i.y-h.y,2)));var j=this.container().parentNode;if(j){var k=Xr.Events.create(Xr.Events.LayerUpdateCompleted,{layerName:this.name()});Xr.Events.fire(j,k)}}else this._div.style.display="none"},MBR:function(){return this._mbr},conneted:function(){return this._connected}}}),Xr.ColorTable=Xr.Class({name:"ColorTable",construct:function(a){this._colors=new Array(a)},methods:{set:function(a,b,c,d,e){this._colors[a]={r:b,g:c,b:d,a:e}},build:function(){var a=new Array,b=this.size();if(2>b)return!1;if(void 0==this._colors[0]||void 0==this._colors[b-1])return!1;for(var c=0;b>c;c++){var d=this.color(c);d&&a.push(c)}for(var e=a.length-1,c=0;e>c;c++)for(var f=a[c],g=a[c+1],h=this.color(f),i=this.color(g),j=(i.r-h.r)/(g-f),k=(i.g-h.g)/(g-f),l=(i.b-h.b)/(g-f),m=(i.a-h.a)/(g-f),n=f+1;g>n;n++){var o=this.color(n-1);this.set(n,o.r+j,o.g+k,o.b+l,o.a+m)}return!0},size:function(){return this._colors.length},length:function(){return this._colors.length},color:function(a){return this._colors[a]},colors:function(){return this._colors}}}),Xr.layers=Xr.layers||{},Xr.layers.WMSLayer=Xr.Class({name:"WMSLayer",extend:Xr.layers.Layer,requires:[Xr.layers.ILayer],construct:function(a,b){this.superclass(a,void 0),this._div=document.createElement("div"),this._div.style.position="absolute",this._div.style.top="0px",this._div.style.left="0px",this._div.style.border="none",this._div.style.width="100%",this._div.style.height="100%",this._div.style.overflow="hidden",this._div.style.setProperty("pointer-events","none"),this._img=document.createElement("img"),this._img.style.position="absolute",this._img.style.setProperty("pointer-events","none"),this._img.style.setProperty("user-select","none"),this._img.style.overflow="hidden",this.container().appendChild(this._img),this._params=b,this._connected=void 0!=b.url&&void 0!=b.layers&&void 0!=b.srs,this._coordMapper=void 0,this._mbr=new Xr.MBR(Number.MIN_VALUE,Number.MIN_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},methods:{container:function(){return this._div},connect:function(a){this._coordMapper=a},refresh:function(){this.update(this._coordMapper)},_getFullUrl:function(){var a=this._coordMapper,b=a.viewportMBR(),c=a.viewWidth(),d=a.viewHeight(),e=this._params,f=e.url,g="request=GetMap&width="+c+"&height="+d+"&bbox="+b.minX+","+b.minY+","+b.maxX+","+b.maxY;for(var h in e)e.hasOwnProperty(h)&&"url"!=h&&(g+="&"+h+"="+e[h]);return f+"?"+encodeURI(g)},update:function(a,b,c,d){var e=a.mapScale();if(this.visibility().needRendering(e))if(this._div.style.display="block",b==Xr.MouseActionEnum.MOUSE_DOWN)this._previousImgLeft=Xr.OperationHelper.valueFromPx(this._img.style.left),this._previousImgTop=Xr.OperationHelper.valueFromPx(this._img.style.top);else if(b==Xr.MouseActionEnum.MOUSE_DRAG){{Xr.OperationHelper.valueFromPx(this._img.style.left),Xr.OperationHelper.valueFromPx(this._img.style.top)}this._img.style.top=this._previousImgTop+d,this._img.style.left=this._previousImgLeft+c}else{if(!this._img.onload){var f=this;this._img.onload=function(){var a=f._coordMapper,b=a.viewportMBR();f._img.style.setProperty("-webkit-transform-origin","0px 0px"),f._img.style.setProperty("-webkit-transform","rotate("+a.rotationAngle()+"deg)"),f._img.style.setProperty("transform-origin","0px 0px"),f._img.style.setProperty("transform","rotate("+a.rotationAngle()+"deg)");var c=a.W2V(new Xr.PointD(b.minX,b.maxY)),d=a.W2V(new Xr.PointD(b.maxX,b.minY)),e=a.W2V(new Xr.PointD(b.maxX,b.maxY));f._img.style.top=Math.floor(c.y),f._img.style.left=Math.floor(c.x),f._img.style.width=Math.ceil(Math.sqrt(Math.pow(c.x-e.x,2)+Math.pow(c.y-e.y,2))),f._img.style.height=Math.ceil(Math.sqrt(Math.pow(e.x-d.x,2)+Math.pow(e.y-d.y,2)))}}var g=this._getFullUrl();this._img.setAttribute("src",g);var h=this.container().parentNode;if(h){var i=Xr.Events.create(Xr.Events.LayerUpdateCompleted,{layerName:this.name()});Xr.Events.fire(h,i)}}else this._div.style.display="none"},MBR:function(){return this._mbr},conneted:function(){return this._connected}}}),Xr.Label=Xr.Class({name:"Label",construct:function(a){this._layer=a,this._enable=!1,this._theme=new Xr.theme.SimpleLabelDrawTheme(this),this._formatter=new Xr.label.SingleValueLabelFormatter(this),this._visibility=new Xr.Visibility},methods:{formatter:function(a){return 0==arguments.length?this._formatter:void(this._formatter=a)},theme:function(a){return 0==arguments.length?this._theme:void(this._theme=a)},enable:function(a){return 0==arguments.length?this._enable:void(this._enable=a)},visibility:function(){return this._visibility},toString:function(){return"Label: "+this._layer.getName}}}),Xr.label=Xr.label||{},Xr.label.ILabelFormatter=Xr.Class({name:"ILabelFormatter",methods:{value:function(){return null}}}),Xr.label=Xr.label||{},Xr.label.ProgrammableLabelFormatter=Xr.Class({name:"ProgrammableLabelFormatter",construct:function(a){this._shapeMapLayer=a},methods:{layer:function(){return this._shapeMapLayer}}}),Xr.label=Xr.label||{},Xr.label.SingleValueLabelFormatter=Xr.Class({name:"SingleValueLabelFormatter",extend:Xr.label.ProgrammableLabelFormatter,requires:[Xr.label.ILabelFormatter],construct:function(a,b){this.superclass(a),this._symbol=new Xr.symbol.FontSymbol,this._fieldName=b,this._fieldIndex=-1},methods:{value:function(a,b,c){return-1==this._fieldIndex&&(this._fieldIndex=b.fieldIndex(this._fieldName)),c.valueAsString(this._fieldIndex)},fieldName:function(a){return 0==arguments.length?this._fieldName:(this._fieldName=a,void(this._fieldIndex=-1))}}}),Xr.label=Xr.label||{},Xr.label.LabelDrawer=Xr.Class({name:"LabelDrawer",construct:function(){this._svg=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"svg"),this._svg.style.position="absolute",this._svg.style.top="0px",this._svg.style.left="0px",this._svg.style.width="100%",this._svg.style.height="100%",this._svg.style.overflow="hidden",this._svg.style.setProperty("pointer-events","none"),this._mbrList=new Array},methods:{container:function(){return this._svg},clean:function(a){for(var b,c=this._svg,d=c.childNodes,e=d.length,f=e-1;f>=0;f--){b=d[f];var g=b.id;0==g.indexOf(a)&&c.removeChild(b)}},reset:function(){this._mbrList=[]},add:function(a){for(var b=this._mbrList,c=b.length,d=0;c>d;d++){var e=b[d];if(!(a.minX>e.maxX||a.minY>e.maxY||a.maxX<e.minX||a.maxY<e.minY))return!1}return b.push(a),!0},update:function(a,b,c,d){var e,f=this._svg,g=f.childNodes,h=g.length;if(b==Xr.MouseActionEnum.MOUSE_DOWN);else if(b==Xr.MouseActionEnum.MOUSE_DRAG)for(var i=0;h>i;i++)e=g[i],e.setAttribute("transform","translate("+c+","+d+")");else this.reset()}}}),Xr.symbol=Xr.symbol||{},Xr.symbol.PenSymbol=Xr.Class({name:"PenSymbol",construct:function(a){var b=a||{};this._color=b.color||"#ffffff",this._width=b.width||void 0,this._cap=b.cap||void 0,this._lineJoin=b.lineJoin||void 0,this._miterLimit=b.miterLimit||void 0,this._dash=b.dash||void 0,this._dashOffset=b.dashOffset||void 0,this._opacity=b.opacity||void 0},methods:{color:function(a){return 0==arguments.length?this._color:void(this._color=a)},width:function(a){return 0==arguments.length?this._width:void(this._width=a)},cap:function(a){return 0==arguments.length?this._cap:void(this._cap=a)},lineJoin:function(a){return 0==arguments.length?this._lineJoin:void(this._lineJoin=a)},miterLimit:function(a){return 0==arguments.length?this._miterLimit:void(this._miterLimit=a)},dash:function(a){return 0==arguments.length?this._dash:void(this._dash=a)},dashOffset:function(a){return 0==arguments.length?this._dashOffset:void(this._dashOffset=a)},getOpacity:function(a){return 0==arguments.length?this._opacity:void(this._opacity=a)},attribute:function(a){void 0!=this._color&&a.setAttribute("stroke",this._color),void 0!=this._width&&a.setAttribute("stroke-width",this._width),void 0!=this._cap&&a.setAttribute("stroke-linecap",this._cap),void 0!=this._lineJoin&&a.setAttribute("stroke-linejoin",this._lineJoin),void 0!=this._miterLimit&&a.setAttribute("stroke-miterlimit",this._miterLimit),void 0!=this._dash&&a.setAttribute("stroke-dasharray",this._dash),void 0!=this._dashOffset&&a.setAttribute("stroke-dashoffset",this._dashOffset),void 0!=this._opacity&&a.setAttribute("stroke-opacity",this._opacity)}}}),Xr.symbol=Xr.symbol||{},Xr.symbol.BrushSymbol=Xr.Class({name:"BrushSymbol",construct:function(a){var b=a||{};this._color=b.color||void 0,this._opacity=b.opacity||void 0},methods:{color:function(a){return 0==arguments.length?this._color:void(this._color=a)},opacity:function(a){return 0==arguments.length?this._opacity:void(this._opacity=a)},attribute:function(a){void 0!=this._opacity&&0==this._opacity?this._color&&a.setAttribute("fill","none"):(this._color&&a.setAttribute("fill",this._color),this._opacity&&a.setAttribute("fill-opacity",this._opacity))}}}),Xr.symbol=Xr.symbol||{},Xr.symbol.FontSymbol=Xr.Class({name:"FontSymbol",construct:function(a){var b=a||{};this._fontFamily=b.fontFamily||void 0,this._size=b.size||12,this._color=b.color||16777215,this._weight=b.weight||void 0,this._strokeColor=b.strokeColor||void 0,this._strokeWidth=b.strokeWidth||3,this._strokeLineCap=b.strokeLineCap||void 0,this._strokeLineJoin=b.strokeLineJoin||void 0,this._strokeOpacity=b.strokeOpacity||1},methods:{fontFamily:function(a){return 0==arguments.length?this._fontFamily:void(this._fontFamily=a)},size:function(a){return 0==arguments.length?this._size:void(this._size=a)},color:function(a){return 0==arguments.length?this._color:void(this._color=a)},weight:function(a){return 0==arguments.length?this._weight:void(this._weight=a)},strokeColor:function(a){return 0==arguments.length?this._strokeColor:void(this._strokeColor=a)},strokeOpacity:function(a){return 0==arguments.length?this._strokeOpacity:void(this._strokeOpacity=a)},strokeWidth:function(a){return 0==arguments.length?this._strokeWidth:void(this._strokeWidth=a)},strokeLineJoin:function(a){0==arguments.length?this._strokeLineJoin:this._strokeLineJoin=a},strokeOpacity:function(a){return 0==arguments.length?this._strokeOpacity:void(this._strokeOpacity=a)},attributeForStroke:function(a){this._fontFamily&&a.setAttribute("font-family",this._fontFamily),a.setAttribute("font-size",this._size),this._weight&&a.setAttribute("font-weight",this._weight),this._strokeColor&&a.setAttribute("stroke",this._strokeColor),this._strokeWidth&&a.setAttribute("stroke-width",this._strokeWidth),this._strokeLineCap&&a.setAttribute("stroke-linecap",this._strokeLineCap),this._strokeLineJoin&&a.setAttribute("stroke-linejoin",this._strokeLineJoin),a.setAttribute("stroke-opacity",this._strokeOpacity)},attribute:function(a){this._fontFamily&&a.setAttribute("font-family",this._fontFamily),a.setAttribute("font-size",this._size),this._weight&&a.setAttribute("font-weight",this._weight),a.setAttribute("fill",this._color)},needStroke:function(){return void 0!=this._strokeColor}}}),Xr.symbol=Xr.symbol||{},Xr.symbol.ShapeDrawSymbol=Xr.Class({name:"ShapeDrawSymbol",construct:function(){this._brushSymbol=new Xr.symbol.BrushSymbol,this._penSymbol=new Xr.symbol.PenSymbol,this._markerSymbol=new Xr.symbol.RectangleMarkerSymbol(this._penSymbol,this._brushSymbol)},methods:{brushSymbol:function(){return this._brushSymbol},penSymbol:function(){return this._penSymbol},markerSymbol:function(){return this._markerSymbol},attribute:function(a){this._brushSymbol.attribute(a),this._penSymbol.attribute(a)}}}),Xr.symbol=Xr.symbol||{},Xr.symbol.IMarkerSymbol=Xr.Class({name:"IMarkerSymbol",methods:{create:function(){return null},width:function(){return 0},height:function(){return 0}}}),Xr.symbol=Xr.symbol||{},Xr.symbol.RectangleMarkerSymbol=Xr.Class({name:"RectangleMarkerSymbol",requires:[Xr.symbol.IMarkerSymbol],construct:function(a,b,c){c=c||{},this._penSymbol=a||new Xr.symbol.PenSymbol,this._brushSymbol=b||new Xr.symbol.BrushSymbol,this._width=c.width||12,this._height=c.height||12},methods:{create:function(a,b){var c=Xr.CommonStrings.SVG_NAMESPACE,d=document.createElementNS(c,"rect"),e=b.W2V(a);return d.setAttribute("x",e.x-this._width/2),d.setAttribute("y",e.y-this._height/2),d.setAttribute("width",this._width),d.setAttribute("height",this._height),this.penSymbol().attribute(d),this.brushSymbol().attribute(d),d},penSymbol:function(){return this._penSymbol},brushSymbol:function(){return this._brushSymbol},width:function(){return this._width},height:function(){return this._height}}}),Xr.symbol=Xr.symbol||{},Xr.symbol.CircleMarkerSymbol=Xr.Class({name:"CircleMarkerSymbol",requires:[Xr.symbol.IMarkerSymbol],construct:function(a,b,c){c=c||{},this._penSymbol=a||new Xr.symbol.PenSymbol,this._brushSymbol=b||new Xr.symbol.BrushSymbol,this._radius=c.radius||5},methods:{create:function(a,b){var c=Xr.CommonStrings.SVG_NAMESPACE,d=document.createElementNS(c,"circle"),e=b.W2V(a);return d.setAttribute("cx",e.x),d.setAttribute("cy",e.y),d.setAttribute("r",this._radius),this.penSymbol().attribute(d),this.brushSymbol().attribute(d),d},penSymbol:function(){return this._penSymbol},brushSymbol:function(){return this._brushSymbol},width:function(){return 2*this._radius},height:function(){return 2*this._radius}}}),Xr.symbol=Xr.symbol||{},Xr.symbol.ImageMarkerSymbol=Xr.Class({name:"ImageMarkerSymbol",requires:[Xr.symbol.IMarkerSymbol],construct:function(a){if(a=a||{},!a.url)throw new Error("ImageMarkerSymbol requires url option.");this._url=a.url,this._width=a.width||64,this._height=a.height||64},methods:{create:function(a,b){var c=Xr.CommonStrings.SVG_NAMESPACE,d=document.createElementNS(c,"image"),e=b.W2V(a);return d.setAttribute("x",e.x-this._width/2),d.setAttribute("y",e.y-this._height/2),d.setAttribute("width",this._width),d.setAttribute("height",this._height),d.setAttributeNS("http://www.w3.org/1999/xlink","href",this._url),d},width:function(){return this._width},height:function(){return this._height}}}),Xr.theme=Xr.theme||{},Xr.theme.IShapeDrawTheme=Xr.Class({name:"IShapeDrawTheme",methods:{symbol:function(){return null},needAttribute:function(){}}}),Xr.theme=Xr.theme||{},Xr.theme.ProgrammableShapeDrawTheme=Xr.Class({name:"ProgrammableShapeDrawTheme",construct:function(a){this._shapeMapLayer=a},methods:{layer:function(){return this._shapeMapLayer}}}),Xr.theme=Xr.theme||{},Xr.theme.SimpleShapeDrawTheme=Xr.Class({name:"SimpleShapeDrawTheme",extend:Xr.theme.ProgrammableShapeDrawTheme,requires:[Xr.theme.IShapeDrawTheme],construct:function(a){this.superclass(a),this._symbol=new Xr.symbol.ShapeDrawSymbol},methods:{symbol:function(){return this._symbol},penSymbol:function(){return this._symbol.penSymbol()},brushSymbol:function(){return this._symbol.brushSymbol()},makerSymbol:function(){return this._symbol.markerSymbol()},needAttribute:function(){return!1}}}),Xr.theme=Xr.theme||{},Xr.theme.ILabelDrawTheme=Xr.Class({name:"ILabelDrawTheme",methods:{symbol:function(){return null}}}),Xr.theme=Xr.theme||{},Xr.theme.ProgrammableLabelDrawTheme=Xr.Class({name:"ProgrammableLabelDrawTheme",construct:function(a){this._shapeMapLayer=a},methods:{layer:function(){return this._shapeMapLayer}}}),Xr.theme=Xr.theme||{},Xr.theme.SimpleLabelDrawTheme=Xr.Class({name:"SimpleLabelDrawTheme",extend:Xr.theme.ProgrammableLabelDrawTheme,requires:[Xr.theme.ILabelDrawTheme],construct:function(a){this.superclass(a),this._symbol=new Xr.symbol.FontSymbol
},methods:{symbol:function(){return this._symbol}}});var version="Matrix 1.01",Matrix=new createMatrixPackage,version="IOUtils 1.01",IOUtils={version:version},_outputObj,_outputBuffer,LFT='<span style="white-space: pre; font-family: monospace">',RGT="</span>",print=write,println=writeln,_rowStarted=!1;Number.prototype.fixed=function(a,b){for(var c=this.toFixed(b),d="",e=0;e<a-c.length;e++)d+=" ";return d+c};var version="EVDecomposition 1.00",EVDecomposition=new createEVDecompositionPackage,version="LUDecomposition 1.00",LUDecomposition=new createLUDecompositionPackage;Xr.data=Xr.data||{},Xr.data.ShapeType=Xr.Class({name:"ShapeType",statics:{POINT:0,POLYLINE:1,POLYGON:2,CIRCLE:3,ELLIPSE:4,RECTANGLE:5,TEXT:6}}),Xr.data=Xr.data||{},Xr.data.ShapeRow=Xr.Class({name:"ShapeRow",construct:function(a,b){this._fid=a,this._shapeData=b},methods:{fid:function(){return this._fid},shapeData:function(){return this._shapeData}}}),Xr.data=Xr.data||{},Xr.data.ShapeRowSet=Xr.Class({name:"ShapeRowSet",construct:function(a){this._rows=new Object,this._shapeType=a},methods:{add:function(a){var b=a.fid();return void 0!=this._rows[b]?!1:(this._rows[b]=a,!0)},remove:function(a){void 0!=this._rows[a]&&delete this._rows[a]},row:function(a){return this._rows[a]},reset:function(){for(var a in this._rows)delete this._rows[a]},rows:function(){return this._rows},shapeType:function(){return this._shapeType}}}),Xr.data=Xr.data||{},Xr.data.IShapeData=Xr.Class({name:"IShapeData",methods:{data:function(){},MBR:function(){},representativePoint:function(){},clone:function(){},type:function(){},hitTest:function(){},toSketch:function(){},toWKT:function(){},fromWKT:function(){},moveByOffset:function(){},moveControlPointByOffset:function(){},updateControlPoint:function(){},removeVertex:function(){},insertVertex:function(){},insertPart:function(){},removePart:function(){}}}),Xr.data=Xr.data||{},Xr.data.IShapeRow=Xr.Class({name:"IShapeRow",methods:{createSVG:function(){return null},shapeData:function(){return null}}}),Xr.data=Xr.data||{},Xr.data.PolygonShapeData=Xr.Class({name:"PolygonShapeData",requires:[Xr.data.IShapeData,Xr.edit.ISnap],construct:function(a){a instanceof Xr.MBR?(this._polygons=new Array,this._mbr=a):a instanceof Array&&(this._polygons=a,this._regenMBR())},methods:{hitTest:function(a,b,c){for(var d=c.V2W(a,b),e=this.data(),f=e.length,g=0,h=0;f>h;++h){var i=e[h];Xr.GeometryHelper.pointInPolygon(i,d)&&g++}return g%2==1?!0:!1},clone:function(){for(var a=new Array,b=this._polygons.length,c=0;b>c;c++){for(var d=this._polygons[c],e=new Array,f=(d.length,0);f<d.length;f++){var g=d[f],h=new Xr.PointD(g.x,g.y);e[f]=h}a[c]=e}var i=new Xr.data.PolygonShapeData(a);return i},data:function(){return this._polygons},MBR:function(){return this._mbr},_regenMBR:function(){void 0==this._mbr&&(this._mbr=new Xr.MBR);var a=this._mbr;a.reset();for(var b=this._polygons,c=b.length,d=0;c>d;++d)for(var e=b[d],f=e.length,g=0;f>g;++g){var h=e[g];a.append(h)}},representativePoint:function(){return Xr.GeometryHelper.centroidOfPolygon(this._polygons[0])},type:function(){return"POLYGON"},toSketch:function(a,b){var c=new Xr.edit.PolygonSketch(a,this,b,!1);return c},moveByOffset:function(a,b){for(var c=this._polygons,d=c.length,e=0;d>e;++e)for(var f=c[e],g=f.length,h=0;g>h;++h)f[h].add(a,b);this._mbr.moveByOffset(a,b)},updateControlPoint:function(a,b,c,d){var e=this._polygons,f=e[a];d&&d.set(f[b].x,f[b].y),f[b].set(c.x,c.y),this._regenMBR()},moveControlPointByOffset:function(a,b,c,d){var e=this._polygons,f=e[a];f[b].add(c,d),this._regenMBR()},removeVertex:function(a,b){var c=this._polygons,d=c[a],e=d[b];return d.splice(b,1),e},insertVertex:function(a,b,c){var d=this._polygons;if(void 0==d)return!1;var e=d[a];return void 0==e?!1:(e.splice(b,0,c),!0)},insertPart:function(a,b){var c=this._polygons;if(void 0==c)return!1;var d=-1==a?c.length:a;return c.splice(d,0,b),!0},removePart:function(a){var b=this._polygons,c=-1==a?b.length-1:a,d=b[c];return b.splice(c,1),d},vertexSnap:function(a,b){if(this.MBR().contain(a,b))for(var c=this._polygons,d=c.length,e=0;d>e;++e)for(var f=c[e],g=f.length,h=0;g>h;++h){var i=f[h];if(Xr.GeometryHelper.pointIn(i.x,i.y,b,a))return i}return void 0},edgeSnap:function(a,b){if(this.MBR().contain(a,b))for(var c=this._polygons,d=c.length,e=0;d>e;e++){polygon=c[e];for(var f=polygon.length-1,g=0;f>g;g++){var h=polygon[g],i=polygon[g+1],j=Xr.GeometryHelper.intersectPointFromLine(h,i,a,b);if(j)return j}if(j=Xr.GeometryHelper.intersectPointFromLine(polygon[0],polygon[f],a,b))return j}return void 0},toWKT:function(a){for(var b=this._polygons.length,c="",d=0;b>d;++d){for(var e=this._polygons[d],f=e.length,g="((",h=e[0].x==e[f-1].x&&e[0].y==e[f-1].y,i=0;f>i;++i){var j=e[i];g+=i!=f-1?j.x+" "+j.y+",":h?j.x+" "+j.y+"))":j.x+" "+j.y+","+e[0].x+" "+e[0].y+"))"}c+=d!=b-1?g+",":g}return c=a?"MULTIPOLYGON("+c+")":"POLYGON"+c},fromWKT:function(a){a=a.toLowerCase(),a=a.replace("multipolygon",""),a=a.replace("polygon",""),a=a.replace(/ +/g," "),a=a.replace(/\) {0,}, {0,}\(/g,"|"),a=a.replace(/\(|\)/g,"");for(var b=a.split("|"),c=b.length,d=new Array,e=0;c>e;e++){for(var f=b[e].trim().split(","),g=f.length,h=new Array,i=0;g>i;i++){var j=f[i].trim().split(" ");h.push(new Xr.PointD(parseFloat(j[0]),parseFloat(j[1])))}d.push(h)}return this._polygons=d,!0}}}),Xr.data=Xr.data||{},Xr.data.RectangleShapeData=Xr.Class({name:"RectangleShapeData",requires:[Xr.data.IShapeData,Xr.edit.ISnap],construct:function(a){this._data=a,this._data.valid()},methods:{hitTest:function(a,b,c){var d=this.data(),e=c.V2W(a,b);return Xr.GeometryHelper.pointInMBR(d,e,0)},clone:function(){var a=new Xr.data.RectangleShapeData(this._data.clone());return a},data:function(){return this._data},MBR:function(){return this._data},representativePoint:function(){return new Xr.PointD(_data.centerX(),_data.centerY())},type:function(){return"RECTANGLE"},toSketch:function(a,b){var c=new Xr.edit.RectangleSketch(a,this,b,!1);return c},moveByOffset:function(a,b){this._data.moveByOffset(a,b)},_getControlPointIndexFromPt:function(a,b){var c=this._data;return a==c.minX&&b==c.maxY?0:a==c.centerX()&&b==c.maxY?1:a==c.maxX&&b==c.maxY?2:a==c.maxX&&b==c.centerY()?3:a==c.maxX&&b==c.minY?4:a==c.centerX()&&b==c.minY?5:a==c.minX&&b==c.minY?6:a==c.minX&&b==c.centerY()?7:void 0},updateControlPoint:function(a,b,c,d){var e,f,g=this._data;return 0==b?(d&&d.set(g.minX,g.maxY),g.minX=c.x,g.maxY=c.y,e=g.minX,f=g.maxY):1==b?(d&&d.set(g.centerX(),g.maxY),g.maxY=c.y,e=g.centerX(),f=g.maxY):2==b?(d&&d.set(g.maxX,g.maxY),g.maxX=c.x,g.maxY=c.y,e=g.maxX,f=g.maxY):3==b?(d&&d.set(g.maxX,g.centerY),g.maxX=c.x,e=g.maxX,f=g.centerY()):4==b?(d&&d.set(g.maxX,g.minY),g.maxX=c.x,g.minY=c.y,e=g.maxX,f=g.minY):5==b?(d&&d.set(g.centerX,g.minY),g.minY=c.y,e=g.centerX(),f=g.minY):6==b?(d&&d.set(g.minX,g.minY),g.minX=c.x,g.minY=c.y,e=g.minX,f=g.minY):7==b&&(d&&d.set(g.minX,g.centerY),g.minX=c.x,e=g.minX,f=g.centerY()),this._data.valid(),this._getControlPointIndexFromPt(e,f)},moveControlPointByOffset:function(a,b,c,d){var e,f,g=this._data;return 0==b?(g.minX+=c,g.maxY+=d,e=g.minX,f=g.maxY):1==b?(g.maxY+=d,e=g.centerX(),f=g.maxY):2==b?(g.maxX+=c,g.maxY+=d,e=g.maxX,f=g.maxY):3==b?(g.maxX+=c,e=g.maxX,f=g.centerY()):4==b?(g.maxX+=c,g.minY+=d,e=g.maxX,f=g.minY):5==b?(g.minY+=d,e=g.centerX(),f=g.minY):6==b?(g.minX+=c,g.minY+=d,e=g.minX,f=g.minY):7==b&&(g.minX+=c,e=g.minX,f=g.centerY()),this._data.valid(),this._getControlPointIndexFromPt(e,f)},removeVertex:function(){},insertVertex:function(){},insertPart:function(){},removePart:function(){},vertexSnap:function(a,b){var c=void 0,d=this._data;return c=new Xr.PointD(d.minX,d.maxY),Xr.GeometryHelper.pointIn(c.x,c.y,b,a)?c:(c=new Xr.PointD(d.centerX(),d.maxY),Xr.GeometryHelper.pointIn(c.x,c.y,b,a)?c:(c=new Xr.PointD(d.maxX,d.maxY),Xr.GeometryHelper.pointIn(c.x,c.y,b,a)?c:(c=new Xr.PointD(d.maxX,d.centerY()),Xr.GeometryHelper.pointIn(c.x,c.y,b,a)?c:(c=new Xr.PointD(d.maxX,d.minY),Xr.GeometryHelper.pointIn(c.x,c.y,b,a)?c:(c=new Xr.PointD(d.centerX(),d.minY),Xr.GeometryHelper.pointIn(c.x,c.y,b,a)?c:(c=new Xr.PointD(d.minX,d.minY),Xr.GeometryHelper.pointIn(c.x,c.y,b,a)?c:(c=new Xr.PointD(d.minX,d.centerY()),Xr.GeometryHelper.pointIn(c.x,c.y,b,a)?c:void 0)))))))},edgeSnap:function(a,b){var c=this._data,d=new Xr.PointD(c.minX,c.minY),e=new Xr.PointD(c.maxX,c.minY),f=new Xr.PointD(c.minX,c.maxY),g=new Xr.PointD(c.maxX,c.maxY),h=void 0;return(h=Xr.GeometryHelper.intersectPointFromLine(d,e,a,b))?h:(h=Xr.GeometryHelper.intersectPointFromLine(d,f,a,b))?h:(h=Xr.GeometryHelper.intersectPointFromLine(g,f,a,b))?h:(h=Xr.GeometryHelper.intersectPointFromLine(g,e,a,b),h?h:void 0)},toWKT:function(){return void 0},fromWKT:function(){return!1}}}),Xr.data=Xr.data||{},Xr.data.EllipseShapeData=Xr.Class({name:"EllipseShapeData",requires:[Xr.data.IShapeData,Xr.edit.ISnap],construct:function(a){a instanceof Xr.MBR?(this._mbr=a,this._data={cx:a.centerX(),cy:a.centerY(),rx:a.width()/2,ry:a.height()/2}):(this._data=a,this._mbr=new Xr.MBR(a.cx-a.rx,a.cy-a.ry,a.cx+a.rx,a.cy+a.ry))},methods:{hitTest:function(a,b,c){var d=c.V2W(a,b),e=this.data(),f=e.cx,g=e.cy,h=e.rx,i=e.ry,j=Math.pow(d.x-f,2)/(h*h)+Math.pow(d.y-g,2)/(i*i);return 1>=j},clone:function(){this._regenMBR();var a=new Xr.MBR(this._mbr.minX,this._mbr.minY,this._mbr.maxX,this._mbr.maxY),b=new Xr.data.EllipseShapeData(a);return b},data:function(){return this._data},_regenMBR:function(){var a=this._data;this._mbr.set(a.cx-a.rx,a.cy-a.ry,a.cx+a.rx,a.cy+a.ry)},MBR:function(){return this._mbr},representativePoint:function(){return new Xr.PointD(_mbr.centerX(),_mbr.centerY())},type:function(){return"ELLIPSE"},toSketch:function(a,b){var c=new Xr.edit.EllipseSketch(a,this,b,!1);return c},moveByOffset:function(a,b){this._data.cx+=a,this._data.cy+=b,this._mbr.moveByOffset(a,b)},updateControlPoint:function(a,b,c,d){var e=this._data;d&&(d.x=e.rx,d.y=e.ry),0==b?(e.rx=c.x,e.ry=c.y):1==b?e.ry=c.y:2==b?(e.rx=c.x,e.ry=c.y):3==b?e.rx=c.x:4==b?(e.rx=c.x,e.ry=c.y):5==b?e.ry=c.y:6==b?(e.rx=c.x,e.ry=c.y):7==b&&(e.rx=c.x),this._regenMBR()},moveControlPointByOffset:function(a,b,c,d){var e=this._data;0==b?(e.rx-=c,e.ry+=d):1==b?e.ry+=d:2==b?(e.rx+=c,e.ry+=d):3==b?e.rx+=c:4==b?(e.rx+=c,e.ry-=d):5==b?e.ry-=d:6==b?(e.rx-=c,e.ry-=d):7==b&&(e.rx-=c),this._regenMBR()},removeVertex:function(){},insertVertex:function(){},insertPart:function(){},removePart:function(){},vertexSnap:function(a,b){var c=this._data,d=c.cx-c.rx,e=c.cy-c.ry,f=c.cx+c.rx,g=c.cy+c.ry;return pt=new Xr.PointD((d+f)/2,g),Xr.GeometryHelper.pointIn(pt.x,pt.y,b,a)?pt:(pt=new Xr.PointD(f,(e+g)/2),Xr.GeometryHelper.pointIn(pt.x,pt.y,b,a)?pt:(pt=new Xr.PointD((d+f)/2,e),Xr.GeometryHelper.pointIn(pt.x,pt.y,b,a)?pt:(pt=new Xr.PointD(d,(e+g)/2),Xr.GeometryHelper.pointIn(pt.x,pt.y,b,a)?pt:void 0)))},edgeSnap:function(a,b){var c=this._data,d=new Xr.PointD(c.cx,c.cy),e=Xr.GeometryHelper.angle(d,a)*(Math.PI/180),f=new Xr.PointD(c.cx+c.rx*Math.cos(e),c.cy+c.ry*Math.sin(e));return f.distanceFrom(a)<b?f:void 0},toWKT:function(){return void 0},fromWKT:function(){return!1}}}),Xr.data=Xr.data||{},Xr.data.PolylineShapeData=Xr.Class({name:"PolylineShapeData",requires:[Xr.data.IShapeData,Xr.edit.ISnap],construct:function(a){a instanceof Xr.MBR?(this._polylines=new Array,this._mbr=mbr):a instanceof Array&&(this._polylines=a,this._regenMBR())},methods:{hitTest:function(a,b,c){for(var d=c.V2W(a,b),e=this.data(),f=e.length,g=c.pickingTolerance(),h=0;f>h;++h){var i=e[h];if(Xr.GeometryHelper.pointInPolyline(i,d,g))return!0}return!1},clone:function(){for(var a=new Array,b=this._polylines.length,c=0;b>c;c++){for(var d=this._polylines[c],e=new Array,f=(d.length,0);f<d.length;f++){var g=d[f],h=new Xr.PointD(g.x,g.y);e[f]=h}a[c]=e}var i=new Xr.data.PolylineShapeData(a);return i},data:function(){return this._polylines},MBR:function(){return this._mbr},_regenMBR:function(){var a=new Xr.MBR;a.reset();for(var b=this._polylines,c=b.length,d=0;c>d;++d)for(var e=b[d],f=e.length,g=0;f>g;++g){var h=e[g];a.append(h)}this._mbr=a},representativePoint:function(){return Xr.GeometryHelper.centroidOfPolyline(this._polylines[0])},type:function(){return"POLYLINE"},toSketch:function(a,b){var c=new Xr.edit.PolylineSketch(a,this,b,!1);return c},moveByOffset:function(a,b){for(var c=this._polylines,d=c.length,e=0;d>e;++e)for(var f=c[e],g=f.length,h=0;g>h;++h)f[h].add(a,b);this._mbr.moveByOffset(a,b)},updateControlPoint:function(a,b,c,d){var e=this._polylines,f=e[a];d&&d.set(f[b].x,f[b].y),f[b].set(c.x,c.y),this._regenMBR()},moveControlPointByOffset:function(a,b,c,d){var e=this._polylines,f=e[a];f[b].add(c,d),this._regenMBR()},removeVertex:function(a,b){var c=this._polylines,d=c[a],e=d[b];return d.splice(b,1),e},insertVertex:function(a,b,c){var d=this._polylines;if(void 0==d)return!1;var e=d[a];return void 0==e?!1:(e.splice(b,0,c),!0)},insertPart:function(a,b){var c=this._polylines;if(void 0==c)return!1;var d=-1==a?c.length:a;c.splice(d,0,b)},removePart:function(a){var b=this._polylines,c=-1==a?b.length-1:a,d=b[c];return b.splice(c,1),d},vertexSnap:function(a,b){if(this.MBR().contain(a,b))for(var c=this._polylines,d=c.length,e=0;d>e;++e)for(var f=c[e],g=f.length,h=0;g>h;++h){var i=f[h];if(Xr.GeometryHelper.pointIn(i.x,i.y,b,a))return i}return void 0},edgeSnap:function(a,b){if(this.MBR().contain(a,b))for(var c=this._polylines,d=c.length,e=0;d>e;e++){polyline=c[e];for(var f=polyline.length-1,g=0;f>g;g++){var h=polyline[g],i=polyline[g+1],j=Xr.GeometryHelper.intersectPointFromLine(h,i,a,b);if(j)return j}}return void 0},toWKT:function(a){for(var b=this._polylines.length,c="",d=0;b>d;++d){for(var e=this._polylines[d],f=e.length,g="(",h=0;f>h;++h){var i=e[h];g+=h!=f-1?i.x+" "+i.y+",":i.x+" "+i.y+")"}c+=d!=b-1?g+",":g}return c=a?"MULTILINESTRING("+c+")":"LINESTRING"+c},fromWKT:function(){return!1}}}),Xr.data=Xr.data||{},Xr.data.PointShapeData=Xr.Class({name:"PointShapeData",requires:[Xr.data.IShapeData,Xr.edit.ISnap],construct:function(a){a instanceof Xr.MBR?(this._mbr=a,this._point=new Xr.PointD(a.minX,a.minY)):a instanceof Xr.PointD&&(this._mbr=new Xr.MBR(a.x,a.y,a.x,a.y),this._point=new Xr.PointD(a.x,a.y))},methods:{hitTest:function(a,b,c){var d=this.data(),e=c.V2W(a,b),f=c.pickingTolerance(),g=Math.sqrt(Math.pow(d.x-e.x,2)+Math.pow(d.y-e.y,2));return f>=g},clone:function(){var a=new Xr.PointD(this._point.x,this._point.y),b=new Xr.data.PointShapeData(a);return b},data:function(){return this._point},MBR:function(){return this._mbr},representativePoint:function(){return this._point},type:function(){return"POINT"},toSketch:function(a,b){var c=new Xr.edit.PointSketch(a,this,b,!1);return c},moveByOffset:function(a,b){this._point.add(a,b),this._mbr.moveByOffset(a,b)},updateControlPoint:function(a,b,c,d){d&&d.set(this._point.x,this._point.y),this._point.set(c.x,c.y),this._mbr.set(c.x,c.y,c.x,c.y)},moveControlPointByOffset:function(){},removeVertex:function(){},insertVertex:function(){},insertPart:function(){},removePart:function(){},vertexSnap:function(a,b){var c=this._point;return Xr.GeometryHelper.pointIn(c.x,c.y,b,a)?c:void 0},edgeSnap:function(){return void 0},toWKT:function(a){var b="("+this._point.x+" "+this._point.y+")";return b=a?"MULTIPOINT("+b+")":"POINT"+b},fromWKT:function(){return!1}}}),Xr.data=Xr.data||{},Xr.data.TextShapeData=Xr.Class({name:"TextShapeData",requires:[Xr.data.IShapeData,Xr.edit.ISnap],construct:function(a){this._data=a,this._mbr=new Xr.MBR},methods:{hitTest:function(a,b,c){var d=this.MBR(),e=c.V2W(a,b);return Xr.GeometryHelper.pointInMBR(d,e,0)},clone:function(){var a={x:this._data.x,y:this._data.y,text:this._data.text},b=new Xr.MBR(this._mbr.minX,this._mbr.minY,this._mbr.maxX,this._mbr.maxY),c=new Xr.data.TextShapeData(a);return c._mbr=b,c},data:function(){return this._data},MBR:function(){return this._mbr},representativePoint:function(){return new Xr.PointD(_mbr.centerX(),_mbr.centerY())},type:function(){return"TEXT"},toSketch:function(a,b){var c=new Xr.edit.TextSketch(a,this,b,!1);return c},moveByOffset:function(a,b){this._data.x+=a,this._data.y+=b,this._mbr.moveByOffset(a,b)},updateControlPoint:function(a,b,c,d){var e=c.x-this._data.x,f=c.y-this._data.y;d&&d.set(this._data.x,this._data.y),this._data.x=c.x,this._data.y=c.y,this._mbr.moveByOffset(e,f)},moveControlPointByOffset:function(){},removeVertex:function(){},insertVertex:function(){},insertPart:function(){},removePart:function(){},vertexSnap:function(a,b){var c=new Xr.PointD(this._data.x,this._data.y);return Xr.GeometryHelper.pointIn(c.x,c.y,b,a)?c:void 0},edgeSnap:function(){return void 0},toWKT:function(){return void 0},fromWKT:function(){return!1}}}),Xr.data=Xr.data||{},Xr.data.FieldType=Xr.Class({name:"FieldTypeType",statics:{INTEGER:0,SHORT:1,VERYSHORT:2,FLOAT:3,DOUBLE:4,STRING:5}}),Xr.data=Xr.data||{},Xr.data.AttributeRowSet=Xr.Class({name:"AttributeRowSet",construct:function(a){this._rows=new Object,this._rowsCount=0,this._fieldSet=a},methods:{add:function(a){var b=a.fid();return void 0!=this._rows[b]?!1:(this._rows[b]=a,this._rowsCount++,!0)},remove:function(a){void 0!=this._rows[a]&&(delete this._rows[a],this._rowsCount--)},row:function(a){return this._rows[a]},count:function(){return this._rowsCount},reset:function(){for(var a in this._rows)delete this._rows[a];this._rowsCount=0},rows:function(){return this._rows},fieldSet:function(){return this._fieldSet}}}),Xr.data=Xr.data||{},Xr.data.FieldSet=Xr.Class({name:"FieldSet",construct:function(){this._fields=new Array,this._fieldTypes=new Array},methods:{add:function(a){var b=this._fields.length;this._fields[b]=a,this._fieldTypes[b]=a.type()},field:function(a){return this._fields[a]},count:function(){return this._fields.length},size:function(){return this._fields.length},length:function(){return this._fields.length},fieldName:function(a){return this._fields[a].name()},fieldIndex:function(a){for(var b=this._fields.length,c=0;b>c;c++){var d=this.field(c),e=d.name();if(e==a)return c}return-1},fieldType:function(a){for(var b=this._fields.length,c=0;b>c;c++){var d=this.field(c),e=d.type(),f=d.name();if(f==a)return e}return void 0},fieldTypes:function(){return this._fieldTypes}}}),Xr.data=Xr.data||{},Xr.data.Field=Xr.Class({name:"Field",construct:function(a,b){this._fieldName=a,this._fieldType=b},methods:{name:function(){return this._fieldName},type:function(){return this._fieldType}}}),Xr.data=Xr.data||{},Xr.data.AttributeRow=Xr.Class({name:"AttributeRow",construct:function(a,b){this._fid=a,this._values=new Array(b)},methods:{fid:function(){return this._fid},valueAsString:function(a){return this._values[a]},valueAsInteger:function(a){return parseInt(this._values[a])},valueAsFloat:function(a){return parseFloat(this._values[a])},setValue:function(a,b){this._values[a]=b},createSVG:function(a,b,c,d){var e=Xr.CommonStrings.SVG_NAMESPACE,f=b.shapeData(),g=f.representativePoint(),h=a.W2V(g),i=document.createElementNS(e,"g"),j=void 0;d.needStroke()&&(j=document.createElementNS(e,"text"),j.setAttribute("x",h.x),j.setAttribute("y",h.y),j.setAttribute("text-anchor","middle"),d.attributeForStroke(j),j.textContent=c);var k=document.createElementNS(e,"text");if(k.setAttribute("x",h.x),k.setAttribute("y",h.y),k.setAttribute("text-anchor","middle"),d.attribute(k),k.textContent=c,void 0!=j){var l=document.createElementNS(e,"filter");l.setAttribute("id","_fe_labelBlur");var m=document.createElementNS(e,"feGaussianBlur");m.setAttribute("stdDeviation","1.5"),l.appendChild(m),i.appendChild(l),j.setAttribute("filter","url(#_fe_labelBlur)"),i.appendChild(j)}return i.appendChild(k),i}}}),Xr.data=Xr.data||{},Xr.data.GraphicRowSet=Xr.Class({name:"GraphicRowSet",construct:function(a){this._rows=new Object,this._layer=a},methods:{add:function(a){var b=a.id();return void 0!=this._rows[b]?!1:(this._rows[b]=a,!0)},remove:function(a){return void 0!=this._rows[a]?(delete this._rows[a],!0):void 0},row:function(a){this._rows;return this._rows[a]},reset:function(){for(var a in this._rows)delete this._rows[a]},rows:function(){return this._rows}}}),Xr.data=Xr.data||{},Xr.data.PointShapeRow=Xr.Class({name:"PointShapeRow",extend:Xr.data.ShapeRow,requires:[Xr.data.IShapeRow],construct:function(a,b){Xr.data.ShapeRow.call(this,a,b)},methods:{createSVG:function(a,b,c){var d=this.shapeData().data();return c.markerSymbol().create(d,a)}}}),Xr.data=Xr.data||{},Xr.data.PolygonShapeRow=Xr.Class({name:"PolygonShapeRow",extend:Xr.data.ShapeRow,requires:[Xr.data.IShapeRow],construct:function(a,b){Xr.data.ShapeRow.call(this,a,b)},methods:{createSVG:function(a,b,c){for(var d=Xr.CommonStrings.SVG_NAMESPACE,e=this.shapeData().data(),f=e.length,g="",h=0;f>h;++h){for(var i=e[h],j=i.length,k=0;j>k;++k){var l=i[k],m=a.W2V(l);g+=0==k?" M "+m.x+" "+m.y:" L "+m.x+" "+m.y}g+=" Z"}var n=document.createElementNS(d,"path");return n.setAttribute("d",g),n.setAttribute("fill-rule","evenodd"),c.attribute(n),n}}}),Xr.data=Xr.data||{},Xr.data.PolylineShapeRow=Xr.Class({name:"PolylineShapeRow",extend:Xr.data.ShapeRow,requires:[Xr.data.IShapeRow],construct:function(a,b){Xr.data.ShapeRow.call(this,a,b)},methods:{createSVG:function(a,b,c){for(var d=Xr.CommonStrings.SVG_NAMESPACE,e=this.shapeData().data(),f=e.length,g=document.createElementNS(d,"g"),h=0;f>h;++h){for(var i=document.createElementNS(d,"polyline"),j="",k=e[h],l=k.length,m=0;l>m;++m){var n=k[m],o=a.W2V(n);j+=o.x+","+o.y+" "}i.setAttribute("points",j),g.appendChild(i)}return g.style.fill="none",c.penSymbol().attribute(g),g}}}),Xr.data=Xr.data||{},Xr.data.IGraphicRow=Xr.Class({name:"IGraphicRow",methods:{createSVG:function(){},graphicData:function(){}}}),Xr.data=Xr.data||{},Xr.data.GraphicRow=Xr.Class({name:"GraphicRow",construct:function(a,b){this._id=a,this._graphicData=b},methods:{id:function(){return this._id},graphicData:function(){return this._graphicData},MBR:function(){return this._graphicData.MBR()},hitTest:function(a,b,c){return this.graphicData().hitTest(a,b,c)}}}),Xr.data=Xr.data||{},Xr.data.PointGraphicRow=Xr.Class({name:"PointGraphicRow",extend:Xr.data.GraphicRow,requires:[Xr.data.IGraphicRow,Xr.IHitTest],construct:function(a,b){Xr.data.GraphicRow.call(this,a,b.clone());var c=new Xr.symbol.PenSymbol,d=new Xr.symbol.BrushSymbol;this._markerSymbol=new Xr.symbol.RectangleMarkerSymbol(c,d)},methods:{markerSymbol:function(a){return 1!=arguments.length?this._markerSymbol:void(this._markerSymbol=a)},createSVG:function(a){var b=this.graphicData().data();return this._markerSymbol.create(b,a)}}}),Xr.data=Xr.data||{},Xr.data.PolylineGraphicRow=Xr.Class({name:"PolylineGraphicRow",extend:Xr.data.GraphicRow,requires:[Xr.data.IGraphicRow,Xr.IHitTest],construct:function(a,b){Xr.data.GraphicRow.call(this,a,b.clone()),this._penSymbol=new Xr.symbol.PenSymbol},methods:{penSymbol:function(a){return 1!=arguments.length?this._penSymbol:void(this._penSymbol=a)},createSVG:function(a){for(var b=Xr.CommonStrings.SVG_NAMESPACE,c=this.graphicData().data(),d=c.length,e=document.createElementNS(b,"g"),f=0;d>f;++f){for(var g=document.createElementNS(b,"polyline"),h="",i=c[f],j=i.length,k=0;j>k;++k){var l=i[k],m=a.W2V(l);h+=m.x+","+m.y+" "}g.setAttribute("points",h),e.appendChild(g)}return e.style.fill="none",this._penSymbol.attribute(e),e}}}),Xr.data=Xr.data||{},Xr.data.PolygonGraphicRow=Xr.Class({name:"PolygoneGraphicRow",extend:Xr.data.GraphicRow,requires:[Xr.data.IGraphicRow,Xr.IHitTest],construct:function(a,b){Xr.data.GraphicRow.call(this,a,b.clone()),this._penSymbol=new Xr.symbol.PenSymbol,this._brushSymbol=new Xr.symbol.BrushSymbol},methods:{penSymbol:function(a){return 1!=arguments.length?this._penSymbol:void(this._penSymbol=a)},brushSymbol:function(a){return 1!=arguments.length?this._brushSymbol:void(this._brushSymbol=a)},createSVG:function(a){for(var b=Xr.CommonStrings.SVG_NAMESPACE,c=this.graphicData().data(),d=c.length,e="",f=0;d>f;++f){for(var g=c[f],h=g.length,i=0;h>i;++i){var j=g[i],k=a.W2V(j);e+=0==i?" M "+k.x+" "+k.y:" L "+k.x+" "+k.y}e+=" Z"}var l=document.createElementNS(b,"path");return l.setAttribute("d",e),l.setAttribute("fill-rule","evenodd"),this._brushSymbol.attribute(l),this._penSymbol.attribute(l),l}}}),Xr.data=Xr.data||{},Xr.data.RectangleGraphicRow=Xr.Class({name:"RectangleGraphicRow",extend:Xr.data.GraphicRow,requires:[Xr.data.IGraphicRow,Xr.IHitTest],construct:function(a,b){Xr.data.GraphicRow.call(this,a,b.clone()),this._penSymbol=new Xr.symbol.PenSymbol,this._brushSymbol=new Xr.symbol.BrushSymbol},methods:{penSymbol:function(a){return 1!=arguments.length?this._penSymbol:void(this._penSymbol=a)},brushSymbol:function(a){return 1!=arguments.length?this._brushSymbol:void(this._brushSymbol=a)},createSVG:function(a){var b=Xr.CommonStrings.SVG_NAMESPACE,c=this.graphicData().data(),d=a.W2V(new Xr.PointD(c.minX,c.maxY)),e=a.W2V(new Xr.PointD(c.maxX,c.minY)),f=document.createElementNS(b,"rect");return f.setAttribute("x",d.x),f.setAttribute("y",d.y),f.setAttribute("width",e.x-d.x),f.setAttribute("height",e.y-d.y),this._brushSymbol.attribute(f),this._penSymbol.attribute(f),f}}}),Xr.data=Xr.data||{},Xr.data.EllipseGraphicRow=Xr.Class({name:"EllipseGraphicRow",extend:Xr.data.GraphicRow,requires:[Xr.data.IGraphicRow,Xr.IHitTest],construct:function(a,b){Xr.data.GraphicRow.call(this,a,b.clone()),this._penSymbol=new Xr.symbol.PenSymbol,this._brushSymbol=new Xr.symbol.BrushSymbol},methods:{penSymbol:function(a){return 1!=arguments.length?this._penSymbol:void(this._penSymbol=a)},brushSymbol:function(a){return 1!=arguments.length?this._brushSymbol:void(this._brushSymbol=a)},createSVG:function(a){var b=Xr.CommonStrings.SVG_NAMESPACE,c=this.graphicData().data(),d=a.W2V(new Xr.PointD(c.cx,c.cy)),e=a.viewLength(c.rx),f=a.viewLength(c.ry),g=document.createElementNS(b,"ellipse");return g.setAttribute("cx",d.x),g.setAttribute("cy",d.y),g.setAttribute("rx",e),g.setAttribute("ry",f),this._brushSymbol.attribute(g),this._penSymbol.attribute(g),g}}}),Xr.data=Xr.data||{},Xr.data.TextGraphicRow=Xr.Class({name:"TextGraphicRow",extend:Xr.data.GraphicRow,requires:[Xr.data.IGraphicRow,Xr.IHitTest],construct:function(a,b){Xr.data.GraphicRow.call(this,a,b.clone()),this._fontSymbol=new Xr.symbol.FontSymbol},methods:{fontSymbol:function(a){return 1!=arguments.length?this._fontSymbol:void(this._fontSymbol=a)},MBR:function(a,b){var c=this.createSVG(a);b.appendChild(c);var d=c.getBBox();b.removeChild(c);var e=a.V2W(d.x,d.y+d.height),f=a.V2W(d.x+d.width,d.y);return this._graphicData.MBR().set(e.x,e.y,f.x,f.y),this._graphicData.MBR()},createSVG:function(a){var b=Xr.CommonStrings.SVG_NAMESPACE,c=this.graphicData().data(),d=c.text,e=a.W2V(new Xr.PointD(c.x,c.y)),f=document.createElementNS(b,"g"),g=void 0;this._fontSymbol.needStroke()&&(g=document.createElementNS(b,"text"),g.setAttribute("x",e.x),g.setAttribute("y",e.y),g.setAttribute("text-anchor","middle"),this._fontSymbol.attributeForStroke(g),g.textContent=d);var h=document.createElementNS(b,"text");if(h.setAttribute("x",e.x),h.setAttribute("y",e.y),h.setAttribute("text-anchor","middle"),this._fontSymbol.attribute(h),h.textContent=d,void 0!=g){var i=document.createElementNS(b,"filter");i.setAttribute("id","_fe_labelBlur");var j=document.createElementNS(b,"feGaussianBlur");j.setAttribute("stdDeviation","1.5"),i.appendChild(j),f.appendChild(i),stroke.setAttribute("filter","url(#_fe_labelBlur)"),f.appendChild(g)}return f.appendChild(h),f}}}),Xr.edit=Xr.edit||{},Xr.edit.Sketch=Xr.Class({name:"Sketch",construct:function(a,b,c,d){arguments[0]!==__XR_CLASS_LOADING_TIME__&&(this._shapeData=b.clone(),this._id=c,this._editManager=a,this._completed=!1,this._isNew=d,this._bStay=!1)},methods:{shapeData:function(){return this._shapeData},id:function(){return parseInt(this._id)},editManager:function(){return this._editManager},completed:function(){return this.completed},isNew:function(a){return 0==arguments.length?this._isNew:void(this._isNew=a)},_drawSnapCursor:function(a,b){var c=Xr.CommonStrings.SVG_NAMESPACE,d=a.W2V(Xr.UserState.snapMapPt),e=document.createElementNS(c,"line");e.setAttribute("x1",d.x-50),e.setAttribute("y1",d.y),e.setAttribute("x2",d.x+50),e.setAttribute("y2",d.y);var f=document.createElementNS(c,"line");f.setAttribute("x1",d.x),f.setAttribute("y1",d.y-50),f.setAttribute("x2",d.x),f.setAttribute("y2",d.y+50),Xr.UserState.bSnapVertex?(e.setAttribute("stroke","#ff0000"),e.setAttribute("stroke-width","1"),f.setAttribute("stroke","#ff0000"),f.setAttribute("stroke-width","1")):Xr.UserState.bSnapEdge?(e.setAttribute("stroke","#ffff00"),e.setAttribute("stroke-width","1"),f.setAttribute("stroke","#ffff00"),f.setAttribute("stroke-width","1")):(e.setAttribute("stroke","#000000"),e.setAttribute("stroke-width","1"),f.setAttribute("stroke","#000000"),f.setAttribute("stroke-width","1")),b.appendChild(e),b.appendChild(f)},update:function(){var a=this._editManager.coordMapper();this.editManager().cleanContainer();var b=this.createSVG(a);this.editManager().container().appendChild(b)},stay:function(a){return 0==arguments.length?this._bStay:void(this._bStay=a)},hitTest:function(a,b,c){return this.shapeData().hitTest(a,b,c)}}}),Xr.edit=Xr.edit||{},Xr.edit.ISketch=Xr.Class({name:"ISketch",methods:{createSVG:function(){}}}),Xr.edit=Xr.edit||{},Xr.edit.PolygonSketch=Xr.Class({name:"PolygonSketch",extend:Xr.edit.Sketch,requires:[Xr.edit.ISketch,Xr.IMouseInteraction,Xr.IKeyboardInteraction],construct:function(a,b,c,d){Xr.edit.Sketch.call(this,a,b,c,d),this._bTouchBody=!1,this._idxTouchPart=-1,this._idxTouchVtx=-1},methods:{createSVG:function(a){for(var b=Xr.CommonStrings.SVG_NAMESPACE,c=this.shapeData().data(),d=c.length,e="",f=0;d>f;++f){for(var g=c[f],h=g.length,i=0;h>i;++i){var j=g[i],k=a.W2V(j);e+=0==i?" M "+k.x+" "+k.y:" L "+k.x+" "+k.y}e+=" Z"}var l=document.createElementNS(b,"path");l.setAttribute("d",e),l.setAttribute("stroke","#00ffff"),l.setAttribute("stroke-width","3"),l.setAttribute("stroke-opacity","0.5"),l.setAttribute("fill","#00ffff"),l.setAttribute("stroke-linecap","butt"),l.setAttribute("fill-rule","evenodd"),l.setAttribute("fill-opacity","0.5");var m=document.createElementNS(b,"g");if(m.appendChild(l),!this.isNew())for(var f=0;d>f;++f)for(var g=c[f],h=g.length,i=0;h>i;++i){var j=g[i],k=a.W2V(j),n=document.createElementNS(b,"ellipse");n.setAttribute("cx",k.x),n.setAttribute("cy",k.y),n.setAttribute("rx",5),n.setAttribute("ry",5),n.setAttribute("stroke","#ffffff"),n.setAttribute("stroke-width","3"),n.setAttribute("stroke-opacity","1"),n.setAttribute("fill","#000000"),n.setAttribute("fill-opacity","1"),m.appendChild(n)}return this._drawSnapCursor(a,m),m},mouseDown:function(a){if(this.isNew()||a.ctrlKey)return!1;var b=Xr.OperationHelper.offsetXY(a),c=b.x,d=b.y,e=this._editManager.coordMapper(),f=(Xr.UserState.snapMapPt,this.shapeData().data()),g=f.length;this._bTouchBody=!1,this._idxTouchPart=-1,this._idxTouchVtx=-1;for(var h=0;g>h;h++)for(var i=f[h],j=i.length,k=0;j>k;k++){var l=e.W2V(i[k]);if(Xr.GeometryHelper.pointIn(c,d,7,l)){this._idxTouchPart=h,this._idxTouchVtx=k;break}}return-1==this._idxTouchPart&&-1==this._idxTouchVtx&&(this._bTouchBody=this.shapeData().hitTest(c,d,e)),this._bTouchBody||-1!=this._idxTouchVtx},mouseMove:function(){{var a=this.shapeData().data();this._editManager.coordMapper()}if(this.isNew()){var b=a[a.length-1],c=b.length;if(c>0){var d=Xr.UserState.snapMapPt;c>1&&b.pop(),b.push(d)}this.update()}else{var e=Xr.UserState.snapMapPt,f=Xr.UserState.mouseDownAndMoveMapSnapPt,g=e.x-f.x,h=e.y-f.y;if(this._bTouchBody){for(var i=a.length,j=0;i>j;j++)for(var b=a[j],c=b.length,k=0;c>k;k++)b[k].add(g,h);this.update()}else if(-1!=this._idxTouchPart&&-1!=this._idxTouchVtx){var b=a[this._idxTouchPart],d=b[this._idxTouchVtx];d.set(e.x,e.y),this.update()}}},mouseUp:function(a){var b=this._editManager.coordMapper(),c=this.shapeData().data(),d=Xr.UserState.snapMapPt,e=Xr.UserState.mouseDownMapSnapPt,f=d.x-e.x,g=d.y-e.y,h=this.editManager().targetGraphicLayer();if(this.isNew()){var i=c[c.length-1],b=this._editManager.coordMapper(),j=Xr.UserState.snapMapPt;i.push(j),this.update()}else if(-1!=this._idxTouchPart&&-1!=this._idxTouchVtx){var k=new Xr.edit.UpdateControlPointCommand(h,this.id(),this._idxTouchPart,this._idxTouchVtx,d);this._idxTouchPart=-1,this._idxTouchVtx=-1,this.editManager().synchronize(k)
}else if(a.ctrlKey){for(var j=Xr.UserState.snapMapPt,l=b.snappingTolerance(),m=c.length,n=-1,o=void 0,p=0;m>p;p++){i=c[p];for(var q=i.length-1,r=0;q>r;r++){var s=i[r],t=i[r+1],o=Xr.GeometryHelper.intersectPointFromLine(s,t,j,l);if(o){n=r+1;break}}if(o||(o=Xr.GeometryHelper.intersectPointFromLine(i[0],i[q],j,l),o&&(n=q+1)),o){var k=new Xr.edit.AddVertexCommand(h,this.id(),p,n,o);return void this.editManager().synchronize(k)}}if(!o)return c.push([j]),void this.isNew(!0)}else if(this._bTouchBody){var k=new Xr.edit.MoveCommand(h,this.id(),f,g);this._bTouchBody=!1,this.editManager().synchronize(k)}},click:function(){},dblClick:function(){if(this.isNew()){var a=this.shapeData().data(),b=a[a.length-1];if(b.length>=5){b.pop(),b.pop();var c=this.editManager().targetGraphicLayer(),d=this.id();if(1==a.length){var e=new Xr.data.PolygonGraphicRow(d,this.shapeData());e.penSymbol().color("#383838"),e.penSymbol().width(3),e.brushSymbol().color("#cecece");var f=new Xr.edit.NewCommand(c,this.id(),e);this.editManager().synchronize(f)}else{var f=new Xr.edit.AddPartCommand(c,this.id(),b);this.editManager().synchronize(f)}}else this.editManager().synchronize(void 0)}},keyDown:function(){},keyPress:function(){},keyUp:function(a){if(!this.isNew()&&46==a.keyCode){var b=this.editManager().targetGraphicLayer(),c=this.id();if(this._bTouchBody){var d=b.rowSet().row(c);if(d){var e=new Xr.edit.RemoveCommand(b,c,d);this.editManager().synchronize(e)}}else if(-1!=this._idxTouchPart&&-1!=this._idxTouchVtx){var f=this.shapeData().data(),g=f[this._idxTouchPart];if(g.length>3){var e=new Xr.edit.RemoveVertexCommand(b,c,this._idxTouchPart,this._idxTouchVtx);this._idxTouchPart=-1,this._idxTouchVtx=-1,this.editManager().synchronize(e)}else if(f.length>1){var e=new Xr.edit.RemovePartCommand(b,c,this._idxTouchPart);this._idxTouchPart=-1,this._idxTouchVtx=-1,this.editManager().synchronize(e)}}}}}}),Xr.edit=Xr.edit||{},Xr.edit.PolylineSketch=Xr.Class({name:"PolylineSketch",extend:Xr.edit.Sketch,requires:[Xr.edit.ISketch,Xr.IMouseInteraction,Xr.IKeyboardInteraction],construct:function(a,b,c,d){Xr.edit.Sketch.call(this,a,b,c,d),this._bTouchBody=!1,this._idxTouchPart=-1,this._idxTouchVtx=-1},methods:{createSVG:function(a){for(var b=Xr.CommonStrings.SVG_NAMESPACE,c=this.shapeData().data(),d=c.length,e="",f=0;d>f;++f)for(var g=c[f],h=g.length,i=0;h>i;++i){var j=g[i],k=a.W2V(j);e+=0==i?" M "+k.x+" "+k.y:" L "+k.x+" "+k.y}var l=document.createElementNS(b,"path");l.setAttribute("d",e),l.setAttribute("fill","none"),l.setAttribute("stroke","#00ffff"),l.setAttribute("stroke-width","3"),l.setAttribute("stroke-opacity","0.5"),l.setAttribute("stroke-linecap","butt");var m=document.createElementNS(b,"g");if(m.appendChild(l),!this.isNew())for(var f=0;d>f;++f)for(var g=c[f],h=g.length,i=0;h>i;++i){var j=g[i],k=a.W2V(j),n=document.createElementNS(b,"ellipse");n.setAttribute("cx",k.x),n.setAttribute("cy",k.y),n.setAttribute("rx",5),n.setAttribute("ry",5),n.setAttribute("stroke","#ffffff"),n.setAttribute("stroke-width","3"),n.setAttribute("stroke-opacity","1"),n.setAttribute("fill","#000000"),n.setAttribute("fill-opacity","1"),m.appendChild(n)}return this._drawSnapCursor(a,m),m},mouseDown:function(a){if(this.isNew()||a.ctrlKey)return!1;var b=Xr.OperationHelper.offsetXY(a),c=b.x,d=b.y,e=this._editManager.coordMapper(),f=(Xr.UserState.snapMapPt,this.shapeData().data()),g=f.length;this._bTouchBody=!1,this._idxTouchPart=-1,this._idxTouchVtx=-1;for(var h=0;g>h;h++)for(var i=f[h],j=i.length,k=0;j>k;k++){var l=e.W2V(i[k]);if(Xr.GeometryHelper.pointIn(c,d,7,l)){this._idxTouchPart=h,this._idxTouchVtx=k;break}}return-1==this._idxTouchPart&&-1==this._idxTouchVtx&&(this._bTouchBody=this.shapeData().hitTest(c,d,e)),this._bTouchBody||-1!=this._idxTouchVtx},mouseMove:function(){{var a=this.shapeData().data(),b=a[a.length-1],c=b.length;this._editManager.coordMapper()}if(this.isNew()){if(c>0){var d=Xr.UserState.snapMapPt;c>1&&b.pop(),b.push(d)}this.update()}else{var e=Xr.UserState.snapMapPt,f=Xr.UserState.mouseDownAndMoveMapSnapPt,g=e.x-f.x,h=e.y-f.y;if(this._bTouchBody){for(var i=a.length,j=0;i>j;j++){b=a[j];for(var k=b.length,l=0;k>l;l++)b[l].add(g,h)}this.update()}else if(-1!=this._idxTouchPart&&-1!=this._idxTouchVtx){b=a[this._idxTouchPart];var d=b[this._idxTouchVtx];d.set(e.x,e.y),this.update()}}},mouseUp:function(a){var b=this.shapeData().data(),c=this._editManager.coordMapper(),d=Xr.UserState.snapMapPt,e=Xr.UserState.snapMapPt,f=Xr.UserState.mouseDownMapSnapPt,g=d.x-f.x,h=d.y-f.y,i=this.editManager().targetGraphicLayer();if(this.isNew()){var j=b[b.length-1],c=this._editManager.coordMapper();j.push(e),this.update()}else if(-1!=this._idxTouchPart&&-1!=this._idxTouchVtx){var k=new Xr.edit.UpdateControlPointCommand(i,this.id(),this._idxTouchPart,this._idxTouchVtx,d);this._idxTouchPart=-1,this._idxTouchVtx=-1,this.editManager().synchronize(k)}else if(a.ctrlKey){for(var l=c.snappingTolerance(),m=b.length,n=-1,o=void 0,p=0;m>p;p++){j=b[p];for(var q=j.length-1,r=0;q>r;r++){var s=j[r],t=j[r+1],o=Xr.GeometryHelper.intersectPointFromLine(s,t,e,l);if(o){n=r+1;break}}if(o){var k=new Xr.edit.AddVertexCommand(i,this.id(),p,n,o);return void this.editManager().synchronize(k)}}if(!o)return b.push([e]),void this.isNew(!0)}else if(this._bTouchBody){var k=new Xr.edit.MoveCommand(i,this.id(),g,h);this._bTouchBody=!1,this.editManager().synchronize(k)}},click:function(){},dblClick:function(){if(this.isNew()){var a=this.shapeData().data(),b=a[a.length-1];if(b.length>=4){b.pop(),b.pop();var c=this.editManager().targetGraphicLayer(),d=this.id();if(1==a.length){var e=new Xr.data.PolylineGraphicRow(d,this.shapeData());e.penSymbol().color("#fefe22"),e.penSymbol().width(3);var f=new Xr.edit.NewCommand(c,this.id(),e);this.editManager().synchronize(f)}else{var f=new Xr.edit.AddPartCommand(c,this.id(),b);this.editManager().synchronize(f)}}else this.editManager().synchronize(void 0)}},keyDown:function(){},keyPress:function(){},keyUp:function(a){if(!this.isNew()&&46==a.keyCode){var b=this.editManager().targetGraphicLayer(),c=this.id();if(this._bTouchBody){var d=b.rowSet().row(c);if(d){var e=new Xr.edit.RemoveCommand(b,c,d);this.editManager().synchronize(e)}}else if(-1!=this._idxTouchPart&&-1!=this._idxTouchVtx){var f=this.shapeData().data(),g=f[this._idxTouchPart];if(g.length>2){var e=new Xr.edit.RemoveVertexCommand(b,c,this._idxTouchPart,this._idxTouchVtx);this._idxTouchPart=-1,this._idxTouchVtx=-1,this.editManager().synchronize(e)}else if(f.length>1){var e=new Xr.edit.RemovePartCommand(b,c,this._idxTouchPart);this._idxTouchPart=-1,this._idxTouchVtx=-1,this.editManager().synchronize(e)}}}}}}),Xr.edit=Xr.edit||{},Xr.edit.PointSketch=Xr.Class({name:"PointSketch",extend:Xr.edit.Sketch,requires:[Xr.edit.ISketch,Xr.IMouseInteraction,Xr.IKeyboardInteraction],construct:function(a,b,c,d){Xr.edit.Sketch.call(this,a,b,c,d),this._bTouchBody=!1},methods:{createSVG:function(a){var b=Xr.CommonStrings.SVG_NAMESPACE,c=this.shapeData().data(),d=a.W2V(c),e=document.createElementNS(b,"ellipse");e.setAttribute("cx",d.x),e.setAttribute("cy",d.y),e.setAttribute("rx",5),e.setAttribute("ry",5),e.setAttribute("stroke","#ffffff"),e.setAttribute("stroke-width","3"),e.setAttribute("stroke-opacity","1"),e.setAttribute("fill","#000000"),e.setAttribute("fill-opacity","1");var f=document.createElementNS(b,"g");return f.appendChild(e),this._drawSnapCursor(a,f),f},mouseDown:function(a){if(this.isNew()||a.ctrlKey)return!1;{var b=Xr.OperationHelper.offsetXY(a),c=b.x,d=b.y,e=this._editManager.coordMapper(),f=(Xr.UserState.snapMapPt,this.shapeData().data());e.W2V(f)}return this._bTouchBody=this.shapeData().hitTest(c,d,e),this._bTouchBody},mouseMove:function(){{var a=this.shapeData().data();this._editManager.coordMapper()}if(this.isNew()){var b=Xr.UserState.snapMapPt;a.set(b.x,b.y),this.update()}else{{var c=Xr.UserState.snapMapPt,d=Xr.UserState.mouseDownAndMoveMapSnapPt;c.x-d.x,c.y-d.y}this._bTouchBody&&(a.set(c.x,c.y),this.update())}},mouseUp:function(){this._editManager.coordMapper();if(this.isNew()){var a=this.shapeData().data(),b=Xr.UserState.snapMapPt;a.set(b.x,b.y),this.update()}else if(this._bTouchBody){var c=Xr.UserState.snapMapPt,d=Xr.UserState.mouseDownMapSnapPt,e=(c.x-d.x,c.y-d.y,this.editManager().targetGraphicLayer()),f=new Xr.edit.UpdateControlPointCommand(e,this.id(),0,0,c);this._bTouchBody=!1,this.editManager().synchronize(f)}},click:function(){if(this.isNew()){var a=this.editManager().targetGraphicLayer(),b=this.id(),c=new Xr.data.PointGraphicRow(b,this.shapeData()),d=c.markerSymbol();d.penSymbol().color("#ffff00"),d.penSymbol().width(3),d.brushSymbol().color("#cecece");var e=new Xr.edit.NewCommand(a,this.id(),c);this.editManager().synchronize(e)}},dblClick:function(){},keyDown:function(){},keyPress:function(){},keyUp:function(a){if(!this.isNew()&&46==a.keyCode){var b=this.editManager(),c=b.targetGraphicLayer(),d=this.id();if(this._bTouchBody){var e=c.rowSet().row(d);if(e){var f=new Xr.edit.RemoveCommand(c,d,e);b.synchronize(f)}}}}}}),Xr.edit=Xr.edit||{},Xr.edit.TextSketch=Xr.Class({name:"TextSketch",extend:Xr.edit.Sketch,requires:[Xr.edit.ISketch,Xr.IMouseInteraction,Xr.IKeyboardInteraction],construct:function(a,b,c,d){Xr.edit.Sketch.call(this,a,b,c,d),this._bTouchBody=!1},methods:{createSVG:function(a){var b=Xr.CommonStrings.SVG_NAMESPACE,c=this.shapeData().data(),d=new Xr.PointD(c.x,c.y),e=a.W2V(d),f=document.createElementNS(b,"ellipse");f.setAttribute("cx",e.x),f.setAttribute("cy",e.y),f.setAttribute("rx",5),f.setAttribute("ry",5),f.setAttribute("stroke","#ffffff"),f.setAttribute("stroke-width","3"),f.setAttribute("stroke-opacity","1"),f.setAttribute("fill","#000000"),f.setAttribute("fill-opacity","1");var g=document.createElementNS(b,"g");return g.appendChild(f),this._drawSnapCursor(a,g),g},mouseDown:function(a){if(this.isNew()||a.ctrlKey)return!1;var b=Xr.OperationHelper.offsetXY(a),c=b.x,d=b.y,e=this._editManager.coordMapper();return this._bTouchBody=this.shapeData().hitTest(c,d,e),this._bTouchBody},mouseMove:function(){{var a=this.shapeData().data();this._editManager.coordMapper()}if(this.isNew()){var b=Xr.UserState.snapMapPt;a.x=b.x,a.y=b.y,this.update()}else{{var c=Xr.UserState.snapMapPt,d=Xr.UserState.mouseDownAndMoveMapSnapPt;c.x-d.x,c.y-d.y}this._bTouchBody&&(this.shapeData().updateControlPoint(0,0,c),this.update())}},mouseUp:function(a){var b=this._editManager.coordMapper();if(this.isNew()){var c=this.shapeData().data(),d=Xr.OperationHelper.offsetXY(a),e=b.V2W(d.x,d.y);c.x=e.x,c.y=e.y,this.update()}else if(this._bTouchBody){var f=Xr.UserState.snapMapPt,g=Xr.UserState.mouseDownMapSnapPt,h=(f.x-g.x,f.y-g.y,this.editManager().targetGraphicLayer()),i=new Xr.edit.UpdateControlPointCommand(h,this.id(),0,0,f);this._bTouchBody=!1,this.editManager().synchronize(i)}},click:function(){if(this.isNew()){var a=this.editManager().targetGraphicLayer(),b=this.id(),c=new Xr.data.TextGraphicRow(b,this.shapeData()),d=new Xr.edit.NewCommand(a,this.id(),c);this.editManager().synchronize(d)}},dblClick:function(){},keyDown:function(){},keyPress:function(){},keyUp:function(a){if(!this.isNew()&&46==a.keyCode){var b=this.editManager().targetGraphicLayer(),c=this.id();if(this._bTouchBody){var d=b.rowSet().row(c);if(d){var e=new Xr.edit.RemoveCommand(b,c,d);this.editManager().synchronize(e)}}}}}}),Xr.edit=Xr.edit||{},Xr.edit.RectangleSketch=Xr.Class({name:"RectangleSketch",extend:Xr.edit.Sketch,requires:[Xr.edit.ISketch,Xr.IMouseInteraction,Xr.IKeyboardInteraction],construct:function(a,b,c,d){Xr.edit.Sketch.call(this,a,b,c,d),this._bTouchBody=!1,this._idxTouchControl=-1},methods:{_createControlPointSVG:function(a,b){var c=Xr.CommonStrings.SVG_NAMESPACE,d=document.createElementNS(c,"ellipse");return d.setAttribute("cx",a),d.setAttribute("cy",b),d.setAttribute("rx",5),d.setAttribute("ry",5),d.setAttribute("stroke","#ffffff"),d.setAttribute("stroke-width","3"),d.setAttribute("stroke-opacity","1"),d.setAttribute("fill","#000000"),d.setAttribute("fill-opacity","1"),d},createSVG:function(a){var b=Xr.CommonStrings.SVG_NAMESPACE,c=this.shapeData().data(),d=c.minX,e=c.minY,f=c.maxX,g=c.maxY;c.minX>c.maxX&&(d=c.maxX,f=c.minX),c.minY>c.maxY&&(e=c.maxY,g=c.minY);var h=a.W2V(new Xr.PointD(d,g)),i=a.W2V(new Xr.PointD(f,e)),j=document.createElementNS(b,"rect");j.setAttribute("x",h.x),j.setAttribute("y",h.y),j.setAttribute("width",i.x-h.x),j.setAttribute("height",i.y-h.y),j.setAttribute("stroke","#00ffff"),j.setAttribute("stroke-width","3"),j.setAttribute("stroke-opacity","0.5"),j.setAttribute("fill","#00ffff"),j.setAttribute("stroke-linecap","butt"),j.setAttribute("fill-opacity","0.5");var k=document.createElementNS(b,"g");if(k.appendChild(j),!this.isNew()){k.appendChild(this._createControlPointSVG(h.x,h.y)),k.appendChild(this._createControlPointSVG((h.x+i.x)/2,h.y)),k.appendChild(this._createControlPointSVG(i.x,h.y)),k.appendChild(this._createControlPointSVG(i.x,(h.y+i.y)/2)),k.appendChild(this._createControlPointSVG(i.x,i.y)),k.appendChild(this._createControlPointSVG((h.x+i.x)/2,i.y)),k.appendChild(this._createControlPointSVG(h.x,i.y)),k.appendChild(this._createControlPointSVG(h.x,(h.y+i.y)/2))}return this._drawSnapCursor(a,k),k},mouseDown:function(a){var b=Xr.OperationHelper.offsetXY(a),c=b.x,d=b.y,e=this.shapeData().data();if(this.isNew()){var f=Xr.UserState.snapMapPt;return e.minX=f.x,e.minY=f.y,!1}var g=this._editManager.coordMapper(),h=new Xr.PointD(c,d),i=g.W2V(new Xr.PointD(e.minX,e.maxY)),j=g.W2V(new Xr.PointD(e.maxX,e.minY));return this._bTouchBody=!1,this._idxTouchControl=-1,Xr.GeometryHelper.pointIn(i.x,i.y,7,h)?this._idxTouchControl=0:Xr.GeometryHelper.pointIn((i.x+j.x)/2,i.y,7,h)?this._idxTouchControl=1:Xr.GeometryHelper.pointIn(j.x,i.y,7,h)?this._idxTouchControl=2:Xr.GeometryHelper.pointIn(j.x,(i.y+j.y)/2,7,h)?this._idxTouchControl=3:Xr.GeometryHelper.pointIn(j.x,j.y,7,h)?this._idxTouchControl=4:Xr.GeometryHelper.pointIn((i.x+j.x)/2,j.y,7,h)?this._idxTouchControl=5:Xr.GeometryHelper.pointIn(i.x,j.y,7,h)?this._idxTouchControl=6:Xr.GeometryHelper.pointIn(i.x,(i.y+j.y)/2,7,h)?this._idxTouchControl=7:this._bTouchBody=this.shapeData().hitTest(c,d,g),this._bTouchBody||-1!=this._idxTouchControl},mouseMove:function(){{var a=this.shapeData().data();this._editManager.coordMapper()}if(this.isNew()){if(Xr.UserState.mouseDown){var b=Xr.UserState.snapMapPt;a.maxX=b.x,a.maxY=b.y}this.update()}else{var c=Xr.UserState.snapMapPt,d=Xr.UserState.mouseDownAndMoveMapSnapPt,e=c.x-d.x,f=c.y-d.y;this._bTouchBody?(a.moveByOffset(e,f),this.update()):-1!=this._idxTouchControl&&(0==this._idxTouchControl?(a.minX=c.x,a.maxY=c.y):1==this._idxTouchControl?a.maxY=c.y:2==this._idxTouchControl?(a.maxX=c.x,a.maxY=c.y):3==this._idxTouchControl?a.maxX=c.x:4==this._idxTouchControl?(a.maxX=c.x,a.minY=c.y):5==this._idxTouchControl?a.minY=c.y:6==this._idxTouchControl?(a.minX=c.x,a.minY=c.y):7==this._idxTouchControl&&(a.minX=c.x),this.update())}},mouseUp:function(a){var b=this._editManager.coordMapper(),c=Xr.UserState.snapMapPt,d=b.V2W(Xr.UserState.mouseDownPt.x,Xr.UserState.mouseDownPt.y),e=Xr.OperationHelper.offsetXY(a),f=(b.V2W(e.x,e.y),c.x-d.x),g=c.y-d.y,h=this.editManager().targetGraphicLayer();if(this.isNew()){var h=(this.shapeData().data(),this.editManager().targetGraphicLayer()),i=this.id(),j=new Xr.data.RectangleGraphicRow(i,this.shapeData());j.penSymbol().color("#383838"),j.penSymbol().width(3),j.brushSymbol().color("#cecece");var k=new Xr.edit.NewCommand(h,this.id(),j);this.editManager().synchronize(k)}else if(-1!=this._idxTouchControl){var k=new Xr.edit.UpdateControlPointCommand(h,this.id(),0,this._idxTouchControl,c);this._idxTouchControl=-1,this.shapeData().data().valid(),this.editManager().synchronize(k)}else if(this._bTouchBody){var k=new Xr.edit.MoveCommand(h,this.id(),f,g);this._bTouchBody=!1,this.editManager().synchronize(k)}},click:function(){},dblClick:function(){},keyDown:function(){},keyPress:function(){},keyUp:function(a){if(!this.isNew()&&46==a.keyCode){var b=this.editManager(),c=b.targetGraphicLayer(),d=this.id();if(this._bTouchBody){var e=c.rowSet().row(d);if(e){var f=new Xr.edit.RemoveCommand(c,d,e);b.synchronize(f)}}}}}}),Xr.edit=Xr.edit||{},Xr.edit.EllipseSketch=Xr.Class({name:"EllipseSketch",extend:Xr.edit.Sketch,requires:[Xr.edit.ISketch,Xr.IMouseInteraction,Xr.IKeyboardInteraction],construct:function(a,b,c,d){Xr.edit.Sketch.call(this,a,b,c,d),this._bTouchBody=!1,this._idxTouchControl=-1},methods:{_createControlPointSVG:function(a,b){var c=Xr.CommonStrings.SVG_NAMESPACE,d=document.createElementNS(c,"ellipse");return d.setAttribute("cx",a),d.setAttribute("cy",b),d.setAttribute("rx",5),d.setAttribute("ry",5),d.setAttribute("stroke","#ffffff"),d.setAttribute("stroke-width","3"),d.setAttribute("stroke-opacity","1"),d.setAttribute("fill","#000000"),d.setAttribute("fill-opacity","1"),d},createSVG:function(a){var b,c=Xr.CommonStrings.SVG_NAMESPACE,d=this.shapeData().data(),e=d.cx-d.rx,f=d.cy-d.ry,g=d.cx+d.rx,h=d.cy+d.ry;e>g&&(b=e,e=g,g=b),f>h&&(b=f,f=h,h=b);var i,j=a.W2V(new Xr.PointD(e,h)),k=a.W2V(new Xr.PointD(g,f)),l=a.W2V(new Xr.PointD(d.cx,d.cy)),m=a.viewLength(d.rx),n=a.viewLength(d.ry);ellipSvg=document.createElementNS(c,"ellipse"),ellipSvg.setAttribute("cx",l.x),ellipSvg.setAttribute("cy",l.y),ellipSvg.setAttribute("rx",m),ellipSvg.setAttribute("ry",n),ellipSvg.setAttribute("stroke","#00ffff"),ellipSvg.setAttribute("stroke-width","3"),ellipSvg.setAttribute("stroke-opacity","0.5"),ellipSvg.setAttribute("fill","#00ffff"),ellipSvg.setAttribute("stroke-linecap","butt"),ellipSvg.setAttribute("fill-opacity","0.5");var i=document.createElementNS(c,"rect");i.setAttribute("x",j.x),i.setAttribute("y",j.y),i.setAttribute("width",k.x-j.x),i.setAttribute("height",k.y-j.y),i.setAttribute("stroke","#00ffff"),i.setAttribute("stroke-width","3"),i.setAttribute("stroke-opacity","0.5"),i.setAttribute("fill","none"),i.setAttribute("stroke-linecap","butt");var o=document.createElementNS(c,"g");if(o.appendChild(ellipSvg),o.appendChild(i),!this.isNew()){var l=void 0;o.appendChild(this._createControlPointSVG(j.x,j.y)),o.appendChild(this._createControlPointSVG((j.x+k.x)/2,j.y)),o.appendChild(this._createControlPointSVG(k.x,j.y)),o.appendChild(this._createControlPointSVG(k.x,(j.y+k.y)/2)),o.appendChild(this._createControlPointSVG(k.x,k.y)),o.appendChild(this._createControlPointSVG((j.x+k.x)/2,k.y)),o.appendChild(this._createControlPointSVG(j.x,k.y)),o.appendChild(this._createControlPointSVG(j.x,(j.y+k.y)/2))}return this._drawSnapCursor(a,o),o},mouseDown:function(a){var b=Xr.OperationHelper.offsetXY(a),c=b.x,d=b.y,e=this._editManager.coordMapper(),f=this.shapeData().data();if(this.isNew()){var g=Xr.UserState.snapMapPt;return f.cx=g.x,f.cy=g.y,console.log("ellipse mouseDown"),!1}console.log("ellipse mouseDown, not new");var h=f.cx-f.rx,i=f.cy-f.ry,j=f.cx+f.rx,k=f.cy+f.ry,l=e.W2V(new Xr.PointD(h,k)),m=e.W2V(new Xr.PointD(j,i)),n=new Xr.PointD(c,d);return this._bTouchBody=!1,this._idxTouchControl=-1,Xr.GeometryHelper.pointIn(l.x,l.y,7,n)?this._idxTouchControl=0:Xr.GeometryHelper.pointIn((l.x+m.x)/2,l.y,7,n)?this._idxTouchControl=1:Xr.GeometryHelper.pointIn(m.x,l.y,7,n)?this._idxTouchControl=2:Xr.GeometryHelper.pointIn(m.x,(l.y+m.y)/2,7,n)?this._idxTouchControl=3:Xr.GeometryHelper.pointIn(m.x,m.y,7,n)?this._idxTouchControl=4:Xr.GeometryHelper.pointIn((l.x+m.x)/2,m.y,7,n)?this._idxTouchControl=5:Xr.GeometryHelper.pointIn(l.x,m.y,7,n)?this._idxTouchControl=6:Xr.GeometryHelper.pointIn(l.x,(l.y+m.y)/2,7,n)?this._idxTouchControl=7:this._bTouchBody=this.shapeData().hitTest(c,d,e),this._bTouchBody||-1!=this._idxTouchControl},mouseMove:function(){{var a=this.shapeData().data();this._editManager.coordMapper()}if(this.isNew()){if(Xr.UserState.mouseDown){var b=Xr.UserState.snapMapPt;a.rx=Math.abs(a.cx-b.x),a.ry=Math.abs(a.cy-b.y),console.log("ellipse mouseMove")}this.update()}else{var c=Xr.UserState.snapMapPt,d=Xr.UserState.mouseDownAndMoveMapSnapPt,e=c.x-d.x,f=c.y-d.y;if(this._bTouchBody)a.cx+=e,a.cy+=f,this.update();else if(-1!=this._idxTouchControl){var g=Math.abs(a.cx-c.x),h=Math.abs(a.cy-c.y);0==this._idxTouchControl?(a.rx=g,a.ry=h):1==this._idxTouchControl?a.ry=h:2==this._idxTouchControl?(a.rx=g,a.ry=h):3==this._idxTouchControl?a.rx=g:4==this._idxTouchControl?(a.rx=g,a.ry=h):5==this._idxTouchControl?a.ry=h:6==this._idxTouchControl?(a.rx=g,a.ry=h):7==this._idxTouchControl&&(a.rx=g),this.update()}}},mouseUp:function(){var a=(this._editManager.coordMapper(),Xr.UserState.snapMapPt),b=Xr.UserState.mouseDownMapSnapPt,c=a.x-b.x,d=a.y-b.y,e=this.editManager().targetGraphicLayer(),f=this.shapeData().data();if(this.isNew()){var e=this.editManager().targetGraphicLayer(),g=this.id(),h=new Xr.data.EllipseGraphicRow(g,this.shapeData());h.penSymbol().color("#383838"),h.penSymbol().width(3),h.brushSymbol().color("#cecece");var i=new Xr.edit.NewCommand(e,this.id(),h);console.log("ellipse mouseUp"),this.editManager().synchronize(i)}else if(-1!=this._idxTouchControl){var j=new Xr.PointD(Math.abs(f.cx-a.x),Math.abs(f.cy-a.y)),i=new Xr.edit.UpdateControlPointCommand(e,this.id(),0,this._idxTouchControl,j);this._idxTouchControl=-1,this.editManager().synchronize(i)}else if(this._bTouchBody){var i=new Xr.edit.MoveCommand(e,this.id(),c,d);this._bTouchBody=!1,this.editManager().synchronize(i)}},click:function(){},dblClick:function(){},keyDown:function(){},keyPress:function(){},keyUp:function(a){if(!this.isNew()&&46==a.keyCode){var b=this.editManager(),c=b.targetGraphicLayer(),d=this.id();if(this._bTouchBody){var e=c.rowSet().row(d);if(e){var f=new Xr.edit.RemoveCommand(c,d,e);b.synchronize(f)}}}}}}),Xr.edit=Xr.edit||{},Xr.edit.ICommand=Xr.Class({name:"ICommand",methods:{run:function(){},undo:function(){},type:function(){}}}),Xr.edit=Xr.edit||{},Xr.edit.Command=Xr.Class({name:"Command",construct:function(a,b){this._graphicLayer=a,this._id=b},methods:{graphicLayer:function(){return this._graphicLayer},id:function(){return this._id}}}),Xr.edit=Xr.edit||{},Xr.edit.NewCommand=Xr.Class({name:"NewCommand",extend:Xr.edit.Command,requires:[Xr.edit.ICommand],construct:function(a,b,c){Xr.edit.Command.call(this,a,b),this._graphicRow=c},methods:{run:function(){return this.graphicLayer().rowSet().add(this._graphicRow)},undo:function(){var a=this.id();return this.graphicLayer().rowSet().remove(a)},type:function(){return Xr.edit.NewCommand.TYPE}},statics:{TYPE:"NEW"}}),Xr.edit=Xr.edit||{},Xr.edit.MoveCommand=Xr.Class({name:"MoveCommand",extend:Xr.edit.Command,requires:[Xr.edit.ICommand],construct:function(a,b,c,d){Xr.edit.Command.call(this,a,b),this._deltaX=c,this._deltaY=d},methods:{run:function(){var a=this.graphicLayer().rowSet().row(this.id());return a?(a.graphicData().moveByOffset(this._deltaX,this._deltaY),!0):!1},undo:function(){var a=this.graphicLayer().rowSet().row(this.id());return a?(a.graphicData().moveByOffset(-this._deltaX,-this._deltaY),!0):!1},type:function(){return Xr.edit.MoveCommand.TYPE}},statics:{TYPE:"MOVE"}}),Xr.edit=Xr.edit||{},Xr.edit.MoveControlPointCommand=Xr.Class({name:"MoveControlPointCommand",extend:Xr.edit.Command,requires:[Xr.edit.ICommand],construct:function(a,b,c,d,e,f){Xr.edit.Command.call(this,a,b),this._partIndex=c,this._controlPointIndex=d,this._deltaX=e,this._deltaY=f},methods:{run:function(){var a=this.graphicLayer().rowSet().row(this.id());if(!a)return!1;var b=a.graphicData().moveControlPointByOffset(this._partIndex,this._controlPointIndex,this._deltaX,this._deltaY);return void 0!=b&&(this._controlPointIndex=b),!0},undo:function(){var a=this.graphicLayer().rowSet().row(this.id());if(!a)return!1;var b=a.graphicData().moveControlPointByOffset(this._partIndex,this._controlPointIndex,-this._deltaX,-this._deltaY);return void 0!=b&&(this._controlPointIndex=b),!0},type:function(){return Xr.edit.MoveControlPointCommand.TYPE}},statics:{TYPE:"MOVE_CONTROL_POINT"}}),Xr.edit=Xr.edit||{},Xr.edit.UpdateControlPointCommand=Xr.Class({name:"UpdateControlPointCommand",extend:Xr.edit.Command,requires:[Xr.edit.ICommand],construct:function(a,b,c,d,e){Xr.edit.Command.call(this,a,b),this._partIndex=c,this._controlPointIndex=d,this._newPt=new Xr.PointD(e.x,e.y),this._oldPt=new Xr.PointD},methods:{run:function(){var a=this.graphicLayer().rowSet().row(this.id());if(!a)return!1;var b=a.graphicData().updateControlPoint(this._partIndex,this._controlPointIndex,this._newPt,this._oldPt);return void 0!=b&&(this._controlPointIndex=b),!0},undo:function(){var a=this.graphicLayer().rowSet().row(this.id());if(!a)return!1;var b=a.graphicData().updateControlPoint(this._partIndex,this._controlPointIndex,this._oldPt);return void 0!=b&&(this._controlPointIndex=b),!0},type:function(){return Xr.edit.MoveControlPointCommand.TYPE}},statics:{TYPE:"MOVE_CONTROL_POINT"}}),Xr.edit=Xr.edit||{},Xr.edit.RemoveCommand=Xr.Class({name:"RemoveCommand",extend:Xr.edit.Command,requires:[Xr.edit.ICommand],construct:function(a,b,c){Xr.edit.Command.call(this,a,b),this._graphicRow=c},methods:{run:function(){var a=this.id(),b=this.graphicLayer().rowSet();return b.row(a)?(b.remove(a),!0):!1},undo:function(){return this.graphicLayer().rowSet().add(this._graphicRow)},type:function(){return Xr.edit.RemoveCommand.TYPE}},statics:{TYPE:"REMOVE"}}),Xr.edit=Xr.edit||{},Xr.edit.RemoveVertexCommand=Xr.Class({name:"RemoveVertexCommand",extend:Xr.edit.Command,requires:[Xr.edit.ICommand],construct:function(a,b,c,d){Xr.edit.Command.call(this,a,b),this._partIndex=c,this._controlPointIndex=d,this._vertexTobeRemoved=void 0},methods:{run:function(){var a=this.graphicLayer().rowSet().row(this.id());return a?(this._vertexTobeRemoved=a.graphicData().removeVertex(this._partIndex,this._controlPointIndex),void 0!=this._vertexTobeRemoved):!1},undo:function(){var a=this.graphicLayer().rowSet().row(this.id());return a&&this._vertexTobeRemoved?(a.graphicData().insertVertex(this._partIndex,this._controlPointIndex,this._vertexTobeRemoved),!0):!1},type:function(){return Xr.edit.RemoveVertexCommand.TYPE}},statics:{TYPE:"REMOVE_VERTEX"}}),Xr.edit=Xr.edit||{},Xr.edit.AddVertexCommand=Xr.Class({name:"AddVertexCommand",extend:Xr.edit.Command,requires:[Xr.edit.ICommand],construct:function(a,b,c,d,e){Xr.edit.Command.call(this,a,b),this._partIndex=c,this._controlPointIndex=d,this._vetexAdded=e},methods:{run:function(){var a=this.graphicLayer().rowSet().row(this.id());return a?(a.graphicData().insertVertex(this._partIndex,this._controlPointIndex,this._vetexAdded),!0):!1},undo:function(){var a=this.graphicLayer().rowSet().row(this.id());return a?(a.graphicData().removeVertex(this._partIndex,this._controlPointIndex),!0):!1},type:function(){return Xr.edit.AddVertexCommand.TYPE}},statics:{TYPE:"ADD_VERTEX"}}),Xr.edit=Xr.edit||{},Xr.edit.AddPartCommand=Xr.Class({name:"AddPartCommand",extend:Xr.edit.Command,requires:[Xr.edit.ICommand],construct:function(a,b,c){Xr.edit.Command.call(this,a,b),this._pointList=Xr.OperationHelper.copyArrayOfPointD(c)},methods:{run:function(){var a=this.graphicLayer().rowSet().row(this.id());return a?(a.graphicData().insertPart(-1,this._pointList),!0):!1},undo:function(){var a=this.graphicLayer().rowSet().row(this.id());return a?(a.graphicData().removePart(-1),!0):!1},type:function(){return Xr.edit.AddPartCommand.TYPE}},statics:{TYPE:"ADD_PART"}}),Xr.edit=Xr.edit||{},Xr.edit.RemovePartCommand=Xr.Class({name:"RemovePartCommand",extend:Xr.edit.Command,requires:[Xr.edit.ICommand],construct:function(a,b,c){Xr.edit.Command.call(this,a,b),this._pointList=void 0,this._idxPartRemoved=c},methods:{run:function(){var a=this.graphicLayer().rowSet().row(this.id());return a?(this._pointList=a.graphicData().removePart(this._idxPartRemoved),!0):!1},undo:function(){var a=this.graphicLayer().rowSet().row(this.id());return a?(a.graphicData().insertPart(this._idxPartRemoved,this._pointList),!0):!1},type:function(){return Xr.edit.RemovePartCommand.TYPE}},statics:{TYPE:"REMOVE_PART"}}),Xr.edit=Xr.edit||{},Xr.edit.EditHistory=Xr.Class({name:"EditHistory",construct:function(a){this._commands=new Array,this._index=-1,this._editManager=a,this._canUndo=!1,this._canRedo=!1},methods:{undo:function(){if(this._index>=this._commands.length||this._index<0)return!1;var a=this._commands[this._index];return a.undo()&&(this._editManager.setSketchById(a.id()),this._editManager.map().update()),this._index--,this._checkState(this._index>=0,!0),!0},redo:function(){if(this._index>=this._commands.length-1||this._index<-1)return!1;this._index++;var a=this._commands[this._index];return a.run()&&(this._editManager.setSketchById(a.id()),this._editManager.map().update()),this._checkState(!0,this._index<this._commands.length-1),!0},add:function(a){this._commands.splice(this._index+1,this._commands.length),this._commands.push(a),this._index=this._commands.length-1,this._checkState(!0,!1)},undoable:function(){return this._canUndo},redoable:function(){return this._canRedo},_checkState:function(a,b){if(this._canUndo!=a){var c=Xr.Events.create(Xr.Events.UndoStateChanged,{disabled:!a});Xr.Events.fire(this._editManager.map().container(),c),this._canUndo=a}if(this._canRedo!=b){var c=Xr.Events.create(Xr.Events.RedoStateChanged,{disabled:!b});Xr.Events.fire(this._editManager.map().container(),c),this._canRedo=b}},reset:function(){this._commands.length=0,this._index=0,this._checkState(!1,!1)}}}),Xr.edit=Xr.edit||{},Xr.edit.SnapManager=Xr.Class({name:"SnapManager",construct:function(a){this._targets=new Array,this._editManager=a,this._bVertexSnapMode=!1,this._bEdgeSnapMode=!1},methods:{add:function(a){for(var b=this._targets.length,c=0;b>c;c++)if(this._targets[c]==a)return!1;return this._targets.push(a),!0},remove:function(a){for(var b=this._targets.length,c=0;b>c;c++)this._targets[c]==a&&this._targets.splice(c,1)},vertexSnapMode:function(a){return 1!=arguments.length?this._bVertexSnapMode:void(this._bVertexSnapMode=a)},edgeSnapMode:function(a){return 1!=arguments.length?this._bEdgeSnapMode:void(this._bEdgeSnapMode=a)},clear:function(){this._targets.length=0},vertexSnap:function(a,b){for(var c=this._targets.length,d=void 0,e=0;c>e&&!(d=this._targets[e].vertexSnap(a,b));e++);return d},edgeSnap:function(a,b){for(var c=this._targets.length,d=void 0,e=0;c>e&&!(d=this._targets[e].edgeSnap(a,b));e++);return d}}}),Xr.ui=Xr.ui||{},Xr.ui.IUserControl=Xr.Class({name:"IUserControl",methods:{container:function(){},name:function(){},update:function(){},prepare:function(){},release:function(){}}}),Xr.ui=Xr.ui||{},Xr.ui.UserControl=Xr.Class({name:"UserControl",construct:function(a,b){this._name=a,this._map=b,this._baseDiv=document.createElement("div"),this._baseDiv.style.position="absolute"},methods:{map:function(){return this._map},container:function(){return this._baseDiv},name:function(){return this._name}}}),Xr.ui=Xr.ui||{},Xr.ui.ScaleBarControl=Xr.Class({name:"ScaleBarControl",extend:Xr.ui.UserControl,requires:[Xr.ui.IUserControl,Xr.IMouseInteraction],construct:function(a,b){Xr.ui.UserControl.call(this,a,b),this._svg=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"svg"),this._svg.style.position="absolute",this._svg.style.setProperty("pointer-events","none"),this._fontSymbol=new Xr.symbol.FontSymbol,this._fontSymbol.size(18),this._fontSymbol.color("#ffffff"),this._fontSymbol.strokeColor("#000000"),this._fontSymbol.strokeWidth(2),this.container().appendChild(this._svg),this._scaleBarHeight=16,this._scaleBarWidth=120,this.container().style.bottom=20,this.container().style.left=20},methods:{fontSymbol:function(){return this._fontSymbol},scaleBarWidth:function(a){return 0==arguments.length?this._scaleBarWidth:void(this._scaleBarWidth=a)},scaleBarHeight:function(a){return 0==arguments.length?this._scaleBarHeight:void(this._scaleBarHeight=a)},_createLineSvg:function(a,b,c,d,e,f,g){var h=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"line");return h.setAttribute("x1",a),h.setAttribute("y1",b),h.setAttribute("x2",c),h.setAttribute("y2",d),h.setAttribute("stroke",e),h.setAttribute("stroke-width",f),h.setAttribute("stroke-linecap",g),h},update:function(){for(var a,b=this._svg,c=b.childNodes,d=c.length,e=0;d>e;e++)a=c[0],b.removeChild(a);var f=this._map.coordMapper(),g=2,h=this._scaleBarHeight/2;this._fontSymbol.size()>h&&(h+=this._fontSymbol.size()-h);
var i=this.scaleBarWidth(),j=this.scaleBarHeight()/2,k="1 : "+Math.ceil(f.mapScale()),l=Math.ceil(f.mapLength(i))+"m",m=this._createLineSvg(g,h,i+g,h,"#000000",3,"square"),n=this._createLineSvg(g,h-j,g,h+j,"#000000",3,"square"),o=this._createLineSvg(i+g,h-j,i+g,h+j,"#000000",3,"square"),p=this._createLineSvg(g,h,i+g,h,"#ffffff",1,"butt"),q=this._createLineSvg(g,h-j,g,h+j,"#ffffff",1,"butt"),r=this._createLineSvg(i+g,h-j,i+g,h+j,"#ffffff",1,"butt"),s=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"text");s.setAttribute("x",g+i+this._fontSymbol.size()/2),s.setAttribute("y",h+this._fontSymbol.size()/2-2),s.setAttribute("text-anchor","left"),this._fontSymbol.attributeForStroke(s),s.textContent=k;var t=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"text");t.setAttribute("x",g+i+this._fontSymbol.size()/2),t.setAttribute("y",h+this._fontSymbol.size()/2-2),t.setAttribute("text-anchor","left"),this._fontSymbol.attribute(t),t.textContent=k;var u=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"text");u.setAttribute("x",g+i/2),u.setAttribute("y",h-2),u.setAttribute("text-anchor","middle"),this._fontSymbol.attributeForStroke(u),u.textContent=l;var v=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"text");if(v.setAttribute("x",g+i/2),v.setAttribute("y",h-2),v.setAttribute("text-anchor","middle"),this._fontSymbol.attribute(v),v.textContent=l,b.appendChild(m),b.appendChild(n),b.appendChild(o),b.appendChild(p),b.appendChild(q),b.appendChild(r),b.appendChild(s),b.appendChild(t),b.appendChild(u),b.appendChild(v),!this.container().style.height||""===this.container().style.height){var w=b.getBBox();this.container().style.height=w.height,this.container().style.width=w.width+100}},prepare:function(){var a=this;a.__onMapScaleChanged=function(){a.update()},this._map.addEventListener(Xr.Events.MapScaleChanged,a.__onMapScaleChanged)},release:function(){this.__onMapScaleChanged&&(this._map.removeEventListener(Xr.Events.MapScaleChanged,this.__onMapScaleChanged),delete this.__onMapScaleChanged)},mouseDown:function(){},mouseMove:function(){},mouseUp:function(){},click:function(){},dblClick:function(){}}}),Xr.ui=Xr.ui||{},Xr.ui.IndexMapControl=Xr.Class({name:"IndexMapControl",extend:Xr.ui.UserControl,requires:[Xr.ui.IUserControl,Xr.IMouseInteraction],construct:function(a,b,c){Xr.ui.UserControl.call(this,a,b),this._indexMapUrl=c,this._indexMapDiv=document.createElement("div"),this._indexMapDiv.style.position="absolute",this._indexMapDiv.style.top="0px",this._indexMapDiv.style.left="0px",this._indexMapDiv.style.border="none",this._indexMapDiv.style.width="100%",this._indexMapDiv.style.height="100%",this._indexMapDiv.style.setProperty("pointer-events","none"),this.container().appendChild(this._indexMapDiv),this.container().style.bottom=20,this.container().style.right=20,this.container().style.width=250,this.container().style.height=250,this._indexMap=new Xr.Map(this._indexMapDiv,{}),this._indexMapDiv.style.backgroundImage="",this._markerDiv=this.createMarkerDiv(),this.container().appendChild(this._markerDiv),this._mouseDown=!1,this._mouseDownPt=new Xr.PointD,this._bReadyLayer=!1,this.__onContainerMouseDown=function(a){a.stopPropagation(),a.preventDefault()},this.container().addEventListener("mousedown",this.__onContainerMouseDown)},methods:{createMarkerDiv:function(){var a=document.createElement("div");a.style.position="absolute",a.style.top=0,a.style.left=0,a.style.width=10,a.style.height=10,a.style.opacity=.5;var b=this;return this.__onMarkerMouseDown=function(c){b._mouseDown||(c.stopPropagation(),a.setCapture&&a.setCapture(),b._mouseDownPt.set(c.clientX,c.clientY),b._mouseDown=!0)},this.__onMarkerMouseMove=function(c){if(c.stopPropagation(),b._mouseDown){var d=c.clientX-b._mouseDownPt.x,e=c.clientY-b._mouseDownPt.y;a.style.left=Xr.OperationHelper.valueFromPx(a.style.left)+d,a.style.top=Xr.OperationHelper.valueFromPx(a.style.top)+e,b._mouseDownPt.set(c.clientX,c.clientY)}},this.__onMarkerMouseUp=function(c){if(b._mouseDown){c.stopPropagation(),b._mouseDown=!1,a.releaseCapture&&a.releaseCapture();var d=Xr.OperationHelper.valueFromPx(a.style.left),e=Xr.OperationHelper.valueFromPx(a.style.top),f=Xr.OperationHelper.valueFromPx(a.style.width),g=Xr.OperationHelper.valueFromPx(a.style.height),h=d+f/2,i=e+g/2,j=b._indexMap.coordMapper(),k=j.V2W(h,i);b.map().coordMapper().moveTo(k.x,k.y),b.map().update()}},a.addEventListener("mousedown",this.__onMarkerMouseDown),a.addEventListener("mousemove",this.__onMarkerMouseMove),a.addEventListener("mouseup",this.__onMarkerMouseUp),a},update:function(){if(this._bReadyLayer){for(var a=this._markerDiv,b=this.map().coordMapper().viewportMBR(),c=this._indexMap.coordMapper(),d=new Xr.PointD(b.minX,b.maxY),e=new Xr.PointD(b.maxX,b.minY),f=c.W2V(d),g=c.W2V(e),h=g.x-f.x,i=g.y-f.y,j=a.childNodes,k=j.length,l=0;k>l;l++)a.removeChild(j[0]);if(4>h||4>i){a.style.left=f.x-5,a.style.top=f.y-5,a.style.width=h+10,a.style.height=i+10,a.style.border="1px solid gray",a.style.backgroundColor="#ffffff";var m=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"svg");m.style.position="absolute",m.style.top="0px",m.style.left="0px",m.style.overflow="visible",m.style.setProperty("pointer-events","none"),a.appendChild(m);var n=h/2+5,o=i/2+5,p=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"line");p.setAttribute("x1",n-20),p.setAttribute("y1",o),p.setAttribute("x2",n+20),p.setAttribute("y2",o),p.setAttribute("stroke","#ff0000"),p.setAttribute("stroke-width",1),m.appendChild(p);var q=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"line");q.setAttribute("x1",n),q.setAttribute("y1",o-20),q.setAttribute("x2",n),q.setAttribute("y2",o+20),q.setAttribute("stroke","#ff0000"),q.setAttribute("stroke-width",1),m.appendChild(q)}else a.style.left=f.x,a.style.top=f.y,a.style.width=h,a.style.height=i,a.style.border="1px solid black",a.style.backgroundColor="#ffff00"}},size:function(a,b){this.container().style.width=a,this.container().style.height=b},width:function(){var a=this.container().style.width,b=a.indexOf("px");return b>-1?(a=a.substring(0,b),parseInt(a)):-1},height:function(){var a=this.container().style.height,b=a.indexOf("px");return b>-1?(a=a.substring(0,b),parseInt(a)):-1},prepare:function(){var a=this;a.__onMapScaleChanged=function(){a.update()},a.__onMapViewChanged=function(){a.update()},this._map.addEventListener(Xr.Events.MapScaleChanged,a.__onMapScaleChanged),this._map.addEventListener(Xr.Events.MapViewChanged,a.__onMapViewChanged);var b=this._indexMap.layers();b.removeAll();var c=new Xr.layers.ShapeMapLayer("stroke",{url:this._indexMapUrl}),d=c.theme(),e=d.penSymbol(),f=d.brushSymbol();e.color("#ffffff"),e.width(7),f.color("#ffffff"),f.opacity(0),b.add(c);var g=new Xr.layers.ShapeMapLayer("layer",{url:this._indexMapUrl}),h=g.theme(),i=h.penSymbol(),j=h.brushSymbol();this._indexMap.resize(this._indexMapDiv.clientWidth,this._indexMapDiv.clientHeight),i.color("#777777"),i.width(2),j.color("#eeeeee"),j.opacity(1),b.add(g),this._indexMap.onLayersAllReady(function(){var b=g.MBR(),c=a._indexMap.coordMapper();c.zoomByMBR(b),c.mapScale(1.2*c.mapScale()),a._indexMap.update(),a._bReadyLayer=!0})},release:function(){this.__onMapScaleChanged&&(this._map.removeEventListener(Xr.Events.MapScaleChanged,this.__onMapScaleChanged),delete this.__onMapScaleChanged),this.__onMapViewChanged&&(this._map.removeEventListener(Xr.Events.MapViewChanged,this.__onMapViewChanged),delete this.__onMapViewChanged),this._markerDiv.__onMarkerMouseDown&&(this._markerG.addEventListener("mousedown",this._markerDiv.__onMarkerMouseDown),delete this._markerDiv.__onMarkerMouseDown),this._markerDiv.__onMarkerMouseMove&&(this._markerG.addEventListener("mousemove",this._markerDiv.__onMarkerMouseMove),delete this._markerDiv.__onMarkerMouseMove),this._markerDiv.__onMarkerMouseUp&&(this._markerG.addEventListener("mouseup",this._markerDiv.__onMarkerMouseUp),delete this._markerDiv.__onMarkerMouseUp),this.__onContainerMouseDown&&(this.container().addEventListener("mousedown",this.__onContainerMouseDown),delete this.__onContainerMouseDown)},mouseDown:function(){},mouseMove:function(){},mouseUp:function(){},click:function(){},dblClick:function(){}}}),Xr.ui=Xr.ui||{},Xr.ui.ZoomLevelControl=Xr.Class({name:"ZoomLevelControl",extend:Xr.ui.UserControl,requires:[Xr.ui.IUserControl,Xr.IMouseInteraction],construct:function(a,b,c){Xr.ui.UserControl.call(this,a,b),this._mapScales=c,this._svg=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"svg"),this._svg.style.position="absolute",this._svg.style.top="0px",this._svg.style.left="0px",this.container().appendChild(this._svg),this.container().style.right=24,this.container().style.top=24,this._mouseDown=!1,this._mouseDownPt=new Xr.PointD,this._thumbY=0,this._thumbWidth=28,this._thumbHeight=14,this._thumbDiv=this._createThumb(),this.container().appendChild(this._thumbDiv)},methods:{thumbWidth:function(a){return 0==arguments.length?this._thumbWidth:void(this._thumbWidth=a)},thumbHeight:function(a){return 0==arguments.length?this._thumbHeight:void(this._thumbHeight=a)},unitPerPixels:function(a){for(var b=this._map.coordMapper(),c=new Array,d=a.length,e=0;d>e;e++){var f=b.mapScaleFromMetersPerOnePixel(a[e]);c.push(f)}this._mapScales=c,this.update()},mapScales:function(a){return 0==a.length?this._mapScales:(this._mapScales=a,void this.update())},_isThumbInAvailableRange:function(a){return a>=0&&a<=10*(this._mapScales.length-1)},_getScaleLevelByMapScale:function(a){for(var b=Number.MAX_VALUE,c=-1,d=this._mapScales,e=d.length,f=0;e>f;f++){var g=d[f],h=Math.abs(a-g);b>h&&(b=h,c=f)}return c},scaleLevel:function(a){if(0==arguments.length)return this._getScaleLevel(this._thumbY);var b=this.scaleLevel();b!=a&&this._setScaleLevel(a,!0)},_getScaleLevel:function(a){return parseInt(Math.round(a/10))},_setScaleLevel:function(a,b){if(a>=0&&a<this._mapScales.length&&(this._thumbDiv&&(this._thumbY=10*a,this._thumbDiv.style.top=this._thumbY+(55-this.thumbHeight()/2)+"px"),b)){var c=this._map.coordMapper(),d=this._mapScales[a];c.zoomByMapScale(d),this._map.update()}},_getBarHeight:function(){var a=this._mapScales.length,b=10*(a-1)+50;return b},_createThumb:function(){var a=document.createElement("div");a.style.position="absolute",a.style.width="28px",a.style.height="14px";var b=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"svg");b.style.position="absolute",b.style.top="0px",b.style.left="0px",b.style.width="28px",b.style.height="14px",b.style.setProperty("pointer-events","none");var c=28,d=14,e=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"rect"),f=this;a.style.top=this._thumbY+(55-d/2)+"px",a.style.left=30-c/2+"px",f.__onThumbMouseDown=function(b){f._mouseDown||(b.stopPropagation(),a.setCapture&&a.setCapture(),f._mouseDownPt.set(b.clientX,b.clientY),f._mouseDown=!0)},f.__onThumbMouseMove=function(b){if(b.stopPropagation(),f._mouseDown){var c=f._thumbY+(b.clientY-f._mouseDownPt.y);f._isThumbInAvailableRange(c)&&(f._thumbY+=b.clientY-f._mouseDownPt.y,a.style.top=f._thumbY+(55-f.thumbHeight()/2)+"px")}f._mouseDownPt.y=b.clientY},f.__onThumbMouseUp=function(b){if(f._mouseDown){b.stopPropagation();var c=f._getScaleLevel(f._thumbY);f._setScaleLevel(c,!0),f._mouseDown=!1,a.releaseCapture&&a.releaseCapture()}},a.addEventListener("mousedown",f.__onThumbMouseDown,!1),a.addEventListener("mouseup",f.__onThumbMouseUp,!1),a.addEventListener("mousemove",f.__onThumbMouseMove,!1),e.setAttribute("x",0),e.setAttribute("y",0),e.setAttribute("rx",5),e.setAttribute("ry",5),e.setAttribute("width",c),e.setAttribute("height",d),e.setAttribute("fill","#efefef"),e.setAttribute("stroke","#aaaaaa"),e.setAttribute("stroke-width",2),b.appendChild(e);var g=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"line");g.setAttribute("x1",-6+c/2),g.setAttribute("y1",d/2),g.setAttribute("x2",6+c/2),g.setAttribute("y2",d/2),g.setAttribute("stroke","#ffffff"),g.setAttribute("stroke-width",1),b.appendChild(g);var h=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"line");h.setAttribute("x1",-6+c/2),h.setAttribute("y1",-1+d/2),h.setAttribute("x2",6+c/2),h.setAttribute("y2",-1+d/2),h.setAttribute("stroke","#aaaaaa"),h.setAttribute("stroke-width",1),b.appendChild(h);var i=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"line");return i.setAttribute("x1",-6+c/2),i.setAttribute("y1",1+d/2),i.setAttribute("x2",6+c/2),i.setAttribute("y2",1+d/2),i.setAttribute("stroke","#aaaaaa"),i.setAttribute("stroke-width",1),b.appendChild(i),a.appendChild(b),a},_createBar:function(){var a=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"g"),b=this._getBarHeight(),c=12,d=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"rect");d.setAttribute("x",30-c/2),d.setAttribute("y",30),d.setAttribute("width",c),d.setAttribute("height",b),d.setAttribute("fill","#efefef"),d.setAttribute("stroke","#bbbbbb"),d.setAttribute("stroke-width",2),a.appendChild(d);for(var e=this._mapScales.length,f=0;e>f;f++){var g=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"line");g.setAttribute("x1",27),g.setAttribute("y1",55+10*f),g.setAttribute("x2",33),g.setAttribute("y2",55+10*f),g.setAttribute("stroke","#ababab"),g.setAttribute("stroke-width",1),a.appendChild(g)}var h=this;return h.__onBarMouseDown=function(a){a.stopPropagation();var b=h._getScaleLevel(a.offsetY-50);b>=h._mapScales.length?b--:0>b&&(b=0),h._setScaleLevel(b,!0)},a.addEventListener("mousedown",h.__onBarMouseDown),a},_createZoomIn:function(){var a=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"g"),b=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"circle");b.setAttribute("cx",30),b.setAttribute("cy",30),b.setAttribute("r",15),b.setAttribute("fill","#efefef"),b.setAttribute("stroke","#bbbbbb"),b.setAttribute("stroke-width",2);var c=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"line");c.setAttribute("x1",30),c.setAttribute("y1",22),c.setAttribute("x2",30),c.setAttribute("y2",38),c.setAttribute("stroke","#ababab"),c.setAttribute("stroke-width",2);var d=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"line");d.setAttribute("x1",22),d.setAttribute("y1",30),d.setAttribute("x2",38),d.setAttribute("y2",30),d.setAttribute("stroke","#ababab"),d.setAttribute("stroke-width",2),a.appendChild(b),a.appendChild(c),a.appendChild(d);var e=this;return e.__onZoomInMouseDown=function(a){a.stopPropagation();var b=e._getScaleLevel(e._thumbY);e._setScaleLevel(--b,!0)},a.addEventListener("mousedown",e.__onZoomInMouseDown),a},_createZoomOut:function(a){var b=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"g"),c=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"circle");c.setAttribute("cx",30),c.setAttribute("cy",a),c.setAttribute("r",15),c.setAttribute("fill","#efefef"),c.setAttribute("stroke","#bbbbbb"),c.setAttribute("stroke-width",2);var d=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"line");d.setAttribute("x1",22),d.setAttribute("y1",a),d.setAttribute("x2",38),d.setAttribute("y2",a),d.setAttribute("stroke","#ababab"),d.setAttribute("stroke-width",2),b.appendChild(c),b.appendChild(d);var e=this;return e.__onZoomOutMouseDown=function(a){a.stopPropagation();var b=e._getScaleLevel(e._thumbY);e._setScaleLevel(++b,!0)},b.addEventListener("mousedown",e.__onZoomOutMouseDown),b},update:function(){for(var a,b=this._svg,c=b.childNodes,d=c.length,e=0;d>e;e++)a=c[0],b.removeChild(a);this._barG=this._createBar(),b.appendChild(this._barG),this._zoomInG=this._createZoomIn(),b.appendChild(this._zoomInG),this._zoomOutG=this._createZoomOut(this._getBarHeight()+30),b.appendChild(this._zoomOutG),this.container().style.height&&""!==this.container().style.height||(b.style.height=this.container().style.height=this._getBarHeight()+60,b.style.width=this.container().style.width=60)},prepare:function(){var a=this;a.__onMapScaleChanged=function(){var b=a._map,c=b.coordMapper(),d=c.mapScale(),e=a._getScaleLevelByMapScale(d);a._setScaleLevel(e)},this._map.addEventListener(Xr.Events.MapScaleChanged,a.__onMapScaleChanged)},release:function(){this.__onMapScaleChanged&&(this._map.removeEventListener(Xr.Events.MapScaleChanged,this.__onMapScaleChanged),delete this.__onMapScaleChanged),this.__onThumbMouseDown&&(this._thumbDiv.removeEventListener("mousedown",this.__onThumbMouseDown),delete this.__onThumbMouseDown),this.__onThumbMouseMove&&(this._thumbDiv.removeEventListener("mousemove",this.__onThumbMouseMove),delete this.__onThumbMouseMove),this.__onThumbMouseUp&&(this._thumbDiv.removeEventListener("mouseup",this.__onThumbMouseUp),delete this.__onThumbMouseUp),this.__onZoomInMouseDown&&(this._zoomInG.removeEventListener("mousedown",this.__onZoomInMouseDown),delete this.__onZoomInMouseDown),this.__onZoomInMouseDown&&(this._zoomOutG.removeEventListener("mousedown",this.__onZoomInMouseDown),delete this.__onZoomInMouseDown),this.__onBarMouseDown&&(this._zoomOutG.removeEventListener("click",this.__onBarMouseDown),delete this.__onBarMouseDown)},mouseDown:function(){},mouseMove:function(){},mouseUp:function(){},click:function(){},dblClick:function(){}}}),Xr.ui=Xr.ui||{},Xr.ui.InfoWindowControl=Xr.Class({name:"InfoWindowControl",extend:Xr.ui.UserControl,requires:[Xr.ui.IUserControl,Xr.IMouseInteraction],construct:function(a,b,c,d){Xr.ui.UserControl.call(this,a,b),this._innerHtml=d,this._position=c,this._skinSvg=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"svg"),this._skinSvg.style.position="absolute",this._skinSvg.style.top=0,this._skinSvg.style.left=0,this._skinSvg.style.overflow="visible",this._skinSvg.style.setProperty("pointer-events","none"),this.container().appendChild(this._skinSvg),this._infoDiv=document.createElement("div"),this._infoDiv.style.position="absolute",this._infoDiv.style.top=0,this._infoDiv.style.left=0,this._infoDiv.style.width=365,this._infoDiv.style.padding="17px",this._infoDiv.addEventListener("mousedown",function(a){a.stopPropagation()}),this._infoDiv.addEventListener("mousemove",function(a){a.stopPropagation()}),this._infoDiv.addEventListener("mouseup",function(a){a.stopPropagation()}),this._infoDiv.innerHTML=this._innerHtml,this.container().appendChild(this._infoDiv),this._closeBtnSvg=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"svg"),this._closeBtnSvg.style.position="absolute",this._closeBtnSvg.style.overflow="visible",this.container().appendChild(this._closeBtnSvg),this.container().style.visibility="hidden"},methods:{_createSkin:function(){var a=this._infoDiv.clientWidth,b=this._infoDiv.clientHeight,c=this._skinSvg,d=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"path"),e="M0 0 L"+a+" 0 L"+a+" "+b+" L"+(a/2+10)+" "+b+" L"+a/2+" "+(b+30)+" L"+(a/2-10)+" "+b+" L0 "+b+" Z";d.setAttribute("d",e),d.setAttribute("stroke","#454545"),d.setAttribute("stroke-width","1"),d.setAttribute("fill","#fefefe"),c.appendChild(d),this._closeBtnSvg.style.top=0,this._closeBtnSvg.style.left=0;var f=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"circle"),g=12,h=a-g-8,i=g+8;f.setAttribute("cx",h),f.setAttribute("cy",i),f.setAttribute("r",g),f.setAttribute("stroke","#989898"),f.setAttribute("stroke-width",3),f.setAttribute("fill","#efefef"),this._closeBtnSvg.appendChild(f);var j=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"line");j.setAttribute("x1",h-5),j.setAttribute("y1",i-5),j.setAttribute("x2",h+5),j.setAttribute("y2",i+5),j.setAttribute("stroke","#989898"),j.setAttribute("stroke-width",3),this._closeBtnSvg.appendChild(j);var k=document.createElementNS(Xr.CommonStrings.SVG_NAMESPACE,"line");k.setAttribute("x1",h+5),k.setAttribute("y1",i-5),k.setAttribute("x2",h-5),k.setAttribute("y2",i+5),k.setAttribute("stroke","#989898"),k.setAttribute("stroke-width",3),this._closeBtnSvg.appendChild(k);var l=this;this._closeBtnSvg.addEventListener("mousedown",function(a){a.stopPropagation()}),this._closeBtnSvg.addEventListener("click",function(a){a.stopPropagation(),l.map().userControls().remove(l.name())})},update:function(){var a=this._skinSvg.childNodes.length>0;a||this._createSkin();var b=this.map().coordMapper(),c=b.W2V(this._position),d=this._infoDiv.clientWidth,e=this._infoDiv.clientHeight,f=d/2,g=e+30,h=this.container();h.style.left=c.x-f,h.style.top=c.y-g,h.style.visibility="visible",h.style.animationDuration="0.6s",h.style.animationName="kf_tileMapShowing",this.container().style.height&&""!==this.container().style.height||(this.container().style.width=this._infoDiv.clientWidth,this.container().style.height=this._infoDiv.clientHeight+30)},prepare:function(){var a=this;a.__onMapScaleChanged=function(){a.update()},a.__onMapViewChanged=function(){a.update()},this._map.addEventListener(Xr.Events.MapScaleChanged,a.__onMapScaleChanged),this._map.addEventListener(Xr.Events.MapViewChanged,a.__onMapViewChanged)},release:function(){this.__onMapScaleChanged&&(this._map.removeEventListener(Xr.Events.MapScaleChanged,this.__onMapScaleChanged),delete this.__onMapScaleChanged),this.__onMapViewChanged&&(this._map.removeEventListener(Xr.Events.MapViewChanged,this.__onMapViewChanged),delete this.__onMapViewChanged)},mouseDown:function(){},mouseMove:function(a){if(Xr.UserState.mouseDown){var b=Xr.OperationHelper.offsetXY(a),c=b.x-Xr.UserState.mouseDownAndMovePt.x,d=b.y-Xr.UserState.mouseDownAndMovePt.y;this.container().style.left=Xr.OperationHelper.valueFromPx(this.container().style.left)+c,this.container().style.top=Xr.OperationHelper.valueFromPx(this.container().style.top)+d}},mouseUp:function(){},click:function(){},dblClick:function(){}}});