<meta http-equiv="content-type" content="application/xhtml+xml; charset=utf-8" />
<html>
<head title="FingerEyes-Xr">
	<style>
	    body
	    {
            margin:0px;
            padding:0px;
	    }

	    #mainLayout
	    {
			position:relative;
			width:100%;
			height:100%;
			border:none; 		
	    }

		#mapDiv {
            top:0px;
            left:0px;
			position:absolute;
			width:100%;
			height:100%;
			border:none; 		
            overflow:auto;
		}	

        #titleDiv {
            top:12px;
            left:12px;
            padding: 12px;
			position:absolute;
            background:rgba(0,0,0,0.7);
			border:none; 		
            overflow:auto;
            border-radius: 12px;
            font-size: 24px;
            color: #ffffff;
            font-family: "나눔명조OTF ExtraBold";
		}

	    table
	    {
            color: #ffffff;
	    }

        td {
            height: 25px;
            text-align: right;
        }

        #attributeDiv {
            top:100px;
            left:12px;
            padding: 12px;
			position:absolute;
            background:#000000;
			border:none; 		
            overflow:auto;
            font-size: 14px;
            border: 1px solid white;
            color: #ffffff;
            font-family: "나눔명조OTF ExtraBold";
            display: none;
		}
	</style>

	<script src="../js/Xr.js"></script>
    <script src="js/ModifyAttributeCommand.js"></script>
     
	<script type="text/javascript">
	    var map = null;

	    var EDIT_FUNCTION_COMMON = 0;
	    var EDIT_FUNCTION_SPLIT = 1;
	    var EDIT_FUNCTION_MERGE = 2;

	    var editFunction = EDIT_FUNCTION_COMMON;
	    var spotId = -1;

		function load() {
			map = new Xr.Map("mapDiv", {});

			var baseLyr = new Xr.layers.TileMapLayer("basemap", 
				{
				    proxy: "http://222.237.78.208:8080/Xr",
				    url: "http://222.237.78.208:8080/muan_tilemaps",
					ext: "jpg"
				}
			);

			var jibunLyr = new Xr.layers.ShapeMapLayer("jibun",
				{
				    url: "http://222.237.78.208:8080/Xr?layerName=BML_PARC_AS_FOR_EDIT"
				}
			);

			{
			    jibunLyr.visibility().visibleByScale(true);
			    jibunLyr.visibility().fromScale(0); // 포함
			    jibunLyr.visibility().toScale(1001); // 미포함

			    var theme = jibunLyr.theme();
			    var pen = theme.penSymbol();
			    var brush = theme.brushSymbol();

			    pen.color('#ffff00');
			    pen.width(2);

			    brush.color('#ff0000');
			    brush.opacity(0.0);

			    var label = jibunLyr.label();
			    label.visibility().visibleByScale(true);
			    label.visibility().fromScale(0); // 포함
			    label.visibility().toScale(2001); // 미포함
			    label.enable(true);
			    label.formatter().fieldName("par_lbl");

			    var labelTheme = label.theme();
			    labelTheme.symbol().strokeColor("#000000");
			    labelTheme.symbol().strokeWidth(2);

			    labelTheme.symbol().size(14);
			    labelTheme.symbol().fontFamily('나눔명조OTF ExtraBold');
			    labelTheme.symbol().color("#ff0000");
			}

			var lm = map.layers();

			lm.add(baseLyr);
			lm.add(jibunLyr);

			btnUndo.disabled = true;
			btnRedo.disabled = true;

			map.addEventListener(Xr.Events.UndoStateChanged, onUndoStateChanged);
			map.addEventListener(Xr.Events.RedoStateChanged, onRedoStateChanged);

			var graphicLyr = new Xr.layers.GraphicLayer("gl");

			map.edit().targetGraphicLayer(graphicLyr);
			map.edit().snap().add(jibunLyr);
			map.edit().snap().add(graphicLyr);
			map.edit().snap().vertexSnapMode(true);
			map.edit().snap().edgeSnapMode(true);

			lm.add(graphicLyr);

			var ctrl = new Xr.ui.ScaleBarControl("sbc", map);
			map.userControls().add(ctrl);

			var ctrl2 = new Xr.ui.ZoomLevelControl("zlc", map);
			ctrl2.mapScales([383.06022560915073, 766.1204512466478, 1915.3011281307926, 3830.6022556379635, 7661.204511956243, 19153.011279550446, 38305.7388117497, 76612.04511893881, 153224.09023821776]);
			map.userControls().add(ctrl2);

			var ctrl3 = new Xr.ui.IndexMapControl("imc", map, "http://222.237.78.208:8080/Xr?layerName=INDEXMAP");
			ctrl3.size(200, 270);
			map.userControls().add(ctrl3);

			map.onLayersAllReady(function () {
			    var mbr = jibunLyr.MBR();
			    var cm = map.coordMapper();
			    
			    cm.moveTo(151531, 246679);
			    cm.zoomByMapScale(766.1204512466478);

			    map.update();
			});

			map.addEventListener(Xr.Events.EditCompleted, onEditCompleted);
			map.addEventListener(Xr.Events.LayerUpdateCompleted, onLayerUpdateCompleted);

			map.addEventListener(Xr.Events.MapClick, function (e) {
			    if (map.userMode() == Xr.UserModeEnum.EDIT
                    && (editFunction == EDIT_FUNCTION_COMMON || editFunction == EDIT_FUNCTION_MERGE)) {
			        var fids = jibunLyr.IdByMousePoint(e.viewX, e.viewY, true);
			        var currentSketch = map.edit().currentSketch();
			        var oldId = -1;

			        if (currentSketch) {
			            oldId = currentSketch.id();
			            // 스케치 경계 조금 밖에서 정점 추가 시 문제가 발생하여 '|| e.ctrlKey' 를 추가함
			            if (currentSketch.hitTest(e.viewX, e.viewY, map.coordMapper()) || e.ctrlKey) return; 
			        }

			        if (fids.length > 0) {
			            var id = fids[0];

			            if (editFunction == EDIT_FUNCTION_MERGE) {
                            doMerge(currentSketch.id(), id);
			                return;
			            }

			            isNew = false;

			            if (currentSketch && (oldId != id) && map.edit().history().undoable()) {
			                var yes = confirm("편집된 내용이 있습니다. 편집 내용을 무시하고 진행 하시겠습니까?")
			                if (yes) {
			                    map.edit().history().reset();
			                } else {
			                    currentSketch.stay(true);
			                    return;
			                }
			            }
			            
			            if (!currentSketch || (currentSketch && (oldId != id))) {
			                selectShape(jibunLyr, graphicLyr, id);
			                editFunction = EDIT_FUNCTION_COMMON;

			                if (currentSketch) {
			                    currentSketch.stay(false);
			                }
			            } else {
			                if (currentSketch) {
			                    currentSketch.stay(true);
			                }
			            }
			        } else {
			            if (map.edit().history().undoable() && !e.ctrlKey && (currentSketch && !currentSketch.isNew())) {
			                var yes = confirm("편집된 내용이 있습니다. 편집 내용을 무시하고 진행 하시겠습니까?")
			                if (yes) {
			                    map.edit().history().reset();
			                } else {
			                    currentSketch.stay(true);
			                    return;
			                }
			            }

			            var bRemoveAll = !e.ctrlKey && (!currentSketch || (currentSketch && !currentSketch.isNew()));
			            if(bRemoveAll) {
			                map.edit().cancelSketch();
			                graphicLyr.reset();
			                graphicLyr.refresh();
			            }
			        }
			    }
			});
		}

		function onLayerUpdateCompleted(e) {
		    if (e.layerName == "gl") {
		        var gl = map.layers(e.layerName);
                //..
		    }
		}

		function doMerge(/* int */ targetId, /* int */ sourceId) {
		    var shpLyr = map.layers("jibun");

		    var target = shpLyr.shapeRowSet().row(targetId);
		    var source = shpLyr.shapeRowSet().row(sourceId);

		    spotId = sourceId;

		    var wktList = target.shapeData().toWKT(true) + "\n" + source.shapeData().toWKT(true);

		    var xhr = new XMLHttpRequest();
		    xhr.open('POST', 'http://www.geoservice.co.kr:8080/Gp?command=union', true);
		    //xhr.open('POST', 'http://localhost:8080/Gp?command=union', true);
		    xhr.responseType = 'text';
		    xhr.onreadystatechange = function (e) {
		        if (xhr.readyState == 4) {
		            if (xhr.status == 200) {
		                var gl = map.layers("gl");
		                var wkt = xhr.responseText;
                        
                        gl.rowSet().row(targetId).graphicData().fromWKT(wkt);

		                gl.refresh();
		                map.edit().setSketchById(targetId);
		            } else {
		                alert("Merge 실패(" + xhr.status + ") : " + wktList);
		            }
		        }
		    };

		    xhr.send(wktList);
		}

		function onEditCompleted(e) {
		    if (editFunction == EDIT_FUNCTION_SPLIT) {
		        if (e.editCommandType == Xr.edit.NewCommand.TYPE) {
		            map.edit().history().reset();

		            var gl = map.layers("gl");
		            var target = gl.rowSet().row(spotId-1);
		            var cutter = gl.rowSet().row(spotId);
    	            var wktList = target.graphicData().toWKT(true) + "\n" + cutter.graphicData().toWKT();

		            var xhr = new XMLHttpRequest();
		            xhr.open('POST', 'http://www.geoservice.co.kr:8080/Gp?command=split', true);
		            //xhr.open('POST', 'http://localhost:8080/Gp?command=split', true);
		            xhr.responseType = 'text';
		            xhr.onreadystatechange = function (e) {
		                if (xhr.readyState == 4) {
		                    if (xhr.status == 200) {
		                        var wkt = xhr.responseText;
		                        target.graphicData().fromWKT(wkt);
		                        gl.rowSet().remove(spotId);
		                        gl.refresh();
		                        map.edit().setSketchById(target.id());
		                    } else {
		                        alert("Split 실패(" + xhr.status + ") : " + wktList);
		                    }
		                }
		            };

		            xhr.send(wktList);
		        }
		    }
		}

		function selectShape(/* ShapeMapLayer */ shpLyr, /* GraphicLayer */ graphicLyr, /* int */ id) {
		    var row = shpLyr.shapeRowSet().row(id);
		    var shapeData = row.shapeData().clone();
		    var polygonGraphicRow = new Xr.data.PolygonGraphicRow(id, shapeData);

		    polygonGraphicRow.penSymbol().color('#00ffff');
		    polygonGraphicRow.penSymbol().width(3);
		    //polygonGraphicRow.penSymbol().dash("3 3");

		    polygonGraphicRow.brushSymbol().color('#00ffff');
		    polygonGraphicRow.brushSymbol().opacity(0.4);

		    graphicLyr.removeAll();
		    graphicLyr.rowSet().add(polygonGraphicRow);
		    graphicLyr.refresh();
		}

		function onView() {
            var graphicLyr = map.layers("gl");
		    graphicLyr.reset();
		    map.edit().history().reset();
		    map.userMode(Xr.UserModeEnum.VIEW);
		}

		function onEdit() {
		    map.layers("gl").reset();
		    map.edit().cancelSketch();
		    map.edit().history().reset();
		    map.userMode(Xr.UserModeEnum.EDIT);
		    editFunction = EDIT_FUNCTION_COMMON;
		}

		function toWKT(/* Array of PointD */ polygon) {
		    var result = "MULTIPOLYGON(((";

		    var cntPts = polygon.length;
		    for(var i=0; i<cntPts; i++) {
		        var pt = polygon[i];
		        result += pt.x + " " + pt.y;
		        if (i != (cntPts - 1)) result += ",";
		    }

		    return result + ")))";
		}

		function onCommit() {
		    if (map.userMode() == Xr.UserModeEnum.EDIT) {
		        var currentSketch = map.edit().currentSketch();

		        if (editFunction == EDIT_FUNCTION_COMMON && (!currentSketch || !map.edit().history().undoable())) {
		            alert("편집된 내용이 없습니다.");
		            return;
		        }

		        var id = currentSketch.id();
		        var graphicLyr = map.layers("gl");
		        if (graphicLyr) {
		            var sql = "";

		            var xhr = new XMLHttpRequest();
		            xhr.open('POST', 'http://222.237.78.208:8080/Xr?uptbl2|postgis', true);
		            xhr.responseType = 'text';
		            xhr.onreadystatechange = function (e) {
		                if (xhr.readyState == 4) {
		                    if (xhr.status == 200) {
		                        if (editFunction == EDIT_FUNCTION_SPLIT || editFunction == EDIT_FUNCTION_MERGE) {
		                            graphicLyr.reset();
		                            map.edit().cancelSketch();
		                        }

		                        editFunction = EDIT_FUNCTION_COMMON;

		                        var jibunLayer = map.layers("jibun");
		                        jibunLayer.reset();

		                        map.update();
		                        map.edit().history().reset();

		                        alert("편집 내용을 저장하였습니다.");
		                    } else {
		                        alert("편집 내용 저장 실패: " + sql);
		                    }
		                }
		            };

		            var row = graphicLyr.rowSet().row(id);
		            var data = row.graphicData();
		            
		            if (editFunction == EDIT_FUNCTION_SPLIT) {
		                var polygons = data.data();
		                var cntPolygons = polygons.length;
		                for (var iPart = 0; iPart < cntPolygons; ++iPart) {
		                    var polygon = polygons[iPart];
		                    var wkt = toWKT(polygon);
		                    
		                    if (iPart == 0) {
		                        sql += "UPDATE public.\"BML_PARC_AS_FOR_EDIT\" " +
                                    "SET the_geom = ST_GeomFromText('" + wkt + "')" +
                                    " WHERE fid = " + id;
		                    } else {
		                        sql += "INSERT INTO public.\"BML_PARC_AS_FOR_EDIT\" (" +
                                    "the_geom, fid) VALUES (" +
                                    "ST_GeomFromText('" + wkt + "')" +
                                    ", currval('\"BML_PARC_AS_FOR_EDIT_gid_seq\"'::regclass)-1" +
                                    ")";
		                    }
		                    
		                    if (iPart != (cntPolygons - 1)) {
		                        sql += "\n";
		                    }
		                }
		            } else if (editFunction == EDIT_FUNCTION_COMMON) {
		                sql += "UPDATE public.\"BML_PARC_AS_FOR_EDIT\" " +
                                "SET the_geom = ST_GeomFromText('" + data.toWKT(true) + "')" +
                                " WHERE fid = " + id;
		            } else if (editFunction == EDIT_FUNCTION_MERGE) {
		                sql += "UPDATE public.\"BML_PARC_AS_FOR_EDIT\" " +
                            "SET the_geom = ST_GeomFromText('" + data.toWKT(true) + "')" +
                            " WHERE fid = " + id;

		                sql += "\n";

		                sql += "DELETE FROM public.\"BML_PARC_AS_FOR_EDIT\" WHERE fid = " + spotId;
		            }

		            xhr.send(sql);
		        }
		    } else {
		        alert("편집 모드가 아닙니다.");
		    }
		}

		function onUndo() {
		    map.edit().history().undo();
		}

		function onRedo() {
		    map.edit().history().redo();
		}

		function onUndoStateChanged(e) {
		    btnUndo.disabled = e.disabled;
		}

		function onRedoStateChanged(e) {
		    btnRedo.disabled = e.disabled;
		}

		function onSplit() {
		    if (map.edit().history().undoable()) {
		        var yes = confirm("편집된 내용이 있습니다. 편집 내용을 무시하고 진행 하시겠습니까?")
		        if (!yes) return;
		    }

		    if (map.userMode() == Xr.UserModeEnum.EDIT) {
		        var sketch = map.edit().currentSketch();
		        if (sketch) {
		            var id = sketch.id();
		            spotId = id + 1;
		            if (map.edit().newPolyline(spotId)) {
		                editFunction = EDIT_FUNCTION_SPLIT;
		            } else {
		                alert("자르기(Split)에 사용할 폴리라인을 그릴 수 없는 상태입니다.");
		            }

		        } else {
		            alert("먼저 자르기(Split) 할 지적 필지를 선택하세요.");
		        }
		    } else {
		        alert("편집 모드가 아닙니다.");
		    }
		}

		function onMerge() {
		    if (map.edit().history().undoable()) {
		        var yes = confirm("편집된 내용이 있습니다. 편집 내용을 무시하고 진행 하시겠습니까?")
		        if (!yes) return;
		    }

		    if (map.userMode() == Xr.UserModeEnum.EDIT) {
		        var sketch = map.edit().currentSketch();
		        if (sketch) {
                    editFunction = EDIT_FUNCTION_MERGE;
		        } else {
		            alert("먼저 병합(Merge) 할 지적 필지를 선택하세요.");
		        }
		    } else {
		        alert("편집 모드가 아닙니다.");
		    }
		}
	</script>
</head>

<body onload="load()">
    <div id="mainLayout">
        <div id="mapDiv"></div>
        <div id="titleDiv">
            FingerEyes-Xr for HTML5 : <font color="#349bd6">Advanced Edit ShapeMapLayer</font>
            <br />
            <input type="button" value="맵뷰 모드" onclick="onView();">
            <input type="button" value="편집 모드" onclick="onEdit();">
            <input type="button" value="자르기(Split)" onclick="onSplit();" />
            <input type="button" value="병합하기(Merge)" onclick="onMerge();" />
            <input type="button" value="Undo" onclick="onUndo();" id="btnUndo" />
            <input type="button" value="Redo" onclick="onRedo();" id="btnRedo" />
            <input type="button" value="커밋(Commit)" onclick="onCommit();" />
        </div>
    </div>
</body>
</html>