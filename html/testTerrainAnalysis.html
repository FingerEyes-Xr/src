<meta http-equiv="content-type" content="application/xhtml+xml; charset=utf-8" />
<html>
<head title="FingerEyes-Xr">
    
    <style>

        .area {
            fill: #854800;
            stroke: none;
            shape-rendering: crispEdges;
        }

        .pie {
            stroke: none;
            
        }

        .axis path, .axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }

        .total {
            font-size: 13pt;
            font-family: "맑은 고딕";
            text-anchor: middle;
            fill: #393939;
        }

        text {
            text-rendering: geometricPrecision;
        }

        .pieNum {
            font-size: 8pt;
            font-family: "맑은 고딕";
            text-anchor: middle;
            fill: #393939;
        }

        .axis text {
            font-weight: bold;
            fill: #494949;
            font-family: arial;
            font-size: 10px;
        }

        body {
            margin: 0px;
            padding: 0px;
        }

        #mainLayout {
            position: relative;
            width: 100%;
            height: 100%;
            border: none;
        }

        #mapDiv {
            top: 0px;
            left: 0px;
            position: relative;
            width: 100%;
            height: 100%;
            border: none;
            overflow: auto;
        }

        #title {
            top: 12px;
            left: 12px;
            padding: 12px;
            position: absolute;
            background: rgba(0,0,0,0.7);
            border: none;
            overflow: auto;
            border-radius: 12px;
            font-size: 24px;
            color: #ffffff;
            font-family: "Arial";
        }
    </style>

    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script src="//code.jquery.com/ui/1.11.3/jquery-ui.js"></script>
    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <!--<script src="//www.geoservice.co.kr/z/Xr.min.1.0.js"></script>-->
    <script src="../js/Xr.js"></script>

    <script type="text/javascript">
	    var map = null;
	    var lineId = 0;
	    function load() {
	        $("button").button().click(function (event) {
                event.preventDefault();
            });

	        map = new Xr.Map("mapDiv", {});

	        var lyr = new Xr.layers.TileMapLayer("basemap",
				{
				    proxy: "http://222.237.78.208:8080/Xr",
				    url: "http://222.237.78.208:8080/yp_tiles/a",
				    ext: "jpg"
				}
			);

	        var graphicLyr = new Xr.layers.GraphicLayer("gl");

	        var lm = map.layers();
	        lm.add(lyr);
	        lm.add(graphicLyr);
	        map.edit().targetGraphicLayer(graphicLyr);

	        var ctrl = new Xr.ui.ScaleBarControl("sbc", map);
	        map.userControls().add(ctrl);

	        var ctrl2 = new Xr.ui.ZoomLevelControl("zlc", map);
	        ctrl2.mapScales([ 250, 500, 1000, 2500, 5000, 10000, 25000, 50000, 100000 ]);
	        map.userControls().add(ctrl2);

	        map.onLayersAllReady(function () {
	            var cm = map.coordMapper();
	            var mbr = lyr.MBR();
	            cm.zoomByMBR(mbr);
	            cm.zoomByMapScale(2500);

	            map.update();
	        });

	        map.addEventListener(Xr.Events.EditCompleted, onEditCompleted);
	    }

	    function onEditCompleted(e) {
	        if (e.editCommandType == Xr.edit.NewCommand.TYPE) {
	            map.userControls().enableMouse(true);

	            map.edit().history().reset();

	            var gl = map.layers("gl");
	            var row = gl.rowSet().row(lineId++);
	            var wkt = row.graphicData().toWKT(true);
	            var graphicData = row.graphicData();
	            var pt = graphicData.representativePoint();

	            map.userMode(Xr.UserModeEnum.VIEW);

	            if (wkt.indexOf("LINESTRING") != -1) {
	                doCrossSectionAnalysis(pt, wkt);
	            } else {
	                doAverageSlopeAnalysis(pt, wkt);
	            }
	        }
	    }

	    function doCrossSectionAnalysis(pt, wkt) {
	        var oReq = new XMLHttpRequest();
	        var url = "http://222.237.78.208:8080/Gp?command=crosssection;dem=dem;geometry=" + encodeURI(wkt);
	        
	        oReq.open("GET", url, true);
	        oReq.responseType = "arraybuffer";

	        oReq.onload = function (oEvent) {
	            var arrayBuffer = oReq.response;
	            if (arrayBuffer) {
	                var dataview = new DataView(arrayBuffer);
	                
	                var values = [];
	                var cntValues = arrayBuffer.byteLength / 4;
	                for (var i = 0; i < cntValues; i++) {
	                    var value = dataview.getFloat32(i * 4, true);
	                    values.push(value);
	                }

    	            var resolution = 1.0;
	                drawCrossSection(pt, values, resolution);
        	    }
	        }

	        oReq.send(null);
	    }

	    function doAverageSlopeAnalysis(pt, wkt) {
	        var oReq = new XMLHttpRequest();
	        var url = "http://222.237.78.208:8080/Gp?command=slope;dem=dem;geometry=" + encodeURI(wkt);

	        oReq.open("GET", url, true);
	        oReq.responseType = "text";

	        oReq.onreadystatechange = function (evt) {
	            if (oReq.readyState == 4) {
	                if (oReq.status == 200) {
	                    var txt = oReq.responseText;

	                    var average = txt.substring(txt.indexOf("<average>") + "<average>".length, txt.indexOf("</average>"));
	                    var nextIdx = 0;
	                    var dataset = [];
	                    var totalValue = 0;
	                    while (true) {
	                        var sIdx = txt.indexOf("<step description=\"", nextIdx);

	                        if (sIdx == -1) break;
	                        sIdx += "<step description=\"".length;

	                        var eIdx = txt.indexOf("\">", sIdx);
	                        var desc = txt.substring(sIdx, eIdx);

	                        eIdx += "\">".length;
	                        var eIdx2 = txt.indexOf("</step>", eIdx);
	                        var value = parseFloat(txt.substring(eIdx, eIdx2));

	                        totalValue += value;
	                        nextIdx = eIdx;

	                        dataset.push({ desc: desc, value: value });
	                    }

	                    var dataset2 = [];

	                    var v = (dataset[0].value + dataset[1].value) / totalValue * 100;
	                    dataset2.push({ desc: "15° 미만", value: v });

	                    v = (dataset[2].value + dataset[3].value) / totalValue * 100;
	                    dataset2.push({ desc: "15°~25°", value: v });

	                    v = (dataset[6].value + dataset[7].value + dataset[4].value + dataset[5].value) / totalValue * 100;
	                    dataset2.push({ desc: "25° 이상", value: v });

	                    drawAverageSlope(pt, dataset2, average);
	                } else {
	                    alert("Error in doAverageSlopeAnalysis");
	                }
	            }
	        }

	        oReq.send(null);
	    }

	    function drawAverageSlope(pt, dataset, average) {
	        var infoWin = new Xr.ui.InfoWindowControl("iwc-" + (lineId - 1), map, pt, "");
	        var div = infoWin.infoDiv();
	        var svgWidth = 170;
	        var svgHeight = 150;
	        var outR = svgHeight / 2;
	        var inR = svgHeight / 6;

	        var svg = d3.select(div)
                .append("svg")
                .attr("class", "mySVG")
                .attr("width", svgWidth)
                .attr("height", svgHeight);

	        var pie = d3.layout.pie()
                .value(function (d) { return d.value; });

	        var arc = d3.svg.arc()
                .innerRadius(inR)
                .outerRadius(inR);

	        var arc2 = d3.svg.arc()
                .innerRadius(inR)
                .outerRadius(outR);

	        var clrs = [ "#D7D7D7", "#ABABAB", "#966400" ];

	        var pieEles = svg
                .selectAll("g")
                .data(pie(dataset))
                .enter();
                //.append("g")
                

	        pieEles.append("path")
                .attr("class", "pie")
                .attr("transform", "translate(" + (svgWidth/2) + "," + (svgHeight/2) + ")")
                .attr("fill", function (d, i) { return clrs[i]; })
                .attr("d", arc)
                .transition()
                .attr("d", arc2)
                .duration(1000)
                .each("end", function () {
                    pieEles.append("text")
                        .attr("class", "pieNum")
                        .text(function (d, i) {
                            var v = parseInt(d.value);
                            if (v == 0) return "";
                            else return d.data.desc + "(" + v + "%)";
                        })
                        .attr("transform", function (d, i) {
                            var cen = arc.centroid(d);
                            var tran = "translate(" + (svgWidth / 2 + cen[0]) + "," + (svgHeight / 2 + cen[1]) + ")";
                            return tran;
                        })
                        .attr("opacity", 0)
                        .transition()
                        .duration(1000)
                        .attr("opacity", 1)
                        .attr("transform", function (d, i) {
                            var cen = arc2.centroid(d);
                            var tran = "translate(" + (svgWidth / 2 + cen[0]) + "," + (svgHeight / 2 + cen[1]) + ")";
                            return tran;
                        });

                    svg.append("text")
                        .attr("class", "total")
                        .attr("transform", "translate(" + svgWidth / 2 + "," + (svgHeight / 2 + 6) + ")")
                        .text("평균경사 " + Math.round(average) + "°")
                        .attr("opacity", 0)
                        .transition()
                        .duration(1000)
                        .delay(1000)
                        .attr("transform", "translate(" + svgWidth / 2 + "," + (svgHeight - 2) + ")")
                        .attr("opacity", 1);
                });

	        infoWin.addEventListener(Xr.Events.InfoWindowClosed, function (e) {
	            var id = e.name.substring(4);
	            var gl = map.layers("gl");
	            gl.remove(id);
	        });

	        map.userControls().add(infoWin);
	    }

	    function drawCrossSection(pt, values, resolution) {
	        var resolution = 1.0;
	        var cntValues = values.length;
	        var length = 0.0;
	        var dataset = [];

	        for (var i = 0; i < cntValues; ++i) {
	            var value = values[i];
	            if (value != -9999.0 && value != -99999.0) {
	                length += resolution;
	                dataset.push(value);
	            }
	        }

	        var infoWin = new Xr.ui.InfoWindowControl("iwc-" + (lineId-1), map, pt, "");
	        var div = infoWin.infoDiv();
	        var heightGap = (d3.max(dataset) - d3.min(dataset));
	        var ratio = heightGap / length;
	        var svgWidth = 250;
	        var svgHeight = svgWidth * ratio;
	        var padding = 24;
	        var svg = d3.select(div)
                .append("svg")
                .attr("class", "mySVG")
                .attr("width", svgWidth)
                .style("padding", padding)
                .attr("height", svgHeight);

	        var xScale = d3.scale.linear()
                .domain([0, length])
                .range([0, svgWidth]);

	        var yScale = d3.scale.linear()
                .domain([d3.min(dataset), d3.max(dataset)])
                .range([svgHeight, 0]);

	        var margin = length / dataset.length;
	        var areaA = d3.svg.area()
                .x(function (d, i) { return xScale(i * margin); })
                .y0(function (d, i) { return svgHeight; })
                .y1(function (d, i) { return svgHeight; })
                .interpolate("basis");

	        var areaB = d3.svg.area()
                .x(function (d, i) { return xScale(i * margin); })
                .y0(function (d, i) { return svgHeight; })
                .y1(function (d, i) { return yScale(d); })
                .interpolate("basis");

	        svg.append("path")
                .attr("class", "area")
                .attr("d", areaA(dataset))
                .transition()
                .duration(1000)
                .attr("d", areaB(dataset))

	        var xAxis = d3.svg.axis()
                .scale(xScale)
                .orient("bottom")
                .ticks(5)
                .tickSize(2);

	        svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(0," + (svgHeight) + ")")
                .call(xAxis);

	        var yAxis = d3.svg.axis()
                .scale(yScale)
                .orient("left")
                .ticks(3)//heightGap / 12)
                .tickSize(2);

	        svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(" + (0) + "," + (0) + ")")
                .call(yAxis);

	        infoWin.addEventListener(Xr.Events.InfoWindowClosed, function (e) {
	            var id = e.name.substring(4);
	            var gl = map.layers("gl");
	            gl.remove(id);

	        });

	        map.userControls().add(infoWin);
	    }

	    function onAverageSlope() {
	        map.userMode(Xr.UserModeEnum.EDIT);
	        var gl = map.layers("gl");
	        //gl.reset();

	        if (!map.edit().newPolygon(lineId)) {
	            alert("Not Edit Mode ");
	        } else {
	            map.userControls().enableMouse(false);
	        }
	    }

	    function onCrossSection() {
	        map.userMode(Xr.UserModeEnum.EDIT);
	        var gl = map.layers("gl");
	        //gl.reset();

	        if (!map.edit().newPolyline(lineId)) {
	            alert("Not Edit Mode ");
	        } else {
	            map.userControls().enableMouse(false);
	        }
	    }
    </script>
</head>

<body onload="load()">
    <div id="mainLayout">
        <div id="mapDiv"></div>
        <div id="title">
            FingerEyes-Xr for HTML5 : <font color="#349bd6">Terrain Analysis</font>
            <br />
            <input type="button" value="단면도 분석" onclick="onCrossSection();">
            <input type="button" value="평균경사 분석" onclick="onAverageSlope();">
        </div>
    </div>
</body>
</html>